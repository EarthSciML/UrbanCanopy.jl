var documenterSearchIndex = {"docs":
[{"location":"api/#API-Reference","page":"API","title":"API Reference","text":"","category":"section"},{"location":"api/#UrbanCanopy.AdjustedLayerThickness-Tuple{}","page":"API","title":"UrbanCanopy.AdjustedLayerThickness","text":"AdjustedLayerThickness(; name=:AdjustedLayerThickness)\n\nComputes the adjusted top layer thickness for pervious and impervious road surfaces, following Eq. 4.30 of Oleson et al. (2010).\n\nThe adjustment uses a tunable parameter c_a = 0.34 to compensate for the difference between layer-averaged and surface temperature in the numerical scheme.\n\nReference: Oleson et al. (2010), Chapter 4, Eq. 4.30, pp. 98.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.AquiferWaterBalance-Tuple{}","page":"API","title":"UrbanCanopy.AquiferWaterBalance","text":"AquiferWaterBalance(; name=:AquiferWaterBalance)\n\nComputes the update of aquifer water storage, following Section 5.4 of Oleson et al. (2010).\n\nFor the case when the water table is below the soil column, the aquifer water W_a (kg/m²) is updated from the balance of recharge and drainage (Eq. 5.143). Since 1 mm water = 1 kg/m², we use kg/m² for storage and kg/(m²·s) for rates, which ensures unit consistency.\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.4, Eqs. 5.142–5.147, pp. 142–144.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.BuildingTemperature-Tuple{}","page":"API","title":"UrbanCanopy.BuildingTemperature","text":"BuildingTemperature(; name=:BuildingTemperature)\n\nComputes the internal building temperature from a weighted combination of inner layer wall and roof temperatures, following Eqs. 4.37–4.38 of Oleson et al. (2010).\n\nThe building temperature T{iB} is constrained between prescribed minimum and maximum values (T{iB,min} and T_{iB,max}).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.37–4.38, pp. 99.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.CLMUAtmosphere-Tuple{}","page":"API","title":"UrbanCanopy.CLMUAtmosphere","text":"CLMUAtmosphere(; name=:CLMUAtmosphere)\n\nAtmospheric interface for the Community Land Model Urban (CLMU) parameterization. Computes atmospheric density, vapor pressure, and reference height from atmospheric forcing variables, following Chapter 1 of Oleson et al. (2010).\n\nThe CLMU represents the urban surface using a canyon concept (Oke, 1987) consisting of a canyon floor of width W bordered by two facing buildings of height H. The urban canyon is divided into five columns: roof, sunlit wall, shaded wall, pervious road, and impervious road. This component defines the atmospheric forcing interface and the diagnostic equations that connect atmospheric model variables to the urban canopy model.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.ExponentialGrid-Tuple{}","page":"API","title":"UrbanCanopy.ExponentialGrid","text":"ExponentialGrid(; name=:ExponentialGrid, N=15)\n\nComputes the exponential grid discretization for pervious and impervious road columns, following Eq. 4.8 and Eqs. 4.6–4.7 of Oleson et al. (2010). The scaling factor f_s = 0.025 produces finer resolution near the surface, which is needed because roads overlie real soil.\n\nLayer thicknesses and interface depths are computed from Eqs. 4.6 and 4.7.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, Eqs. 4.6–4.8, pp. 91–92.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.FreezingPointDepression-Tuple{}","page":"API","title":"UrbanCanopy.FreezingPointDepression","text":"FreezingPointDepression(; name=:FreezingPointDepression)\n\nComputes the maximum liquid water content in a soil layer when the temperature is below the freezing point, following Eq. 4.58 of Oleson et al. (2010).\n\nThe concept of supercooled soil water from Niu and Yang (2006) is used, where liquid water coexists with ice below freezing through a freezing point depression equation.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.2, Eq. 4.58, pp. 103.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.GroundwaterDrainage-Tuple{}","page":"API","title":"UrbanCanopy.GroundwaterDrainage","text":"GroundwaterDrainage(; name=:GroundwaterDrainage)\n\nComputes sub-surface drainage for the pervious road based on the SIMTOP scheme, following Section 5.4 of Oleson et al. (2010).\n\nDrainage is computed as an exponential function of water table depth (Eq. 5.140), modified by a frozen soil impermeable fraction (Eq. 5.141). Drainage is restricted in frozen soils where ice content exceeds liquid water content (Eq. 5.139).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.4, Eqs. 5.138–5.141, pp. 141–142.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.HeatFlux-Tuple{}","page":"API","title":"UrbanCanopy.HeatFlux","text":"HeatFlux(; name=:HeatFlux)\n\nComputes the heat flux from layer i to layer i+1 using Fourier's law discretized across the interface (Eq. 4.11) from Section 4.1 of Oleson et al. (2010).\n\nThe flux is defined as positive upwards: Fi = -λ[z{h,i}] * (Ti - T{i+1}) / (z{i+1} - zi).\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, Eq. 4.11, pp. 94.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.HeatMomentumFluxes-Tuple{}","page":"API","title":"UrbanCanopy.HeatMomentumFluxes","text":"HeatMomentumFluxes(; name=:HeatMomentumFluxes)\n\nUrban heat and momentum fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 3 of Oleson et al. (2010).\n\nComputes the Monin-Obukhov similarity theory parameters, roughness length and displacement height, wind speed in the urban canyon, aerodynamic and surface resistances, sensible and latent heat fluxes for the five urban surfaces (roof, sunlit wall, shaded wall, pervious road, impervious road), total momentum fluxes, and the UCL air temperature and specific humidity.\n\nThe Monin-Obukhov stability parameter ζ is taken as an input parameter, since in the original CLM implementation it is computed through an iterative procedure (Section 3.2.3). Given ζ, the system computes all stability corrections, friction velocity, aerodynamic resistances, and surface fluxes as a directed algebraic system without circular dependencies.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 3: Heat and Momentum Fluxes (pp. 61-89).\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.HeatingCoolingFlux-Tuple{}","page":"API","title":"UrbanCanopy.HeatingCoolingFlux","text":"HeatingCoolingFlux(; name=:HeatingCoolingFlux)\n\nComputes the heating and cooling fluxes applied to roofs, sunlit walls, and shaded walls, following Eqs. 4.51–4.54 of Oleson et al. (2010).\n\nHeating is applied when the internal building temperature T_iB falls below the prescribed minimum T_{iB,min}. Cooling is applied when T_iB exceeds the prescribed maximum T_{iB,max}.\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.51–4.54, pp. 101.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.ImperviousRunoff-Tuple{}","page":"API","title":"UrbanCanopy.ImperviousRunoff","text":"ImperviousRunoff(; name=:ImperviousRunoff)\n\nComputes surface runoff for roof and impervious road surfaces, following Eqs. 5.47–5.48 of Oleson et al. (2010).\n\nThese surfaces have limited water storage capacity. When no snow layers are present (snl = 0), runoff equals the excess water above the ponding limit wpondmax = 1 kg/m². When snow layers exist (snl < 0), all liquid water reaching the surface becomes runoff.\n\nAfter runoff, the surface liquid water content is updated:\n\nIf runoff occurs: wliq1 is set to the ponding limit (Eq. 5.48, case 1)\nIf no runoff: wliq1 is updated with net input (Eq. 5.48, case 2)\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.2, Eqs. 5.47–5.48, pp. 124–125.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.ImperviousWaterBalance-Tuple{}","page":"API","title":"UrbanCanopy.ImperviousWaterBalance","text":"ImperviousWaterBalance(; name=:ImperviousWaterBalance)\n\nDescribes the water balance for the roof and impervious road surfaces, following Eqs. 5.2–5.3 of Oleson et al. (2010).\n\nThese surfaces have limited water storage capacity (1 kg/m² ponding limit), no sub-surface drainage, and intercept both liquid and solid precipitation.\n\nReference: Oleson et al. (2010), Chapter 5, Eqs. 5.2–5.5, pp. 112.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.InterfaceHydraulicConductivity-Tuple{}","page":"API","title":"UrbanCanopy.InterfaceHydraulicConductivity","text":"InterfaceHydraulicConductivity(; name=:InterfaceHydraulicConductivity)\n\nComputes the hydraulic conductivity at the interface between two soil layers, following Eq. 5.69 of Oleson et al. (2010).\n\nThe interface conductivity accounts for averaging of water content and porosity between adjacent layers, Clapp-Hornberger power-law dependence on saturation, and reduction due to frozen soil (impermeable fraction).\n\nFor interfaces between two layers (i = 1, ..., Nlevsoi - 1):   k[zh,i] = (1 - (ffrz,i + ffrz,i+1)/2) * ksat[zh,i] *              [0.5(θi + θ{i+1}) / (0.5(θsat,i + θsat,i+1))]^(2B_i+3)\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.1, Eq. 5.69, p. 131.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.InterfaceThermalConductivity-Tuple{}","page":"API","title":"UrbanCanopy.InterfaceThermalConductivity","text":"InterfaceThermalConductivity(; name=:InterfaceThermalConductivity)\n\nComputes the thermal conductivity at the interface between two adjacent layers using the harmonic mean formula (Eq. 4.12) from Section 4.1 of Oleson et al. (2010).\n\nThe interface conductivity is derived from continuity of heat flux at the interface (Eq. 4.13), resulting in a weighted harmonic mean of the two adjacent layer conductivities.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, Eq. 4.12, pp. 94.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.LayerPhaseChangeEnergy-Tuple{}","page":"API","title":"UrbanCanopy.LayerPhaseChangeEnergy","text":"LayerPhaseChangeEnergy(; name=:LayerPhaseChangeEnergy)\n\nComputes the phase change energy for a single layer, following Eq. 4.73 of Oleson et al. (2010). This is used to sum contributions across all layers to obtain the total phase change energy (Eq. 4.72).\n\nReference: Oleson et al. (2010), Chapter 4, Eq. 4.73, pp. 106.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.OfflineModeForcing-Tuple{}","page":"API","title":"UrbanCanopy.OfflineModeForcing","text":"OfflineModeForcing(; name=:OfflineModeForcing)\n\nOffline mode atmospheric forcing processor for the Community Land Model Urban (CLMU). Computes derived atmospheric forcing variables from raw observational data for use in uncoupled (offline) simulations, following Chapter 6 of Oleson et al. (2010).\n\nThis component takes total incident solar radiation, cosine of solar zenith angle, atmospheric temperature, pressure, specific humidity, wind speed, and precipitation rate as inputs and computes:\n\nSolar radiation partitioned into direct/diffuse and visible/near-infrared components (Eqs. 6.2-6.8)\nAtmospheric downwelling longwave radiation from the Idso (1981) formula (Eqs. 6.9-6.10)\nRain and snow precipitation rates from temperature-dependent partitioning (Eqs. 6.11-6.13)\nWind components, potential temperature, and reference height (p.149)\n\nNote: Equation 6.1 describes temporal downscaling of 6-hourly solar radiation to model time steps using cosine of solar zenith angle weighting. This discrete-time algorithm is a data preprocessing step and is not implemented here; instead, S_atm is taken as the already-interpolated total solar radiation at the model time step.\n\nNote: Equations 6.14-6.15 describe alternative methods for computing specific humidity from relative humidity or dew point temperature. These are optional data preprocessing steps and are not implemented in this component.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.PerviousRoadWaterBalance-Tuple{}","page":"API","title":"UrbanCanopy.PerviousRoadWaterBalance","text":"PerviousRoadWaterBalance(; name=:PerviousRoadWaterBalance)\n\nDescribes the overall water balance equation for the pervious road column, following Eq. 5.1 of Oleson et al. (2010).\n\nThe pervious road has a full soil column with infiltration, surface runoff, sub-surface drainage, redistribution within the soil, and groundwater interactions.\n\nReference: Oleson et al. (2010), Chapter 5, Eq. 5.1, p. 110.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.PhaseChangeAdjustment-Tuple{}","page":"API","title":"UrbanCanopy.PhaseChangeAdjustment","text":"PhaseChangeAdjustment(; name=:PhaseChangeAdjustment)\n\nPerforms the ice/liquid water mass adjustment and temperature correction after phase change, following Eqs. 4.60–4.65 of Oleson et al. (2010).\n\nGiven the excess/deficit energy H_i from Eq. 4.59, this component computes the melt/freeze amount H_m, adjusts ice mass, conserves liquid water, computes residual energy H_{i*}, and corrects the temperature.\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.60–4.65, pp. 103–104.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.PhaseChangeEnergy-Tuple{}","page":"API","title":"UrbanCanopy.PhaseChangeEnergy","text":"PhaseChangeEnergy(; name=:PhaseChangeEnergy)\n\nComputes the energy excess or deficit for phase change assessment in a layer, following Eq. 4.59 of Oleson et al. (2010).\n\nFor the top layer (i = snl+1), the energy includes the surface heat flux and its derivative. For interior layers (i > snl+1), only the heat fluxes and thermal storage are included.\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.59–4.65, pp. 103–104.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.RichardsEquation-Tuple{}","page":"API","title":"UrbanCanopy.RichardsEquation","text":"RichardsEquation(; name=:RichardsEquation, N_layers=10, Δz_total=2.0, pct_sand=50.0, pct_clay=20.0, θ_top_val=0.2, θ_bottom_val=0.2, θ_init_val=0.2)\n\nImplements Richards' equation (Eq. 5.59) for vertical soil water movement using MethodOfLines.jl for automatic spatial discretization.\n\nThe governing PDE is (Eq. 5.68), written in diffusivity form:     ∂θ/∂t = ∂/∂z [D(θ) ∂θ/∂z] + ∂K(θ)/∂z\n\nwhere D(θ) = K(θ)|dψ/dθ| is the soil water diffusivity combining the Clapp-Hornberger hydraulic conductivity (Eq. 5.69) and matric potential (Eq. 5.73), and ∂K/∂z is the gravity drainage term. Here z is positive downward (depth into soil).\n\nSoil hydraulic properties follow Clapp and Hornberger (1978):\n\nK(θ) = ksat · (θ/θsat)^(2B+3)   (Eq. 5.69)\nψ(θ) = ψsat · (θ/θsat)^(-B)      (Eq. 5.73)\n\nThe diffusivity simplifies to:     D(θ) = ksat · B · |ψsat| / θsat · (θ/θsat)^(B+2)\n\nBoundary conditions:\n\nTop (z=0): Dirichlet BC θ = θ_top (surface water content)\nBottom (z=Δztotal): Dirichlet BC θ = θbottom (deep soil water content)\n\nReturns a named tuple (; prob, θ, t_pde, z_var, k_sat_val, θ_sat_val, B_val, ψ_sat_val) containing the discretized ODE problem and symbolic variables.\n\nNote: This function does not use @component because MethodOfLines.jl's discretize() returns an ODEProblem rather than a ModelingToolkit System. The PDE discretization paradigm requires working directly with the generated ODE problem.\n\nReference: Oleson et al. (2010), Chapter 5, Eqs. 5.59, 5.68–5.74, pp. 127–138.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.RoadHeatConduction-Tuple{}","page":"API","title":"UrbanCanopy.RoadHeatConduction","text":"RoadHeatConduction(; name=:RoadHeatConduction)\n\nImplements the 1D heat conduction equation (Eq. 4.4) for pervious and impervious road surfaces using MethodOfLines.jl for automatic spatial discretization.\n\nFor roads, the domain uses exponential spacing (Eq. 4.8) with the total depth determined by the scaling factor f_s = 0.025 m. The boundary conditions are:\n\nTop (z=0): Neumann BC with surface heat flux h (Eq. 4.26)\nBottom (z=z_max): Zero heat flux (Neumann BC, ∂T/∂z = 0)\n\nThe thermal conductivity and heat capacity can vary with depth (e.g., impervious layers vs soil layers).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.1–4.4, 4.8, pp. 90–92.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.RoofWallHeatConduction-Tuple{}","page":"API","title":"UrbanCanopy.RoofWallHeatConduction","text":"RoofWallHeatConduction(; name=:RoofWallHeatConduction)\n\nImplements the 1D heat conduction equation (Eq. 4.4) for roof and wall surfaces using MethodOfLines.jl for automatic spatial discretization.\n\nThe governing PDE is:     c ∂T/∂t = ∂/∂z [λ ∂T/∂z]\n\nFor roofs and walls, the domain is a uniform grid of total thickness Δz_total (Eq. 4.5). The boundary conditions are:\n\nTop (z=0): Neumann BC with surface heat flux h (Eq. 4.26)\nBottom (z=Δztotal): Dirichlet BC with building temperature TiB (Eq. 4.37)\n\nThe thermal conductivity λ and volumetric heat capacity c are prescribed parameters for each layer (from Table 1.3).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.1–4.4, pp. 90–91.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowCappingRunoff-Tuple{}","page":"API","title":"UrbanCanopy.SnowCappingRunoff","text":"SnowCappingRunoff(; name=:SnowCappingRunoff)\n\nComputes runoff from snow-capping when the snow water equivalent exceeds 1000 kg/m², following Section 5.5 of Oleson et al. (2010).\n\nFor snow-capped surfaces, precipitation and dew are routed to solid and liquid runoff terms (Eqs. 5.153–5.154).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.5, Eqs. 5.153–5.154, p. 146.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowCompaction-Tuple{}","page":"API","title":"UrbanCanopy.SnowCompaction","text":"SnowCompaction(; name=:SnowCompaction)\n\nComputes the total fractional compaction rate of snow layers, following Section 5.1.4 of Oleson et al. (2010).\n\nSnow compaction includes three processes:\n\nDestructive metamorphism (Eq. 5.26) - temperature dependent crystal breakdown\nOverburden pressure (Eq. 5.28) - compression from weight of overlying snow\nMelt-induced compaction (Eq. 5.31) - changes due to melt-freeze cycles\n\nCompaction is not allowed if the layer is saturated (Eq. 5.25) or if ice content is below a minimum value (w_ice,i ≤ 0.1 kg/m²).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.1.4, Eqs. 5.24–5.33, pp. 118–120.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowDensity-Tuple{}","page":"API","title":"UrbanCanopy.SnowDensity","text":"SnowDensity(; name=:SnowDensity)\n\nComputes the bulk density of newly fallen snow as a function of atmospheric temperature, following Anderson (1976) as parameterized in Eq. 5.10 of Oleson et al. (2010).\n\nThe density depends on the atmospheric temperature relative to freezing:\n\nWhen Tatm > Tf + 2 K: ρ_sno = 50 + 1.7(17)^1.5\nWhen Tf - 15 < Tatm ≤ Tf + 2: ρsno = 50 + 1.7(Tatm - Tf + 15)^1.5\nWhen Tatm ≤ Tf - 15: ρ_sno = 50\n\nReference: Oleson et al. (2010), Chapter 5, Eq. 5.10, p. 115.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowIceContent-Tuple{}","page":"API","title":"UrbanCanopy.SnowIceContent","text":"SnowIceContent(; name=:SnowIceContent)\n\nComputes the conservation of ice mass in snow layers and new snowfall accumulation, following Section 5.1.1 of Oleson et al. (2010).\n\nThis component handles:\n\nNew snow depth rate from solid precipitation and snow density (derived from Eq. 5.9)\nTop layer ice content update from precipitation and frost/sublimation (Eqs. 5.12, 5.14)\n\nThe paper's Eq. 5.9 is Δzsno = qgrnd,ice·Δt / ρsno, which is a per-timestep increment. For continuous modeling we express this as a rate: dzsno/dt = qgrnd,ice / ρsno [m/s].\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.1.1, Eqs. 5.6–5.14, pp. 114–115.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowLayerCombination-Tuple{}","page":"API","title":"UrbanCanopy.SnowLayerCombination","text":"SnowLayerCombination(; name=:SnowLayerCombination)\n\nComputes the combined properties when two snow layers are merged, following Section 5.1.5.1 of Oleson et al. (2010).\n\nWhen two snow layers are combined, their thicknesses, water contents, and temperatures are merged according to conservation principles (Eqs. 5.38–5.42).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.1.5.1, Eqs. 5.38–5.42, pp. 122.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowLayerGeometry-Tuple{}","page":"API","title":"UrbanCanopy.SnowLayerGeometry","text":"SnowLayerGeometry(; name=:SnowLayerGeometry)\n\nComputes the snow layer structure for a given snow depth, following Section 4.1 of Oleson et al. (2010). The snow pack has up to 5 layers, with thickness assignments depending on the total snow depth z_sno (pp. 92–93).\n\nThis component takes the total snow depth and number of snow layers as inputs and computes the layer thicknesses, node depths, and interface depths (Eqs. 4.9–4.10).\n\nNote: The actual number of snow layers (snl) is determined by the snow depth according to the rules on pp. 92–93. This component computes geometry for a single snow layer (the simplest case), since multi-layer snow packing logic is procedural and typically handled outside the equation system.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, pp. 92–93.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowMeltNoLayers-Tuple{}","page":"API","title":"UrbanCanopy.SnowMeltNoLayers","text":"SnowMeltNoLayers(; name=:SnowMeltNoLayers)\n\nHandles the special case of snow melt when snow is present (W_sno > 0) but there are no explicit snow layers (snl = 0), following Eqs. 4.66–4.71 of Oleson et al. (2010).\n\nWhen the snow mass is too small for explicit snow layers, snow melt is computed from the excess energy in the top soil layer. Snow mass and depth are reduced proportionally.\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.66–4.71, pp. 105.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowSoilBlendedHeatCapacity-Tuple{}","page":"API","title":"UrbanCanopy.SnowSoilBlendedHeatCapacity","text":"SnowSoilBlendedHeatCapacity(; name=:SnowSoilBlendedHeatCapacity)\n\nComputes the blended heat capacity of the top soil layer when snow is present but there are no explicit snow layers (snl = 0), following Eq. 4.88 of Oleson et al. (2010).\n\nThe heat capacity is the soil heat capacity (from Eq. 4.85) plus an additional term from the snow mass distributed over the top layer.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.3, Eq. 4.88, pp. 109.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowThermalProperties-Tuple{}","page":"API","title":"UrbanCanopy.SnowThermalProperties","text":"SnowThermalProperties(; name=:SnowThermalProperties)\n\nComputes the thermal conductivity and volumetric heat capacity for snow layers, following Section 4.3 of Oleson et al. (2010).\n\nThermal conductivity follows Jordan (1991) (Eq. 4.83). Volumetric heat capacity depends on the ice and liquid water content (Eq. 4.87).\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.3, pp. 108–109.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SnowWaterContent-Tuple{}","page":"API","title":"UrbanCanopy.SnowWaterContent","text":"SnowWaterContent(; name=:SnowWaterContent)\n\nComputes the flow of liquid water through snow layers, following Section 5.1.2 of Oleson et al. (2010).\n\nThe water flow between layers (Eq. 5.18) depends on the volumetric water and ice contents, with an irreducible water saturation S_r = 0.033 representing capillary retention. The flow is limited by the effective porosity of the underlying layer (Eq. 5.21).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.1.2, Eqs. 5.15–5.22, pp. 116–117.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SoilHydraulicProperties-Tuple{}","page":"API","title":"UrbanCanopy.SoilHydraulicProperties","text":"SoilHydraulicProperties(; name=:SoilHydraulicProperties)\n\nComputes the hydraulic properties of soil layers for the pervious road, following Section 5.3.1 of Oleson et al. (2010).\n\nProperties computed based on Clapp and Hornberger (1978) and Cosby et al. (1984):\n\nSaturated hydraulic conductivity k_sat (Eq. 5.70)\nPorosity θ_sat (Eq. 5.71)\nClapp-Hornberger exponent B (Eq. 5.72)\nSoil matric potential ψ (Eq. 5.73)\nSaturated soil matric potential ψ_sat (Eq. 5.74)\n\nUrban soils are assumed to have no organic matter, so simplified forms are used. All values converted to SI units (m, m/s) from the paper's mm units.\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.1, Eqs. 5.69–5.74, pp. 131.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SoilThermalProperties-Tuple{}","page":"API","title":"UrbanCanopy.SoilThermalProperties","text":"SoilThermalProperties(; name=:SoilThermalProperties)\n\nComputes the thermal conductivity and volumetric heat capacity for soil layers used in pervious road columns, following Section 4.3 of Oleson et al. (2010).\n\nThermal conductivity follows Farouki (1981) using the Kersten number method (Eqs. 4.77–4.82). Volumetric heat capacity follows de Vries (1963) (Eqs. 4.85–4.86).\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.3, pp. 107–108.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SoilWaterContentCalc-Tuple{}","page":"API","title":"UrbanCanopy.SoilWaterContentCalc","text":"SoilWaterContentCalc(; name=:SoilWaterContentCalc)\n\nComputes the total volumetric soil water content from liquid water and ice masses, following Eq. 5.137 of Oleson et al. (2010).\n\nThe total volumetric water content combines both liquid and ice phases:   θi = wliq,i / (Δzi * ρliq) + wice,i / (Δzi * ρ_ice)\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.2, Eq. 5.137, p. 141.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SoilWaterEquilibrium-Tuple{}","page":"API","title":"UrbanCanopy.SoilWaterEquilibrium","text":"SoilWaterEquilibrium(; name=:SoilWaterEquilibrium)\n\nComputes the equilibrium soil matric potential and volumetric water content following Section 5.3.2.1 of Oleson et al. (2010).\n\nThe equilibrium state represents the hydrostatic distribution of soil moisture above the water table (Eqs. 5.98–5.106).\n\nAll lengths in SI units (m).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.2.1, Eqs. 5.98–5.106, pp. 136–138.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SoilWaterFlux-Tuple{}","page":"API","title":"UrbanCanopy.SoilWaterFlux","text":"SoilWaterFlux(; name=:SoilWaterFlux)\n\nComputes the soil water flux between two adjacent soil layers using the modified Darcy's law following Zeng and Decker (2009), as described in Section 5.3.2 of Oleson et al. (2010).\n\nThe flux is computed as Eq. 5.67:   q = -k[zh] * [(ψi - ψ{i+1}) + (ψ{E,i+1} - ψ{E,i})] / (z{i+1} - z_i)\n\nAll lengths and hydraulic properties in SI units (m, m/s).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.2, Eqs. 5.87–5.88, p. 135.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SurfaceEnergyFlux-Tuple{}","page":"API","title":"UrbanCanopy.SurfaceEnergyFlux","text":"SurfaceEnergyFlux(; name=:SurfaceEnergyFlux)\n\nComputes the net heat flux into each urban surface and its derivative with respect to surface temperature, following Eqs. 4.26, 4.28, and 4.29 of Oleson et al. (2010).\n\nThe surface heat flux h is the sum of absorbed solar radiation, net longwave radiation, sensible and latent heat fluxes, and waste heat / air conditioning terms. The derivative ∂h/∂T is used in the linearized Crank-Nicholson scheme (Eq. 4.19).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.26–4.29, pp. 97–98.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SurfaceLayerUpdate-Tuple{}","page":"API","title":"UrbanCanopy.SurfaceLayerUpdate","text":"SurfaceLayerUpdate(; name=:SurfaceLayerUpdate)\n\nComputes surface layer ice and liquid water content updates from dew, frost, and sublimation, following Section 5.4 of Oleson et al. (2010).\n\nThese updates apply to the top layer of all surfaces (roof, pervious road, impervious road).\n\nReference: Oleson et al. (2010), Chapter 5, Eqs. 5.150–5.152, p. 146.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.SurfaceRunoffInfiltration-Tuple{}","page":"API","title":"UrbanCanopy.SurfaceRunoffInfiltration","text":"SurfaceRunoffInfiltration(; name=:SurfaceRunoffInfiltration)\n\nComputes surface runoff and infiltration for the pervious road, following Section 5.2 of Oleson et al. (2010).\n\nImplements the SIMTOP-based (Niu et al., 2005) runoff model (Eq. 5.49), fractional saturated area (Eq. 5.50), impermeable fraction from frozen soil (Eq. 5.51), and maximum infiltration capacity (Eq. 5.52).\n\nAll hydraulic properties are in SI units (m, m/s). The conversion between kg/(m²·s) water flux and m/s uses ρliq: 1 kg/(m²·s) = 1/ρliq m/s.\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.2, Eqs. 5.47–5.58, pp. 124–128.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.TotalPhaseChangeEnergy-Tuple{}","page":"API","title":"UrbanCanopy.TotalPhaseChangeEnergy","text":"TotalPhaseChangeEnergy(; name=:TotalPhaseChangeEnergy)\n\nComputes the total phase change energy for the column, following Eq. 4.72 of Oleson et al. (2010). The total is the sum of the surface snow melt energy (Eq. 4.71) and the per-layer phase change energies (Eq. 4.73).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.72–4.73, pp. 105–106.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.UniformGrid-Tuple{}","page":"API","title":"UrbanCanopy.UniformGrid","text":"UniformGrid(; name=:UniformGrid, N=15)\n\nComputes the uniform grid discretization for roofs and walls, following Eqs. 4.5–4.7 of Oleson et al. (2010). Roofs and walls are discretized into N layers of equal thickness, with node depths at layer midpoints and interface depths between layers.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, Eqs. 4.5–4.7, pp. 91.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.UrbanRadiation-Tuple{}","page":"API","title":"UrbanCanopy.UrbanRadiation","text":"UrbanRadiation(; name=:UrbanRadiation)\n\nUrban albedos and radiative fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 2 of Oleson et al. (2010).\n\nComputes the view factors, incident direct beam and diffuse solar radiation, absorbed and reflected solar radiation (with closed-form multi-reflection solution for the urban canyon), incident longwave radiation, and absorbed/reflected/emitted longwave radiation for urban surfaces: roof, sunlit wall, shaded wall, and road.\n\nThe urban canyon is represented as an infinitely long canyon of width W bordered by buildings of height H. Radiation interactions within the canyon account for multiple reflections between walls and road using view factors. The iterative multi-reflection scheme (Eqs. 2.63-2.85, 2.138-2.170) is solved in closed form using the matrix geometric series: S_absorbed = (I - A) * (I - T*A)^{-1} * S_0, where A is the albedo matrix, T is the view-factor transport matrix, and S_0 is the initial incident radiation vector.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 2: Albedos and Radiative Fluxes (pp. 26-60).\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.UrbanSurfaceThermalProperties-Tuple{}","page":"API","title":"UrbanCanopy.UrbanSurfaceThermalProperties","text":"UrbanSurfaceThermalProperties(; name=:UrbanSurfaceThermalProperties)\n\nRepresents the prescribed thermal conductivity and heat capacity for roof, wall, and impervious road layers, following Section 4.3 of Oleson et al. (2010).\n\nFor roofs, walls, and impervious road layers (i = 1, ..., N_imprvrd), the thermal conductivity and heat capacity are specified by the surface dataset (Table 1.3). This component takes those prescribed values as parameters.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.3, pp. 106.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.WasteHeatAirConditioning-Tuple{}","page":"API","title":"UrbanCanopy.WasteHeatAirConditioning","text":"WasteHeatAirConditioning(; name=:WasteHeatAirConditioning)\n\nComputes waste heat from space heating/air conditioning and heat removed by air conditioning, following Eqs. 4.55–4.56 of Oleson et al. (2010).\n\nWaste heat is distributed to the pervious and impervious road surfaces. Air conditioning heat removal equals the cooling flux (Eq. 4.56).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.51–4.56, pp. 101–102.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.WasteHeatAllocation-Tuple{}","page":"API","title":"UrbanCanopy.WasteHeatAllocation","text":"WasteHeatAllocation(; name=:WasteHeatAllocation)\n\nAllocates total waste heat and air conditioning heat to individual urban surfaces, following Eq. 4.27 of Oleson et al. (2010).\n\nWaste heat and air conditioning are applied ONLY to the pervious and impervious road surfaces (divided by 1 - W_roof). Walls and roof receive zero waste heat and zero air conditioning.\n\nReference: Oleson et al. (2010), Chapter 4, Eq. 4.27, pp. 97.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.WaterTableDepth-Tuple{}","page":"API","title":"UrbanCanopy.WaterTableDepth","text":"WaterTableDepth(; name=:WaterTableDepth)\n\nComputes the water table depth from aquifer water storage, following Section 5.4 of Oleson et al. (2010).\n\nWhen the water table is below the soil column, the depth is computed from the aquifer water storage (Eq. 5.146). Water table depth is constrained to 0.05 ≤ z_v ≤ 80 m.\n\nAquifer water Wa is in kg/m² (equivalent to mm of water column height). Conversion: Wa [kg/m²] / ρ_liq [kg/m³] gives meters of water.\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.4, Eq. 5.146, p. 143.\n\n\n\n\n\n","category":"method"},{"location":"heat_momentum_fluxes/#Heat-and-Momentum-Fluxes","page":"Heat and Momentum Fluxes","title":"Heat and Momentum Fluxes","text":"","category":"section"},{"location":"heat_momentum_fluxes/#Overview","page":"Heat and Momentum Fluxes","title":"Overview","text":"Chapter 3 of the CLMU technical note describes the computation of heat and momentum fluxes for urban surfaces using Monin-Obukhov similarity theory. These fluxes drive the surface energy balance and determine the exchange of energy and momentum between the urban surface and the atmospheric boundary layer.\n\nThe HeatMomentumFluxes component computes:\n\nRoughness length and displacement height from canyon geometry using the MacDonald et al. (1998) formulation (Eqs. 3.55-3.58)\nStability correction functions psi_m and psi_h for four regimes: very unstable (zeta  -1574), unstable (-1574 leq zeta  0), stable (0 leq zeta leq 1), and very stable (zeta  1) (Eqs. 3.31-3.46)\nConvective velocity U_c for unstable conditions using the convective velocity scale w_* (Eqs. 3.25, 3.29-3.30)\nFriction velocity u_* and aerodynamic resistances r_am, r_ah, r_aw (Eqs. 3.26, 3.65-3.67)\nCanyon wind speed for three flow regimes: isolated (HW  05), wake interference (05 leq HW  1), and skimming (HW geq 1) (Eqs. 3.59-3.62)\nSurface resistance for heat and moisture exchange (Eq. 3.68)\nUCL air temperature and humidity as conductance-weighted averages (Eqs. 3.75, 3.93)\nSensible heat fluxes for all five surfaces (roof, pervious road, impervious road, sunlit wall, shaded wall) and the area-weighted total (Eqs. 3.69-3.74)\nWater vapor fluxes for roof, pervious road, and impervious road (walls have zero evaporation) (Eqs. 3.76-3.81)\nMomentum fluxes tau_x and tau_y (Eqs. 3.6-3.7)\nPartial derivatives partial H  partial T_g for all five surfaces,  needed for the implicit soil temperature calculation (Eqs. 3.95-3.99)\n\nThe Monin-Obukhov stability parameter zeta is taken as an input parameter, since in the original CLM implementation it is computed through an iterative procedure (Section 3.2.3). This avoids an algebraic loop and allows the system to be solved as a directed algebraic system.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 3: Heat and Momentum Fluxes (pp. 61-89).","category":"section"},{"location":"heat_momentum_fluxes/#Implementation","page":"Heat and Momentum Fluxes","title":"Implementation","text":"The HeatMomentumFluxes component implements the heat and momentum flux parameterization with 48 equations and 48 unknowns.","category":"section"},{"location":"heat_momentum_fluxes/#State-Variables","page":"Heat and Momentum Fluxes","title":"State Variables","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing UrbanCanopy\n\nsys = HeatMomentumFluxes()\n\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"heat_momentum_fluxes/#Parameters","page":"Heat and Momentum Fluxes","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"heat_momentum_fluxes/#Equations","page":"Heat and Momentum Fluxes","title":"Equations","text":"eqs = equations(sys)","category":"section"},{"location":"heat_momentum_fluxes/#Analysis","page":"Heat and Momentum Fluxes","title":"Analysis","text":"The following figures explore the behavior of the heat and momentum flux system across different canyon geometries and atmospheric stability conditions.\n\nusing OrdinaryDiffEqDefault\nusing Plots\n\ncompiled = mtkcompile(sys)\n\nfunction solve_hmf(compiled, params)\n    prob = ODEProblem(compiled, params, (0.0, 1.0))\n    solve(prob)\nend\n\nfunction base_hmf_params(compiled; H_W=1.0, ζ_in=0.1)\n    Dict(\n        compiled.H_W => H_W,\n        compiled.H_canyon => 10.0,\n        compiled.W_roof => 0.25,\n        compiled.f_prvrd => 0.5,\n        compiled.H_w_est => 5.0,\n        compiled.u_atm => 3.0,\n        compiled.v_atm => 2.0,\n        compiled.θ_atm => 300.0,\n        compiled.q_atm => 0.01,\n        compiled.ρ_atm => 1.2,\n        compiled.z_atm_m => 30.0,\n        compiled.z_atm_h => 30.0,\n        compiled.z_atm_w => 30.0,\n        compiled.T_g_roof => 310.0,\n        compiled.T_g_prvrd => 305.0,\n        compiled.T_g_imprvrd => 308.0,\n        compiled.T_g_sunwall => 312.0,\n        compiled.T_g_shdwall => 303.0,\n        compiled.q_g_roof => 0.015,\n        compiled.q_g_prvrd => 0.012,\n        compiled.q_g_imprvrd => 0.014,\n        compiled.f_wet_roof => 0.0,\n        compiled.f_wet_imprvrd => 0.0,\n        compiled.ζ_in => ζ_in,\n    )\nend\nnothing # hide","category":"section"},{"location":"heat_momentum_fluxes/#Roughness-Parameters-vs-Canyon-H/W-Ratio","page":"Heat and Momentum Fluxes","title":"Roughness Parameters vs Canyon H/W Ratio","text":"Displacement height d and roughness length z_0m as functions of the canyon height-to-width ratio, computed using the MacDonald et al. (1998) formulation (Eqs. 3.55-3.57). The displacement height approaches the building height for deep canyons, while the roughness length peaks at intermediate H/W and decreases for very deep canyons.\n\nhw_range = 0.1:0.05:5.0\nd_vals = Float64[]\nz0m_vals = Float64[]\n\nfor hw in hw_range\n    p = base_hmf_params(compiled; H_W=hw)\n    sol = solve_hmf(compiled, p)\n    push!(d_vals, sol[compiled.d_canopy][end])\n    push!(z0m_vals, sol[compiled.z_0m_canopy][end])\nend\n\np1 = plot(hw_range, d_vals, label=\"d (displacement height)\",\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"Height (m)\",\n    title=\"Roughness Parameters vs H/W (Eqs. 3.55-3.57)\",\n    linewidth=2, legend=:topleft)\nplot!(p1, hw_range, z0m_vals, label=\"z₀ₘ (roughness length)\", linewidth=2)\nhline!(p1, [10.0], label=\"H_canyon = 10 m\", linestyle=:dash, color=:gray)\np1","category":"section"},{"location":"heat_momentum_fluxes/#Stability-Corrections-and-Friction-Velocity","page":"Heat and Momentum Fluxes","title":"Stability Corrections and Friction Velocity","text":"The stability correction functions psi_m and psi_h modify the log-law wind and temperature profiles. Positive psi (unstable conditions) enhances turbulent transfer; negative psi (stable conditions) suppresses it. The friction velocity responds accordingly, being higher in unstable conditions when turbulent mixing is enhanced.\n\nζ_range = -3.0:0.05:3.0\nψ_m_vals = Float64[]\nψ_h_vals = Float64[]\nustar_vals = Float64[]\n\nfor ζ in ζ_range\n    if abs(ζ) < 0.001\n        ζ = sign(ζ) == -1 ? -0.001 : 0.001\n    end\n    p = base_hmf_params(compiled; ζ_in=ζ)\n    sol = solve_hmf(compiled, p)\n    push!(ψ_m_vals, sol[compiled.ψ_m_atm][end])\n    push!(ψ_h_vals, sol[compiled.ψ_h_atm][end])\n    push!(ustar_vals, sol[compiled.u_star][end])\nend\n\np1 = plot(ζ_range, ψ_m_vals, label=\"ψ_m\", linewidth=2,\n    xlabel=\"ζ = (z-d)/L\", ylabel=\"ψ\",\n    title=\"Stability Corrections (Eqs. 3.31-3.46)\",\n    legend=:topright)\nplot!(p1, ζ_range, ψ_h_vals, label=\"ψ_h\", linewidth=2)\nvline!(p1, [0.0], linestyle=:dash, color=:gray, label=\"Neutral\")\nvline!(p1, [-1.574], linestyle=:dot, color=:red, label=\"ζ_m transition\")\nvline!(p1, [-0.465], linestyle=:dot, color=:blue, label=\"ζ_h transition\")\n\np2 = plot(ζ_range, ustar_vals, label=\"u*\", linewidth=2, color=:green,\n    xlabel=\"ζ = (z-d)/L\", ylabel=\"u* (m/s)\",\n    title=\"Friction Velocity vs Stability\",\n    legend=:topright)\nvline!(p2, [0.0], linestyle=:dash, color=:gray, label=\"Neutral\")\n\np = plot(p1, p2, layout=(2, 1), size=(700, 700))\np","category":"section"},{"location":"heat_momentum_fluxes/#Canyon-Wind-Speed-and-Flow-Regimes","page":"Heat and Momentum Fluxes","title":"Canyon Wind Speed and Flow Regimes","text":"The canyon wind speed exhibits three flow regimes depending on the canyon height-to-width ratio: isolated roughness flow for HW  05, wake interference for 05 leq HW  1, and skimming flow for HW geq 1 (Eqs. 3.60-3.62). Deeper canyons trap wind less effectively, reducing the canyon wind speed.\n\nhw_range_wind = 0.1:0.05:5.0\nUcan_vals = Float64[]\nUac_vals = Float64[]\nVr_vals = Float64[]\n\nfor hw in hw_range_wind\n    p = base_hmf_params(compiled; H_W=hw)\n    sol = solve_hmf(compiled, p)\n    push!(Ucan_vals, sol[compiled.U_can][end])\n    push!(Uac_vals, sol[compiled.U_ac][end])\n    push!(Vr_vals, sol[compiled.V_r][end])\nend\n\np = plot(hw_range_wind, Ucan_vals, label=\"U_can (horizontal)\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"Wind Speed (m/s)\",\n    title=\"Canyon Wind Speed vs H/W (Eqs. 3.59-3.62)\",\n    legend=:topright)\nplot!(p, hw_range_wind, Uac_vals, label=\"U_ac (total canyon)\", linewidth=2)\nhline!(p, [sqrt(3.0^2 + 2.0^2)], label=\"V_r (reference wind)\", linestyle=:dash, color=:gray)\nvline!(p, [0.5], linestyle=:dot, color=:red, label=\"Isolated/Wake boundary\")\nvline!(p, [1.0], linestyle=:dot, color=:blue, label=\"Wake/Skimming boundary\")\np","category":"section"},{"location":"heat_momentum_fluxes/#Sensible-Heat-Fluxes-vs-Canyon-H/W","page":"Heat and Momentum Fluxes","title":"Sensible Heat Fluxes vs Canyon H/W","text":"Sensible heat fluxes from each urban surface as a function of canyon height-to-width ratio (Eqs. 3.69-3.74). Positive values indicate upward heat flux (surface warming the atmosphere). The UCL temperature is a weighted average of all surface temperatures and the atmospheric temperature.\n\nhw_range_H = 0.1:0.1:5.0\nH_roof_vals = Float64[]\nH_prvrd_vals = Float64[]\nH_imprvrd_vals = Float64[]\nH_sunwall_vals = Float64[]\nH_shdwall_vals = Float64[]\nH_total_vals = Float64[]\nT_ac_vals = Float64[]\n\nfor hw in hw_range_H\n    p = base_hmf_params(compiled; H_W=hw)\n    sol = solve_hmf(compiled, p)\n    push!(H_roof_vals, sol[compiled.H_roof][end])\n    push!(H_prvrd_vals, sol[compiled.H_prvrd][end])\n    push!(H_imprvrd_vals, sol[compiled.H_imprvrd][end])\n    push!(H_sunwall_vals, sol[compiled.H_sunwall][end])\n    push!(H_shdwall_vals, sol[compiled.H_shdwall][end])\n    push!(H_total_vals, sol[compiled.H_total][end])\n    push!(T_ac_vals, sol[compiled.T_ac][end])\nend\n\np1 = plot(hw_range_H, H_roof_vals, label=\"H_roof\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"Sensible Heat Flux (W m⁻²)\",\n    title=\"Surface Sensible Heat Fluxes (Eqs. 3.69-3.74)\",\n    legend=:right)\nplot!(p1, hw_range_H, H_prvrd_vals, label=\"H_prvrd\", linewidth=2)\nplot!(p1, hw_range_H, H_imprvrd_vals, label=\"H_imprvrd\", linewidth=2)\nplot!(p1, hw_range_H, H_sunwall_vals, label=\"H_sunwall\", linewidth=2)\nplot!(p1, hw_range_H, H_shdwall_vals, label=\"H_shdwall\", linewidth=2)\nplot!(p1, hw_range_H, H_total_vals, label=\"H_total\", linewidth=2, linestyle=:dash, color=:black)\n\np2 = plot(hw_range_H, T_ac_vals, label=\"T_ac\", linewidth=2, color=:red,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"Temperature (K)\",\n    title=\"UCL Air Temperature (Eq. 3.75)\",\n    legend=:topright)\nhline!(p2, [300.0], label=\"θ_atm\", linestyle=:dash, color=:gray)\n\np = plot(p1, p2, layout=(2, 1), size=(700, 700))\np\n\nThe UCL temperature shifts towards the surface temperatures as the canyon deepens and surface-to-air conductances dominate over the atmospheric conductance. Individual surface heat fluxes adjust as the UCL temperature changes with H/W.","category":"section"},{"location":"heat_momentum_fluxes/#Aerodynamic-and-Surface-Resistances-vs-Stability","page":"Heat and Momentum Fluxes","title":"Aerodynamic and Surface Resistances vs Stability","text":"Aerodynamic resistance decreases under unstable conditions (enhanced turbulent mixing) and increases under stable conditions (suppressed mixing). The surface resistance depends on the canyon wind speed through forced convection (Eq. 3.68).\n\nζ_range_r = -2.0:0.1:2.0\nr_am_vals = Float64[]\nr_ah_vals = Float64[]\nr_s_vals = Float64[]\n\nfor ζ in ζ_range_r\n    if abs(ζ) < 0.001\n        ζ = sign(ζ) == -1 ? -0.001 : 0.001\n    end\n    p = base_hmf_params(compiled; ζ_in=ζ)\n    sol = solve_hmf(compiled, p)\n    push!(r_am_vals, sol[compiled.r_am][end])\n    push!(r_ah_vals, sol[compiled.r_ah][end])\n    push!(r_s_vals, sol[compiled.r_s_u][end])\nend\n\np = plot(ζ_range_r, r_am_vals, label=\"r_am (momentum)\", linewidth=2,\n    xlabel=\"ζ = (z-d)/L\", ylabel=\"Resistance (s/m)\",\n    title=\"Resistances vs Stability (Eqs. 3.65-3.68)\",\n    legend=:topleft, yscale=:log10)\nplot!(p, ζ_range_r, r_ah_vals, label=\"r_ah (heat)\", linewidth=2)\nplot!(p, ζ_range_r, r_s_vals, label=\"r_s (surface)\", linewidth=2)\nvline!(p, [0.0], linestyle=:dash, color=:gray, label=\"Neutral\")\np\n\nThe aerodynamic resistances r_am and r_ah vary strongly with stability, while the surface resistance r_s shows a weaker dependence because it is controlled primarily by the canyon wind speed rather than directly by the stability corrections.","category":"section"},{"location":"heat_momentum_fluxes/#Convective-Velocity-vs-Stability","page":"Heat and Momentum Fluxes","title":"Convective Velocity vs Stability","text":"The convective velocity U_c (Eqs. 3.29-3.30) augments the effective wind speed V_a under unstable conditions. U_c = beta w_* where w_* is the convective velocity scale computed from the friction velocity and the Monin-Obukhov length. Under stable conditions U_c = 0 and V_a reduces to the horizontal wind speed.\n\nζ_range_uc = -3.0:0.05:1.0\nUc_vals = Float64[]\nVa_vals = Float64[]\nVr_vals_stab = Float64[]\n\nfor ζ in ζ_range_uc\n    if abs(ζ) < 0.001\n        ζ = sign(ζ) == -1 ? -0.001 : 0.001\n    end\n    p = base_hmf_params(compiled; ζ_in=ζ)\n    sol = solve_hmf(compiled, p)\n    push!(Uc_vals, sol[compiled.U_c][end])\n    push!(Va_vals, sol[compiled.V_a][end])\n    push!(Vr_vals_stab, sol[compiled.V_r][end])\nend\n\np1 = plot(ζ_range_uc, Uc_vals, label=\"U_c (convective velocity)\", linewidth=2,\n    xlabel=\"ζ = (z-d)/L\", ylabel=\"Speed (m/s)\",\n    title=\"Convective Velocity and Effective Wind Speed (Eqs. 3.25, 3.29-3.30)\",\n    legend=:topright)\nplot!(p1, ζ_range_uc, Va_vals, label=\"V_a (effective wind)\", linewidth=2)\nplot!(p1, ζ_range_uc, Vr_vals_stab, label=\"V_r (horizontal wind)\", linewidth=2, linestyle=:dash)\nvline!(p1, [0.0], linestyle=:dash, color=:gray, label=\"Neutral\")\np1\n\nUnder strongly unstable conditions, the convective velocity can exceed the mean horizontal wind, significantly increasing the effective wind speed and turbulent exchange.","category":"section"},{"location":"heat_momentum_fluxes/#Partial-Derivatives-of-Sensible-Heat-Flux","page":"Heat and Momentum Fluxes","title":"Partial Derivatives of Sensible Heat Flux","text":"The partial derivatives partial H  partial T_g (Eqs. 3.95-3.99) quantify the sensitivity of each surface's sensible heat flux to changes in its ground temperature. These are needed for the implicit coupling with the soil temperature equation (Chapter 4). Larger values indicate stronger thermal coupling between the surface and the atmosphere.\n\nhw_range_dH = 0.1:0.1:5.0\ndH_roof_vals = Float64[]\ndH_prvrd_vals = Float64[]\ndH_imprvrd_vals = Float64[]\ndH_sunwall_vals = Float64[]\ndH_shdwall_vals = Float64[]\n\nfor hw in hw_range_dH\n    p = base_hmf_params(compiled; H_W=hw)\n    sol = solve_hmf(compiled, p)\n    push!(dH_roof_vals, sol[compiled.dH_roof_dT][end])\n    push!(dH_prvrd_vals, sol[compiled.dH_prvrd_dT][end])\n    push!(dH_imprvrd_vals, sol[compiled.dH_imprvrd_dT][end])\n    push!(dH_sunwall_vals, sol[compiled.dH_sunwall_dT][end])\n    push!(dH_shdwall_vals, sol[compiled.dH_shdwall_dT][end])\nend\n\np = plot(hw_range_dH, dH_roof_vals, label=\"∂H_roof/∂T\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"∂H/∂T (W m⁻² K⁻¹)\",\n    title=\"Sensible Heat Flux Derivatives (Eqs. 3.95-3.99)\",\n    legend=:right)\nplot!(p, hw_range_dH, dH_prvrd_vals, label=\"∂H_prvrd/∂T\", linewidth=2)\nplot!(p, hw_range_dH, dH_imprvrd_vals, label=\"∂H_imprvrd/∂T\", linewidth=2)\nplot!(p, hw_range_dH, dH_sunwall_vals, label=\"∂H_sunwall/∂T\", linewidth=2)\nplot!(p, hw_range_dH, dH_shdwall_vals, label=\"∂H_shdwall/∂T\", linewidth=2)\np\n\nThe partial derivatives reflect the thermal coupling strength of each surface. Surfaces with larger area fractions (e.g., roof) have stronger coupling, while the wall derivatives increase with H/W as wall area grows relative to the canyon floor.","category":"section"},{"location":"heat_momentum_fluxes/#UrbanCanopy.HeatMomentumFluxes","page":"Heat and Momentum Fluxes","title":"UrbanCanopy.HeatMomentumFluxes","text":"HeatMomentumFluxes(; name=:HeatMomentumFluxes)\n\nUrban heat and momentum fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 3 of Oleson et al. (2010).\n\nComputes the Monin-Obukhov similarity theory parameters, roughness length and displacement height, wind speed in the urban canyon, aerodynamic and surface resistances, sensible and latent heat fluxes for the five urban surfaces (roof, sunlit wall, shaded wall, pervious road, impervious road), total momentum fluxes, and the UCL air temperature and specific humidity.\n\nThe Monin-Obukhov stability parameter ζ is taken as an input parameter, since in the original CLM implementation it is computed through an iterative procedure (Section 3.2.3). Given ζ, the system computes all stability corrections, friction velocity, aerodynamic resistances, and surface fluxes as a directed algebraic system without circular dependencies.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 3: Heat and Momentum Fluxes (pp. 61-89).\n\n\n\n\n\n","category":"function"},{"location":"albedos_radiative_fluxes/#Albedos-and-Radiative-Fluxes","page":"Albedos and Radiative Fluxes","title":"Albedos and Radiative Fluxes","text":"","category":"section"},{"location":"albedos_radiative_fluxes/#Overview","page":"Albedos and Radiative Fluxes","title":"Overview","text":"Chapter 2 of the CLMU technical note describes the computation of albedos and radiative fluxes for urban surfaces. The effects of canyon geometry on the radiation balance are a key driver of urban-rural energy balance differences (Oke et al. 1991). Shadowing of urban surfaces affects incident radiation and thus temperature, and multiple reflections of radiation between canyon surfaces must be accounted for (Harman et al. 2004).\n\nThe UrbanRadiation component computes:\n\nView factors between canyon surfaces (road, walls, sky) as functions of the height-to-width ratio HW (Eqs. 2.22-2.28)\nIncident direct beam solar radiation on walls and road, integrated over canyon orientations (Eqs. 2.11-2.17)\nIncident diffuse solar radiation on canyon surfaces (Eqs. 2.29-2.32)\nAbsorbed and reflected solar radiation with closed-form multi-reflection solution (Eqs. 2.34-2.95)\nLongwave radiation including emission, reflection, and multi-reflection within the canyon (Eqs. 2.96-2.175)\n\nThe iterative multi-reflection scheme from the paper (Eqs. 2.63-2.85 for solar, 2.138-2.170 for longwave) is solved in closed form using the matrix geometric series: S_absorbed = (I - A)(I - TA)^-1 S_0, where A is the albedo matrix, T is the view-factor transport matrix, and S_0 is the initial incident radiation vector. The 3x3 matrix inverse is computed analytically.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 2: Albedos and Radiative Fluxes (pp. 26-60).","category":"section"},{"location":"albedos_radiative_fluxes/#Implementation","page":"Albedos and Radiative Fluxes","title":"Implementation","text":"The UrbanRadiation component implements the radiation balance for the urban canyon system with 62 equations, 62 variables, and 31 parameters.","category":"section"},{"location":"albedos_radiative_fluxes/#State-Variables","page":"Albedos and Radiative Fluxes","title":"State Variables","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing UrbanCanopy\n\nsys = UrbanRadiation()\n\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"albedos_radiative_fluxes/#Parameters","page":"Albedos and Radiative Fluxes","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"albedos_radiative_fluxes/#Equations","page":"Albedos and Radiative Fluxes","title":"Equations","text":"eqs = equations(sys)","category":"section"},{"location":"albedos_radiative_fluxes/#Analysis","page":"Albedos and Radiative Fluxes","title":"Analysis","text":"The following figures reproduce the key results from Chapter 2 of the CLMU technical note using the implementation above.\n\nusing OrdinaryDiffEqDefault\nusing Plots\n\ncompiled = mtkcompile(sys)\n\nfunction solve_urban(compiled, params)\n    prob = ODEProblem(compiled, params, (0.0, 1.0))\n    solve(prob)\nend\n\nfunction base_params(compiled; H_W=1.0, μ_zen=0.5236)\n    Dict(\n        compiled.H_W => H_W,\n        compiled.W_roof => 0.25,\n        compiled.S_atm_dir_vis => 200.0,\n        compiled.S_atm_dir_nir => 200.0,\n        compiled.S_atm_dif_vis => 100.0,\n        compiled.S_atm_dif_nir => 100.0,\n        compiled.L_atm_down => 340.0,\n        compiled.μ_zen => μ_zen,\n        compiled.α_roof_dir_vis => 0.15,\n        compiled.α_roof_dir_nir => 0.15,\n        compiled.α_roof_dif_vis => 0.15,\n        compiled.α_roof_dif_nir => 0.15,\n        compiled.α_road_dir_vis => 0.08,\n        compiled.α_road_dir_nir => 0.08,\n        compiled.α_road_dif_vis => 0.08,\n        compiled.α_road_dif_nir => 0.08,\n        compiled.α_wall_dir_vis => 0.25,\n        compiled.α_wall_dir_nir => 0.25,\n        compiled.α_wall_dif_vis => 0.25,\n        compiled.α_wall_dif_nir => 0.25,\n        compiled.ε_roof => 0.90,\n        compiled.ε_road => 0.95,\n        compiled.ε_wall => 0.85,\n        compiled.T_roof => 292.16,\n        compiled.T_road => 292.16,\n        compiled.T_sunwall => 292.16,\n        compiled.T_shdwall => 292.16,\n    )\nend\nnothing # hide","category":"section"},{"location":"albedos_radiative_fluxes/#Figure-2.4:-View-Factors-vs-Canyon-H/W-Ratio","page":"Albedos and Radiative Fluxes","title":"Figure 2.4: View Factors vs Canyon H/W Ratio","text":"View factors as a function of canyon height to width ratio (cf. Figure 2.4, p. 37). Psi_road-sky is the fraction of radiation reaching the sky from the road, Psi_road-wall is the fraction reaching the wall from the road, Psi_wall-sky and Psi_wall-road are the fractions reaching the sky and road from the wall, and Psi_wall-wall is the fraction reaching the opposite wall.\n\nhw_range = 10 .^ range(-2, 1, length=200)\n\nψ_road_sky = Float64[]\nψ_road_wall = Float64[]\nψ_wall_sky = Float64[]\nψ_wall_road = Float64[]\nψ_wall_wall = Float64[]\n\nfor hw in hw_range\n    p = base_params(compiled; H_W=hw)\n    sol = solve_urban(compiled, p)\n    push!(ψ_road_sky, sol[compiled.Ψ_road_sky][end])\n    push!(ψ_road_wall, sol[compiled.Ψ_road_wall][end])\n    push!(ψ_wall_sky, sol[compiled.Ψ_wall_sky][end])\n    push!(ψ_wall_road, sol[compiled.Ψ_wall_road][end])\n    push!(ψ_wall_wall, sol[compiled.Ψ_wall_wall][end])\nend\n\np = plot(hw_range, ψ_road_sky, label=\"Ψ_road-sky\", xscale=:log10,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"View Factor\",\n    title=\"View Factors vs Canyon H/W Ratio (Figure 2.4)\",\n    linewidth=2, legend=:right, ylims=(0, 1))\nplot!(p, hw_range, ψ_road_wall, label=\"Ψ_road-wall\", linewidth=2)\nplot!(p, hw_range, ψ_wall_sky, label=\"Ψ_wall-sky, Ψ_wall-road\", linewidth=2)\nplot!(p, hw_range, ψ_wall_wall, label=\"Ψ_wall-wall\", linewidth=2)\np\n\nAt low H/W ratios the road-sky view factor is close to one (flat surface behavior), while at high H/W ratios most radiative interactions occur between the walls and between the walls and road.","category":"section"},{"location":"albedos_radiative_fluxes/#Figure-2.5:-Absorbed-Solar-Radiation-vs-H/W-Ratio","page":"Albedos and Radiative Fluxes","title":"Figure 2.5: Absorbed Solar Radiation vs H/W Ratio","text":"Solar radiation absorbed by urban surfaces for solar zenith angles of 30 degrees (top) and 60 degrees (bottom) (cf. Figure 2.5, p. 47). The atmospheric solar radiation is S_atmdownarrow^mu = 400 and S_atmdownarrow = 200 W m^-2. Albedos: roof = 0.15, road = 0.08, wall = 0.25. Note that wall fluxes are per unit wall area; the canyon total converts them to per unit ground area using the H/W ratio.\n\nhw_range_lin = 0.1:0.1:10.0\n\nfunction compute_absorbed_solar(compiled, hw_range, μ_zen)\n    road = Float64[]\n    sunwall = Float64[]\n    shdwall = Float64[]\n    roof = Float64[]\n    canyon = Float64[]\n\n    for hw in hw_range\n        p = base_params(compiled; H_W=hw, μ_zen=μ_zen)\n        p[compiled.S_atm_dir_vis] = 200.0\n        p[compiled.S_atm_dir_nir] = 200.0\n        p[compiled.S_atm_dif_vis] = 100.0\n        p[compiled.S_atm_dif_nir] = 100.0\n        sol = solve_urban(compiled, p)\n        push!(road, sol[compiled.S_net_road][end])\n        push!(sunwall, sol[compiled.S_net_sunwall][end])\n        push!(shdwall, sol[compiled.S_net_shdwall][end])\n        push!(roof, sol[compiled.S_net_roof][end])\n        push!(canyon, sol[compiled.S_net_uc][end])\n    end\n    return road, sunwall, shdwall, roof, canyon\nend\n\nroad30, sw30, sh30, roof30, can30 = compute_absorbed_solar(compiled, hw_range_lin, deg2rad(30))\nroad60, sw60, sh60, roof60, can60 = compute_absorbed_solar(compiled, hw_range_lin, deg2rad(60))\n\np1 = plot(hw_range_lin, can30, label=\"Canyon\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\",\n    ylabel=\"Absorbed Solar Radiation (W m⁻²)\",\n    title=\"Solar Zenith Angle = 30°\",\n    legend=:right, ylims=(0, 700))\nplot!(p1, hw_range_lin, roof30, label=\"Roof\", linewidth=2)\nplot!(p1, hw_range_lin, road30, label=\"Road\", linewidth=2)\nplot!(p1, hw_range_lin, sw30, label=\"Sunlit Wall\", linewidth=2)\nplot!(p1, hw_range_lin, sh30, label=\"Shaded Wall\", linewidth=2)\n\np2 = plot(hw_range_lin, can60, label=\"Canyon\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\",\n    ylabel=\"Absorbed Solar Radiation (W m⁻²)\",\n    title=\"Solar Zenith Angle = 60°\",\n    legend=:right, ylims=(0, 700))\nplot!(p2, hw_range_lin, roof60, label=\"Roof\", linewidth=2)\nplot!(p2, hw_range_lin, road60, label=\"Road\", linewidth=2)\nplot!(p2, hw_range_lin, sw60, label=\"Sunlit Wall\", linewidth=2)\nplot!(p2, hw_range_lin, sh60, label=\"Shaded Wall\", linewidth=2)\n\np = plot(p1, p2, layout=(2, 1), size=(700, 800))\np\n\nThe absorbed solar radiation for the roof is independent of H/W and solar zenith angle. At both zenith angles, absorbed road radiation decreases rapidly with increasing H/W as buildings shade the road. The canyon total increases slowly with H/W because radiation trapping in deeper canyons increases total absorption.","category":"section"},{"location":"albedos_radiative_fluxes/#Figure-2.6:-Canyon-Albedo-vs-H/W-Ratio","page":"Albedos and Radiative Fluxes","title":"Figure 2.6: Canyon Albedo vs H/W Ratio","text":"Direct beam and diffuse canyon albedo (excluding roof) as a function of H/W ratio for solar zenith angles from 0 to 85 degrees (cf. Figure 2.6, p. 48). Albedos: road = 0.08, wall = 0.25.\n\nhw_range_alb = 0.05:0.05:3.0\nzenith_angles = 0:5:85\n\np = plot(xlabel=\"Canyon H/W Ratio\", ylabel=\"Canyon Albedo\",\n    title=\"Canyon Albedo vs H/W Ratio (Figure 2.6)\",\n    legend=false, ylims=(0, 0.14))\n\n# Direct beam albedo for each zenith angle (solid lines)\nfor (i, zen_deg) in enumerate(zenith_angles)\n    zen_rad = deg2rad(zen_deg)\n    # Avoid exactly 0 or 90 degrees\n    if zen_rad < 0.001\n        zen_rad = 0.001\n    end\n    alb_dir = Float64[]\n    for hw in hw_range_alb\n        params = base_params(compiled; H_W=hw, μ_zen=zen_rad)\n        sol = solve_urban(compiled, params)\n        # Average VIS and NIR direct beam albedo\n        a_vis = sol[compiled.α_uc_dir_vis][end]\n        a_nir = sol[compiled.α_uc_dir_nir][end]\n        push!(alb_dir, (a_vis + a_nir) / 2)\n    end\n    plot!(p, hw_range_alb, alb_dir, linewidth=1.5, color=:black, linestyle=:solid)\nend\n\n# Diffuse albedo (dashed line) - independent of zenith angle\nalb_dif = Float64[]\nfor hw in hw_range_alb\n    params = base_params(compiled; H_W=hw)\n    sol = solve_urban(compiled, params)\n    a_vis = sol[compiled.α_uc_dif_vis][end]\n    a_nir = sol[compiled.α_uc_dif_nir][end]\n    push!(alb_dif, (a_vis + a_nir) / 2)\nend\nplot!(p, hw_range_alb, alb_dif, linewidth=2, color=:black, linestyle=:dash)\n\n# Add annotations\nannotate!(p, 0.6, 0.12, text(\"Horizon\", 8))\nannotate!(p, 0.4, 0.035, text(\"Zenith\", 8))\nannotate!(p, 2.5, 0.09, text(\"Diffuse\", 8))\nannotate!(p, 2.5, 0.04, text(\"Direct Beam\", 8))\np\n\nThe canyon albedo generally decreases with H/W as more radiation is trapped and absorbed within deeper canyons. The trapping of solar radiation is less effective at larger solar zenith angles (near horizon), where the albedo can increase at small H/W because the higher-albedo walls dominate the radiative exchange.","category":"section"},{"location":"albedos_radiative_fluxes/#Figure-2.7:-Net-Longwave-Radiation-vs-H/W-Ratio","page":"Albedos and Radiative Fluxes","title":"Figure 2.7: Net Longwave Radiation vs H/W Ratio","text":"Net longwave radiation (positive toward the atmosphere) for urban surfaces with two different emissivity configurations (cf. Figure 2.7, p. 59). The atmospheric longwave radiation is L_atmdownarrow = 340 W m^-2 and the temperature of each surface is 292.16 K. Wall fluxes are per unit wall area.\n\nhw_range_lw = 0.1:0.1:10.0\n\nfunction compute_net_lw(compiled, hw_range; ε_roof, ε_road, ε_wall)\n    road_lw = Float64[]\n    wall_lw = Float64[]\n    roof_lw = Float64[]\n    canyon_lw = Float64[]\n\n    for hw in hw_range\n        p = base_params(compiled; H_W=hw)\n        p[compiled.ε_roof] = ε_roof\n        p[compiled.ε_road] = ε_road\n        p[compiled.ε_wall] = ε_wall\n        sol = solve_urban(compiled, p)\n        push!(road_lw, sol[compiled.L_net_road][end])\n        push!(wall_lw, sol[compiled.L_net_sunwall][end])  # walls equal when T equal\n        push!(roof_lw, sol[compiled.L_net_roof][end])\n        push!(canyon_lw, sol[compiled.L_net_uc][end])\n    end\n    return road_lw, wall_lw, roof_lw, canyon_lw\nend\n\nroad1, wall1, roof1, can1 = compute_net_lw(compiled, hw_range_lw;\n    ε_roof=0.95, ε_road=0.95, ε_wall=0.95)\nroad2, wall2, roof2, can2 = compute_net_lw(compiled, hw_range_lw;\n    ε_roof=0.90, ε_road=0.94, ε_wall=0.85)\n\np1 = plot(hw_range_lw, can1, label=\"Canyon\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\",\n    ylabel=\"Net Longwave Radiation (W m⁻²)\",\n    title=\"Emissivity: Roof=0.95, Road=0.95, Wall=0.95\",\n    legend=:right, ylims=(0, 80))\nplot!(p1, hw_range_lw, roof1, label=\"Roof\", linewidth=2)\nplot!(p1, hw_range_lw, road1, label=\"Road\", linewidth=2)\nplot!(p1, hw_range_lw, wall1, label=\"Walls\", linewidth=2)\n\np2 = plot(hw_range_lw, can2, label=\"Canyon\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\",\n    ylabel=\"Net Longwave Radiation (W m⁻²)\",\n    title=\"Emissivity: Roof=0.90, Road=0.94, Wall=0.85\",\n    legend=:right, ylims=(0, 80))\nplot!(p2, hw_range_lw, roof2, label=\"Roof\", linewidth=2)\nplot!(p2, hw_range_lw, road2, label=\"Road\", linewidth=2)\nplot!(p2, hw_range_lw, wall2, label=\"Walls\", linewidth=2)\n\np = plot(p1, p2, layout=(2, 1), size=(700, 800))\np\n\nThe net longwave radiation for the roof is independent of H/W and increases with higher emissivity. The net longwave for road and walls decreases rapidly with increasing H/W as more radiation is trapped within the canyon. The walls have lower net longwave than the road because their sky view factors are smaller. The canyon net longwave (sum of road and wall fluxes converted to per unit ground area) increases slowly with H/W because of the larger surface area of the walls.","category":"section"},{"location":"albedos_radiative_fluxes/#UrbanCanopy.UrbanRadiation","page":"Albedos and Radiative Fluxes","title":"UrbanCanopy.UrbanRadiation","text":"UrbanRadiation(; name=:UrbanRadiation)\n\nUrban albedos and radiative fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 2 of Oleson et al. (2010).\n\nComputes the view factors, incident direct beam and diffuse solar radiation, absorbed and reflected solar radiation (with closed-form multi-reflection solution for the urban canyon), incident longwave radiation, and absorbed/reflected/emitted longwave radiation for urban surfaces: roof, sunlit wall, shaded wall, and road.\n\nThe urban canyon is represented as an infinitely long canyon of width W bordered by buildings of height H. Radiation interactions within the canyon account for multiple reflections between walls and road using view factors. The iterative multi-reflection scheme (Eqs. 2.63-2.85, 2.138-2.170) is solved in closed form using the matrix geometric series: S_absorbed = (I - A) * (I - T*A)^{-1} * S_0, where A is the albedo matrix, T is the view-factor transport matrix, and S_0 is the initial incident radiation vector.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 2: Albedos and Radiative Fluxes (pp. 26-60).\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#Hydrology","page":"Hydrology","title":"Hydrology","text":"","category":"section"},{"location":"hydrology/#Overview","page":"Hydrology","title":"Overview","text":"Chapter 5 of the CLMU technical note describes the hydrological processes simulated for the pervious road, roof, and impervious road surfaces. The hydrology for the pervious road follows CLM4 for bare soil surfaces and includes:\n\nSnow accumulation and melt, water transfer between snow layers\nInfiltration, evaporation, surface runoff\nSub-surface drainage, redistribution within the soil column\nGroundwater discharge and recharge\n\nThe roof and impervious road are hydrologically inactive except for their limited capacity to intercept, store (1 kg m^-2), and evaporate liquid precipitation and snow. Sunlit and shaded walls are hydrologically inactive.\n\nThe implementation is split into modular components covering: snow density, ice/water content in snow, snow compaction, snow layer combination, soil hydraulic properties, surface runoff and infiltration, soil water flux, equilibrium soil moisture, groundwater drainage, water table depth, aquifer water balance, snow capping runoff, surface layer updates, and water balance equations for pervious and impervious surfaces.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 5: Hydrology (pp. 110-146).","category":"section"},{"location":"hydrology/#Implementation","page":"Hydrology","title":"Implementation","text":"The hydrology module implements the equations from Chapter 5 as 17 modular ModelingToolkit components. Each component can be used independently or composed into larger systems.","category":"section"},{"location":"hydrology/#Snow-Density","page":"Hydrology","title":"Snow Density","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing UrbanCanopy\n\nsys = SnowDensity()\n\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys)","category":"section"},{"location":"hydrology/#Snow-Ice-Content","page":"Hydrology","title":"Snow Ice Content","text":"sys_ice = SnowIceContent()\n\nvars = unknowns(sys_ice)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_ice)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_ice)","category":"section"},{"location":"hydrology/#Snow-Water-Content","page":"Hydrology","title":"Snow Water Content","text":"sys_swc = SnowWaterContent()\n\nvars = unknowns(sys_swc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_swc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_swc)","category":"section"},{"location":"hydrology/#Snow-Compaction","page":"Hydrology","title":"Snow Compaction","text":"sys_sc = SnowCompaction()\n\nvars = unknowns(sys_sc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_sc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_sc)","category":"section"},{"location":"hydrology/#Snow-Layer-Combination","page":"Hydrology","title":"Snow Layer Combination","text":"sys_slc = SnowLayerCombination()\n\nvars = unknowns(sys_slc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_slc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_slc)","category":"section"},{"location":"hydrology/#Soil-Hydraulic-Properties","page":"Hydrology","title":"Soil Hydraulic Properties","text":"sys_soil = SoilHydraulicProperties()\n\nvars = unknowns(sys_soil)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_soil)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_soil)","category":"section"},{"location":"hydrology/#Groundwater-Drainage","page":"Hydrology","title":"Groundwater Drainage","text":"sys_gw = GroundwaterDrainage()\n\nvars = unknowns(sys_gw)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_gw)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_gw)","category":"section"},{"location":"hydrology/#Water-Table-Depth","page":"Hydrology","title":"Water Table Depth","text":"sys_wt = WaterTableDepth()\n\nvars = unknowns(sys_wt)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_wt)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_wt)","category":"section"},{"location":"hydrology/#Richards'-Equation-(PDE-Soil-Water-Movement)","page":"Hydrology","title":"Richards' Equation (PDE Soil Water Movement)","text":"Richards' equation is implemented as a PDE using MethodOfLines.jl for automatic spatial discretization. The function returns a named tuple containing the discretized ODE problem and symbolic variables.\n\nusing MethodOfLines, DomainSets\n\nresult_re = RichardsEquation(;\n    N_layers = 10, Δz_total = 2.0,\n    pct_sand = 50.0, pct_clay = 20.0,\n    θ_top_val = 0.3, θ_bottom_val = 0.3,\n    θ_init_val = 0.3,\n)\nprintln(\"Soil properties for 50% sand, 20% clay:\")\nprintln(\"  k_sat = \", result_re.k_sat_val, \" m/s\")\nprintln(\"  θ_sat = \", result_re.θ_sat_val, \" m³/m³\")\nprintln(\"  B     = \", result_re.B_val)\nprintln(\"  ψ_sat = \", result_re.ψ_sat_val, \" m\")","category":"section"},{"location":"hydrology/#Surface-Runoff-and-Infiltration","page":"Hydrology","title":"Surface Runoff and Infiltration","text":"sys_sri = SurfaceRunoffInfiltration()\n\nvars = unknowns(sys_sri)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_sri)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_sri)","category":"section"},{"location":"hydrology/#Soil-Water-Flux","page":"Hydrology","title":"Soil Water Flux","text":"sys_swf = SoilWaterFlux()\n\nvars = unknowns(sys_swf)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_swf)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_swf)","category":"section"},{"location":"hydrology/#Soil-Water-Equilibrium","page":"Hydrology","title":"Soil Water Equilibrium","text":"sys_swe = SoilWaterEquilibrium()\n\nvars = unknowns(sys_swe)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_swe)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_swe)","category":"section"},{"location":"hydrology/#Aquifer-Water-Balance","page":"Hydrology","title":"Aquifer Water Balance","text":"sys_awb = AquiferWaterBalance()\n\nvars = unknowns(sys_awb)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_awb)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_awb)","category":"section"},{"location":"hydrology/#Snow-Capping-Runoff","page":"Hydrology","title":"Snow Capping Runoff","text":"sys_scr = SnowCappingRunoff()\n\nvars = unknowns(sys_scr)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_scr)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_scr)","category":"section"},{"location":"hydrology/#Surface-Layer-Update","page":"Hydrology","title":"Surface Layer Update","text":"sys_slu = SurfaceLayerUpdate()\n\nvars = unknowns(sys_slu)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_slu)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_slu)","category":"section"},{"location":"hydrology/#Pervious-Road-Water-Balance","page":"Hydrology","title":"Pervious Road Water Balance","text":"sys_prwb = PerviousRoadWaterBalance()\n\nvars = unknowns(sys_prwb)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_prwb)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_prwb)","category":"section"},{"location":"hydrology/#Impervious-Water-Balance","page":"Hydrology","title":"Impervious Water Balance","text":"sys_iwb = ImperviousWaterBalance()\n\nvars = unknowns(sys_iwb)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_iwb)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_iwb)","category":"section"},{"location":"hydrology/#Impervious-Runoff","page":"Hydrology","title":"Impervious Runoff","text":"sys_ir = ImperviousRunoff()\n\nvars = unknowns(sys_ir)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_ir)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_ir)","category":"section"},{"location":"hydrology/#Interface-Hydraulic-Conductivity","page":"Hydrology","title":"Interface Hydraulic Conductivity","text":"sys_ihc = InterfaceHydraulicConductivity()\n\nvars = unknowns(sys_ihc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_ihc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_ihc)","category":"section"},{"location":"hydrology/#Soil-Water-Content","page":"Hydrology","title":"Soil Water Content","text":"sys_swcc = SoilWaterContentCalc()\n\nvars = unknowns(sys_swcc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_swcc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [DynamicQuantities.dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\nequations(sys_swcc)","category":"section"},{"location":"hydrology/#Table-5.1:-Snow-Layer-Thickness-Bounds","page":"Hydrology","title":"Table 5.1: Snow Layer Thickness Bounds","text":"The minimum and maximum thicknesses for the five snow layers used in the model (Table 5.1, p. 121):\n\nLayer Delta z_min (m) (Delta z_max)_l (m) (Delta z_max)_u (m)\n1 (top) 0.010 0.03 0.02\n2 0.015 0.07 0.05\n3 0.025 0.18 0.11\n4 0.055 0.41 0.23\n5 (bottom) 0.115 –- –-\n\nWhere (Delta z_max)_l and (Delta z_max)_u are the maximum thickness at the lower bound (when number of layers equals the layer index) and upper bound (when number of layers exceeds the layer index), respectively.","category":"section"},{"location":"hydrology/#Analysis","page":"Hydrology","title":"Analysis","text":"The following figures illustrate the key parametric relationships implemented in the hydrology module, using the component functions directly.\n\nusing OrdinaryDiffEqDefault\nusing Plots\n\nnothing # hide","category":"section"},{"location":"hydrology/#Snow-Density-vs-Temperature-(Eq.-5.10)","page":"Hydrology","title":"Snow Density vs Temperature (Eq. 5.10)","text":"Bulk density of newly fallen snow as a function of atmospheric temperature, following Anderson (1976). The density is piecewise: 50 kg/m³ at very cold temperatures (below T_f - 15), increasing as 50 + 17(T_atm - T_f + 15)^15 for intermediate temperatures, and capped at approximately 169 kg/m³ above T_f + 2 K (cf. Eq. 5.10, p. 115).\n\nsys_sd = SnowDensity()\ncompiled_sd = mtkcompile(sys_sd)\n\nT_f = 273.15\ntemps = range(250.0, 280.0, length=200)\ndensities = Float64[]\n\nprob = ODEProblem(compiled_sd, [compiled_sd.T_atm => 250.0], (0.0, 1.0))\nfor T in temps\n    p = remake(prob; p = [compiled_sd.T_atm => T])\n    sol = solve(p)\n    push!(densities, sol[compiled_sd.ρ_sno][end])\nend\n\np = plot(temps, densities, linewidth=2, label=\"ρ_sno\",\n    xlabel=\"Atmospheric Temperature (K)\",\n    ylabel=\"Snow Density (kg/m³)\",\n    title=\"New Snow Density vs Temperature (Eq. 5.10)\")\nvline!(p, [T_f - 15], linestyle=:dash, color=:gray, label=\"T_f - 15 K\")\nvline!(p, [T_f + 2], linestyle=:dash, color=:red, label=\"T_f + 2 K\")\np\n\nBelow T_f - 15 K (258.15 K), the snow density is constant at 50 kg/m³. Between T_f - 15 and T_f + 2 K, density increases nonlinearly following the 1.5-power law. Above T_f + 2 K, density is capped at 50 + 1.7(17)^1.5 ≈ 169 kg/m³.","category":"section"},{"location":"hydrology/#Soil-Hydraulic-Properties-vs-Sand-Content-(Eqs.-5.70-5.74)","page":"Hydrology","title":"Soil Hydraulic Properties vs Sand Content (Eqs. 5.70-5.74)","text":"Soil hydraulic properties as a function of sand and clay content, using the Clapp and Hornberger (1978) and Cosby et al. (1984) pedotransfer functions. These are shown for a saturated soil (theta = theta_sat).\n\nsys_hp = SoilHydraulicProperties()\ncompiled_hp = mtkcompile(sys_hp)\n\nsand_range = range(5.0, 95.0, length=100)\nksat_vals = Float64[]\nθsat_vals = Float64[]\nψsat_vals = Float64[]\nB_vals = Float64[]\n\npct_clay = 20.0\nprob_hp = ODEProblem(compiled_hp,\n    [compiled_hp.pct_sand => 50.0, compiled_hp.pct_clay => pct_clay,\n     compiled_hp.θ_i => 0.4],\n    (0.0, 1.0))\n\nfor sand in sand_range\n    θ_sat_val = 0.489 - 0.00126 * sand\n    p = remake(prob_hp; p = [compiled_hp.pct_sand => sand,\n                              compiled_hp.pct_clay => pct_clay,\n                              compiled_hp.θ_i => θ_sat_val])\n    sol = solve(p)\n    push!(ksat_vals, sol[compiled_hp.k_sat][end])\n    push!(θsat_vals, sol[compiled_hp.θ_sat][end])\n    push!(ψsat_vals, abs(sol[compiled_hp.ψ_sat][end]))\n    push!(B_vals, sol[compiled_hp.B][end])\nend\n\np1 = plot(sand_range, ksat_vals .* 1e3, linewidth=2, label=false, yscale=:log10,\n    xlabel=\"Sand Content (%)\", ylabel=\"k_sat (mm/s)\",\n    title=\"Saturated Hydraulic Conductivity (Eq. 5.70)\")\n\np2 = plot(sand_range, θsat_vals, linewidth=2, label=false,\n    xlabel=\"Sand Content (%)\", ylabel=\"θ_sat (m³/m³)\",\n    title=\"Porosity (Eq. 5.71)\")\n\np3 = plot(sand_range, ψsat_vals .* 1e3, linewidth=2, label=false, yscale=:log10,\n    xlabel=\"Sand Content (%)\", ylabel=\"|ψ_sat| (mm)\",\n    title=\"Saturated Matric Potential (Eq. 5.74)\")\n\nclay_range = range(5.0, 60.0, length=100)\nB_clay = 2.91 .+ 0.159 .* clay_range\np4 = plot(clay_range, B_clay, linewidth=2, label=false,\n    xlabel=\"Clay Content (%)\", ylabel=\"B\",\n    title=\"Clapp-Hornberger Exponent (Eq. 5.72)\")\n\np = plot(p1, p2, p3, p4, layout=(2, 2), size=(800, 600))\np\n\nSandy soils have higher saturated hydraulic conductivity (more permeable), lower porosity, and weaker matric potential (less capillary suction). The Clapp-Hornberger exponent B increases linearly with clay content, reflecting the broader pore-size distribution of clay-rich soils. These relationships correspond to Eqs. 5.70-5.74 of the CLMU technical note.","category":"section"},{"location":"hydrology/#Groundwater-Drainage-vs-Water-Table-Depth-(Eq.-5.140)","page":"Hydrology","title":"Groundwater Drainage vs Water Table Depth (Eq. 5.140)","text":"Sub-surface drainage as an exponential function of water table depth, modified by the frozen soil impermeable fraction (cf. Eq. 5.140, p. 142).\n\nsys_dr = GroundwaterDrainage()\ncompiled_dr = mtkcompile(sys_dr)\n\nzv_range = range(0.0, 5.0, length=200)\nprob_dr = ODEProblem(compiled_dr,\n    [compiled_dr.z_v => 0.0, compiled_dr.f_ice_weighted => 0.0],\n    (0.0, 1.0))\n\nf_ice_values = [0.0, 0.25, 0.5, 0.75, 1.0]\np = plot(xlabel=\"Water Table Depth (m)\",\n    ylabel=\"Drainage Rate (kg m⁻² s⁻¹)\",\n    title=\"Sub-surface Drainage vs Water Table Depth (Eq. 5.140)\",\n    legend=:topright)\n\nfor f_ice in f_ice_values\n    drain_vals = Float64[]\n    for zv in zv_range\n        pr = remake(prob_dr; p = [compiled_dr.z_v => zv,\n                                   compiled_dr.f_ice_weighted => f_ice])\n        sol = solve(pr)\n        push!(drain_vals, sol[compiled_dr.q_drai][end])\n    end\n    plot!(p, zv_range, drain_vals, linewidth=2,\n        label=\"f_ice = $(f_ice)\")\nend\np\n\nDrainage decreases exponentially with water table depth (decay factor f_drai = 25 m^-1), reaching the maximum rate of 5.5×10^-3 kg m^-2 s^-1 at the surface. Frozen soil (higher f_ice) reduces drainage through the impermeable fraction f_imp (Eq. 5.141); fully frozen soil (f_ice = 1) eliminates drainage entirely.","category":"section"},{"location":"hydrology/#Water-Table-Depth-vs-Aquifer-Storage-(Eq.-5.146)","page":"Hydrology","title":"Water Table Depth vs Aquifer Storage (Eq. 5.146)","text":"Water table depth as a function of aquifer water storage, for a soil column with bottom interface at 3.5 m depth (cf. Eq. 5.146, p. 143).\n\nsys_wt = WaterTableDepth()\ncompiled_wt = mtkcompile(sys_wt)\n\nwa_range = range(0.0, 6000.0, length=200)\nzv_vals = Float64[]\n\nprob_wt = ODEProblem(compiled_wt,\n    [compiled_wt.z_h_bottom => 3.5, compiled_wt.W_a => 0.0],\n    (0.0, 1.0))\n\nfor wa in wa_range\n    p = remake(prob_wt; p = [compiled_wt.W_a => wa])\n    sol = solve(p)\n    push!(zv_vals, sol[compiled_wt.z_v][end])\nend\n\np = plot(wa_range, zv_vals, linewidth=2, label=false,\n    xlabel=\"Aquifer Water Storage W_a (kg/m²)\",\n    ylabel=\"Water Table Depth z_v (m)\",\n    title=\"Water Table Depth vs Aquifer Storage (Eq. 5.146)\",\n    yflip=true)\nhline!(p, [0.05], linestyle=:dash, color=:red, label=\"z_v min (0.05 m)\")\nhline!(p, [80.0], linestyle=:dash, color=:blue, label=\"z_v max (80 m)\")\np\n\nThe water table depth decreases (rises) linearly with increasing aquifer water storage according to z_v = z_hbottom + 25 - W_a  (rho_liq cdot S_y), with specific yield S_y = 02. The water table depth is clamped between 0.05 m and 80 m. For the configuration shown (z_hbottom = 35 m), at W_a = 0 the water table is at 28.5 m depth, and it reaches the minimum depth of 0.05 m when W_a approx 5690 kg/m².","category":"section"},{"location":"hydrology/#Snow-Layer-Combination-Enthalpy-Conservation-(Eq.-5.41)","page":"Hydrology","title":"Snow Layer Combination - Enthalpy Conservation (Eq. 5.41)","text":"Temperature of a combined snow layer from two layers with different temperatures, demonstrating enthalpy conservation (Eqs. 5.38-5.42, p. 122).\n\nsys_comb = SnowLayerCombination()\ncompiled_comb = mtkcompile(sys_comb)\n\nT_f = 273.15\nT2_range = range(245.0, 273.0, length=100)\nTc_vals = Float64[]\n\nprob_comb = ODEProblem(compiled_comb,\n    [compiled_comb.Δz_1 => 0.05, compiled_comb.Δz_2 => 0.1,\n     compiled_comb.w_liq_1 => 0.5, compiled_comb.w_liq_2 => 1.0,\n     compiled_comb.w_ice_1 => 3.0, compiled_comb.w_ice_2 => 5.0,\n     compiled_comb.T_1 => 270.0, compiled_comb.T_2 => 260.0],\n    (0.0, 1.0))\n\nfor T2 in T2_range\n    p = remake(prob_comb; p = [compiled_comb.T_2 => T2])\n    sol = solve(p)\n    push!(Tc_vals, sol[compiled_comb.T_c][end])\nend\n\np = plot(T2_range, Tc_vals, linewidth=2, label=\"T_combined\",\n    xlabel=\"Layer 2 Temperature (K)\",\n    ylabel=\"Combined Temperature (K)\",\n    title=\"Snow Layer Combination Temperature (Eq. 5.41)\")\nhline!(p, [270.0], linestyle=:dash, color=:gray, label=\"T_1 = 270 K\")\nplot!(p, T2_range, T2_range, linestyle=:dot, color=:gray, label=\"T_2\")\np\n\nThe combined temperature lies between the two layer temperatures, weighted by the thermal mass (ice and liquid heat capacities) of each layer. Because layer 2 has more mass (5 kg/m² ice + 1 kg/m² liquid vs 3 + 0.5 for layer 1), the combined temperature is closer to T_2 than T_1.","category":"section"},{"location":"hydrology/#Richards'-Equation-Wetting-Front-Propagation-(Eq.-5.59)","page":"Hydrology","title":"Richards' Equation - Wetting Front Propagation (Eq. 5.59)","text":"Wetting front propagating downward through a soil column, driven by a wet Dirichlet boundary at the top and dry initial conditions. The soil column is discretized using MethodOfLines.jl.\n\nusing MethodOfLines, DomainSets\n\nθ_sat_val = 0.489 - 0.00126 * 50.0\nΔz_total = 2.0\nN_layers = 15\nθ_dry = 0.1 * θ_sat_val\nθ_wet = 0.8 * θ_sat_val\n\nresult_infl = RichardsEquation(;\n    N_layers = N_layers, Δz_total = Δz_total,\n    pct_sand = 50.0, pct_clay = 20.0,\n    θ_top_val = θ_wet,\n    θ_bottom_val = θ_dry,\n    θ_init_val = θ_dry,\n)\n\ntspan = (0.0, 50000.0)\nprob_infl = remake(result_infl.prob; tspan = tspan)\nsol_infl = solve(prob_infl, saveat = 10000.0)\nθ_mat_infl = sol_infl[result_infl.θ(result_infl.t_pde, result_infl.z_var)]\n\n# Spatial grid points from the discretization\ndz = Δz_total / N_layers\nz_grid = range(dz / 2, Δz_total - dz / 2, length = size(θ_mat_infl, 2))\n\np = plot(xlabel = \"Volumetric Water Content (m³/m³)\", ylabel = \"Depth (m)\",\n    title = \"Wetting Front Propagation (Eq. 5.59)\",\n    yflip = true, legend = :bottomleft)\nfor (j, t_val) in enumerate(sol_infl.t)\n    plot!(p, θ_mat_infl[j, :], collect(z_grid), linewidth = 2,\n        label = \"t = $(Int(t_val)) s\", marker = :circle, markersize = 3)\nend\nvline!(p, [θ_sat_val], linestyle = :dash, color = :gray, label = \"θ_sat\")\np\n\nThe wetting front propagates downward over time as the wet top boundary drives water into the dry soil column through both capillary diffusion and gravity. The front moves faster through sandy soils (higher k_sat) and slows as the soil approaches saturation.","category":"section"},{"location":"hydrology/#Richards'-Equation-Gravity-Drainage-(Eq.-5.68)","page":"Hydrology","title":"Richards' Equation - Gravity Drainage (Eq. 5.68)","text":"Starting from a moderately wet uniform initial condition with equal Dirichlet boundary conditions at top and bottom, the soil column evolves under the combined effects of nonlinear diffusion and gravity drainage.\n\nθ_mid = 0.4 * θ_sat_val\n\nresult_grav = RichardsEquation(;\n    N_layers = N_layers, Δz_total = Δz_total,\n    pct_sand = 50.0, pct_clay = 20.0,\n    θ_top_val = θ_mid,\n    θ_bottom_val = θ_mid,\n    θ_init_val = θ_mid,\n)\n\ntspan_grav = (0.0, 200000.0)\nprob_grav = remake(result_grav.prob; tspan = tspan_grav)\nsol_grav = solve(prob_grav, saveat = 40000.0)\nθ_mat_grav = sol_grav[result_grav.θ(result_grav.t_pde, result_grav.z_var)]\n\np = plot(xlabel = \"Volumetric Water Content (m³/m³)\", ylabel = \"Depth (m)\",\n    title = \"Gravity Drainage (Eq. 5.68)\",\n    yflip = true, legend = :bottomleft)\nfor (j, t_val) in enumerate(sol_grav.t)\n    plot!(p, θ_mat_grav[j, :], collect(z_grid), linewidth = 2,\n        label = \"t = $(Int(t_val)) s\", marker = :circle, markersize = 3)\nend\nvline!(p, [θ_sat_val], linestyle = :dash, color = :gray, label = \"θ_sat\")\np\n\nWith equal boundary conditions and gravity, the system evolves toward a steady state where the diffusive flux balances the gravitational flux. The rate of redistribution depends on the hydraulic conductivity, which is a strong function of water content through the Clapp-Hornberger relation (Eq. 5.69).","category":"section"},{"location":"hydrology/#Interface-Hydraulic-Conductivity-vs-Saturation-(Eq.-5.69)","page":"Hydrology","title":"Interface Hydraulic Conductivity vs Saturation (Eq. 5.69)","text":"Hydraulic conductivity at a layer interface as a function of saturation degree for different Clapp-Hornberger exponents B, showing the strong nonlinearity (cf. Eq. 5.69, p. 131). The frozen fraction is set to zero.\n\nsys_ihc = InterfaceHydraulicConductivity()\ncompiled_ihc = mtkcompile(sys_ihc)\n\nk_sat = 1.0e-5  # m/s\nθ_sat = 0.4     # m³/m³\nsat_range = range(0.05, 1.0, length = 100)\n\nprob_ihc = ODEProblem(compiled_ihc, [\n    compiled_ihc.k_sat_h => k_sat, compiled_ihc.θ_upper => 0.1,\n    compiled_ihc.θ_lower => 0.1,\n    compiled_ihc.θ_sat_upper => θ_sat, compiled_ihc.θ_sat_lower => θ_sat,\n    compiled_ihc.B_i => 6.0, compiled_ihc.f_frz_upper => 0.0,\n    compiled_ihc.f_frz_lower => 0.0,\n], (0.0, 1.0))\n\np = plot(xlabel = \"Saturation Degree (θ/θ_sat)\",\n    ylabel = \"k/k_sat\",\n    title = \"Interface Hydraulic Conductivity (Eq. 5.69)\",\n    yscale = :log10, legend = :bottomright)\n\nfor B in [3.0, 6.0, 9.0, 12.0]\n    k_vals = Float64[]\n    for s in sat_range\n        θ_val = s * θ_sat\n        pr = remake(prob_ihc; p = [\n            compiled_ihc.θ_upper => θ_val, compiled_ihc.θ_lower => θ_val,\n            compiled_ihc.B_i => B,\n        ])\n        sol = solve(pr)\n        push!(k_vals, sol[compiled_ihc.k_h][end] / k_sat)\n    end\n    plot!(p, collect(sat_range), k_vals, linewidth = 2, label = \"B = $(Int(B))\")\nend\np\n\nHigher Clapp-Hornberger exponents (clay-rich soils) produce steeper conductivity curves, reflecting the narrower pore-size distribution and stronger moisture dependence of hydraulic conductivity. At full saturation (thetatheta_sat = 1), the conductivity equals k_sat regardless of B.","category":"section"},{"location":"hydrology/#Impervious-Surface-Runoff-vs-Precipitation-(Eq.-5.47)","page":"Hydrology","title":"Impervious Surface Runoff vs Precipitation (Eq. 5.47)","text":"Runoff from impervious surfaces (roof and impervious road) as a function of precipitation rate, for different initial surface water contents. The ponding limit is 1 kg/m² (cf. Eqs. 5.47-5.48, pp. 124-125).\n\nsys_ir = ImperviousRunoff()\ncompiled_ir = mtkcompile(sys_ir)\n\nq_range = range(0.0, 5.0, length = 200)\n\nprob_ir = ODEProblem(compiled_ir, [\n    compiled_ir.w_liq_1 => 0.5, compiled_ir.q_liq_0 => 0.0,\n    compiled_ir.q_seva => 0.0, compiled_ir.has_snow => 0.0,\n], (0.0, 1.0))\n\np = plot(xlabel = \"Liquid Precipitation Rate (kg m⁻² s⁻¹)\",\n    ylabel = \"Surface Runoff (kg m⁻² s⁻¹)\",\n    title = \"Impervious Surface Runoff (Eq. 5.47)\",\n    legend = :topleft)\n\nfor w0 in [0.0, 0.5, 1.0, 1.5]\n    runoff_vals = Float64[]\n    for q in q_range\n        pr = remake(prob_ir; p = [compiled_ir.w_liq_1 => w0, compiled_ir.q_liq_0 => q])\n        sol = solve(pr)\n        push!(runoff_vals, sol[compiled_ir.q_over][end])\n    end\n    plot!(p, collect(q_range), runoff_vals, linewidth = 2,\n        label = \"w_liq = $(w0) kg/m²\")\nend\nplot!(p, q_range, q_range, linestyle = :dash, color = :gray, label = \"1:1 line\")\np\n\nWhen surface water exceeds the ponding limit (1 kg/m²), any additional input becomes runoff immediately. Higher initial surface water content (w_liq1) shifts the runoff curve to the left, reflecting less available storage. The dashed 1:1 line represents the theoretical maximum when all precipitation becomes runoff.","category":"section"},{"location":"hydrology/#UrbanCanopy.SnowDensity","page":"Hydrology","title":"UrbanCanopy.SnowDensity","text":"SnowDensity(; name=:SnowDensity)\n\nComputes the bulk density of newly fallen snow as a function of atmospheric temperature, following Anderson (1976) as parameterized in Eq. 5.10 of Oleson et al. (2010).\n\nThe density depends on the atmospheric temperature relative to freezing:\n\nWhen Tatm > Tf + 2 K: ρ_sno = 50 + 1.7(17)^1.5\nWhen Tf - 15 < Tatm ≤ Tf + 2: ρsno = 50 + 1.7(Tatm - Tf + 15)^1.5\nWhen Tatm ≤ Tf - 15: ρ_sno = 50\n\nReference: Oleson et al. (2010), Chapter 5, Eq. 5.10, p. 115.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SnowIceContent","page":"Hydrology","title":"UrbanCanopy.SnowIceContent","text":"SnowIceContent(; name=:SnowIceContent)\n\nComputes the conservation of ice mass in snow layers and new snowfall accumulation, following Section 5.1.1 of Oleson et al. (2010).\n\nThis component handles:\n\nNew snow depth rate from solid precipitation and snow density (derived from Eq. 5.9)\nTop layer ice content update from precipitation and frost/sublimation (Eqs. 5.12, 5.14)\n\nThe paper's Eq. 5.9 is Δzsno = qgrnd,ice·Δt / ρsno, which is a per-timestep increment. For continuous modeling we express this as a rate: dzsno/dt = qgrnd,ice / ρsno [m/s].\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.1.1, Eqs. 5.6–5.14, pp. 114–115.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SnowWaterContent","page":"Hydrology","title":"UrbanCanopy.SnowWaterContent","text":"SnowWaterContent(; name=:SnowWaterContent)\n\nComputes the flow of liquid water through snow layers, following Section 5.1.2 of Oleson et al. (2010).\n\nThe water flow between layers (Eq. 5.18) depends on the volumetric water and ice contents, with an irreducible water saturation S_r = 0.033 representing capillary retention. The flow is limited by the effective porosity of the underlying layer (Eq. 5.21).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.1.2, Eqs. 5.15–5.22, pp. 116–117.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SnowCompaction","page":"Hydrology","title":"UrbanCanopy.SnowCompaction","text":"SnowCompaction(; name=:SnowCompaction)\n\nComputes the total fractional compaction rate of snow layers, following Section 5.1.4 of Oleson et al. (2010).\n\nSnow compaction includes three processes:\n\nDestructive metamorphism (Eq. 5.26) - temperature dependent crystal breakdown\nOverburden pressure (Eq. 5.28) - compression from weight of overlying snow\nMelt-induced compaction (Eq. 5.31) - changes due to melt-freeze cycles\n\nCompaction is not allowed if the layer is saturated (Eq. 5.25) or if ice content is below a minimum value (w_ice,i ≤ 0.1 kg/m²).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.1.4, Eqs. 5.24–5.33, pp. 118–120.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SnowLayerCombination","page":"Hydrology","title":"UrbanCanopy.SnowLayerCombination","text":"SnowLayerCombination(; name=:SnowLayerCombination)\n\nComputes the combined properties when two snow layers are merged, following Section 5.1.5.1 of Oleson et al. (2010).\n\nWhen two snow layers are combined, their thicknesses, water contents, and temperatures are merged according to conservation principles (Eqs. 5.38–5.42).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.1.5.1, Eqs. 5.38–5.42, pp. 122.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SoilHydraulicProperties","page":"Hydrology","title":"UrbanCanopy.SoilHydraulicProperties","text":"SoilHydraulicProperties(; name=:SoilHydraulicProperties)\n\nComputes the hydraulic properties of soil layers for the pervious road, following Section 5.3.1 of Oleson et al. (2010).\n\nProperties computed based on Clapp and Hornberger (1978) and Cosby et al. (1984):\n\nSaturated hydraulic conductivity k_sat (Eq. 5.70)\nPorosity θ_sat (Eq. 5.71)\nClapp-Hornberger exponent B (Eq. 5.72)\nSoil matric potential ψ (Eq. 5.73)\nSaturated soil matric potential ψ_sat (Eq. 5.74)\n\nUrban soils are assumed to have no organic matter, so simplified forms are used. All values converted to SI units (m, m/s) from the paper's mm units.\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.1, Eqs. 5.69–5.74, pp. 131.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SurfaceRunoffInfiltration","page":"Hydrology","title":"UrbanCanopy.SurfaceRunoffInfiltration","text":"SurfaceRunoffInfiltration(; name=:SurfaceRunoffInfiltration)\n\nComputes surface runoff and infiltration for the pervious road, following Section 5.2 of Oleson et al. (2010).\n\nImplements the SIMTOP-based (Niu et al., 2005) runoff model (Eq. 5.49), fractional saturated area (Eq. 5.50), impermeable fraction from frozen soil (Eq. 5.51), and maximum infiltration capacity (Eq. 5.52).\n\nAll hydraulic properties are in SI units (m, m/s). The conversion between kg/(m²·s) water flux and m/s uses ρliq: 1 kg/(m²·s) = 1/ρliq m/s.\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.2, Eqs. 5.47–5.58, pp. 124–128.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SoilWaterFlux","page":"Hydrology","title":"UrbanCanopy.SoilWaterFlux","text":"SoilWaterFlux(; name=:SoilWaterFlux)\n\nComputes the soil water flux between two adjacent soil layers using the modified Darcy's law following Zeng and Decker (2009), as described in Section 5.3.2 of Oleson et al. (2010).\n\nThe flux is computed as Eq. 5.67:   q = -k[zh] * [(ψi - ψ{i+1}) + (ψ{E,i+1} - ψ{E,i})] / (z{i+1} - z_i)\n\nAll lengths and hydraulic properties in SI units (m, m/s).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.2, Eqs. 5.87–5.88, p. 135.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SoilWaterEquilibrium","page":"Hydrology","title":"UrbanCanopy.SoilWaterEquilibrium","text":"SoilWaterEquilibrium(; name=:SoilWaterEquilibrium)\n\nComputes the equilibrium soil matric potential and volumetric water content following Section 5.3.2.1 of Oleson et al. (2010).\n\nThe equilibrium state represents the hydrostatic distribution of soil moisture above the water table (Eqs. 5.98–5.106).\n\nAll lengths in SI units (m).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.2.1, Eqs. 5.98–5.106, pp. 136–138.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.RichardsEquation","page":"Hydrology","title":"UrbanCanopy.RichardsEquation","text":"RichardsEquation(; name=:RichardsEquation, N_layers=10, Δz_total=2.0, pct_sand=50.0, pct_clay=20.0, θ_top_val=0.2, θ_bottom_val=0.2, θ_init_val=0.2)\n\nImplements Richards' equation (Eq. 5.59) for vertical soil water movement using MethodOfLines.jl for automatic spatial discretization.\n\nThe governing PDE is (Eq. 5.68), written in diffusivity form:     ∂θ/∂t = ∂/∂z [D(θ) ∂θ/∂z] + ∂K(θ)/∂z\n\nwhere D(θ) = K(θ)|dψ/dθ| is the soil water diffusivity combining the Clapp-Hornberger hydraulic conductivity (Eq. 5.69) and matric potential (Eq. 5.73), and ∂K/∂z is the gravity drainage term. Here z is positive downward (depth into soil).\n\nSoil hydraulic properties follow Clapp and Hornberger (1978):\n\nK(θ) = ksat · (θ/θsat)^(2B+3)   (Eq. 5.69)\nψ(θ) = ψsat · (θ/θsat)^(-B)      (Eq. 5.73)\n\nThe diffusivity simplifies to:     D(θ) = ksat · B · |ψsat| / θsat · (θ/θsat)^(B+2)\n\nBoundary conditions:\n\nTop (z=0): Dirichlet BC θ = θ_top (surface water content)\nBottom (z=Δztotal): Dirichlet BC θ = θbottom (deep soil water content)\n\nReturns a named tuple (; prob, θ, t_pde, z_var, k_sat_val, θ_sat_val, B_val, ψ_sat_val) containing the discretized ODE problem and symbolic variables.\n\nNote: This function does not use @component because MethodOfLines.jl's discretize() returns an ODEProblem rather than a ModelingToolkit System. The PDE discretization paradigm requires working directly with the generated ODE problem.\n\nReference: Oleson et al. (2010), Chapter 5, Eqs. 5.59, 5.68–5.74, pp. 127–138.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.GroundwaterDrainage","page":"Hydrology","title":"UrbanCanopy.GroundwaterDrainage","text":"GroundwaterDrainage(; name=:GroundwaterDrainage)\n\nComputes sub-surface drainage for the pervious road based on the SIMTOP scheme, following Section 5.4 of Oleson et al. (2010).\n\nDrainage is computed as an exponential function of water table depth (Eq. 5.140), modified by a frozen soil impermeable fraction (Eq. 5.141). Drainage is restricted in frozen soils where ice content exceeds liquid water content (Eq. 5.139).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.4, Eqs. 5.138–5.141, pp. 141–142.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.WaterTableDepth","page":"Hydrology","title":"UrbanCanopy.WaterTableDepth","text":"WaterTableDepth(; name=:WaterTableDepth)\n\nComputes the water table depth from aquifer water storage, following Section 5.4 of Oleson et al. (2010).\n\nWhen the water table is below the soil column, the depth is computed from the aquifer water storage (Eq. 5.146). Water table depth is constrained to 0.05 ≤ z_v ≤ 80 m.\n\nAquifer water Wa is in kg/m² (equivalent to mm of water column height). Conversion: Wa [kg/m²] / ρ_liq [kg/m³] gives meters of water.\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.4, Eq. 5.146, p. 143.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.AquiferWaterBalance","page":"Hydrology","title":"UrbanCanopy.AquiferWaterBalance","text":"AquiferWaterBalance(; name=:AquiferWaterBalance)\n\nComputes the update of aquifer water storage, following Section 5.4 of Oleson et al. (2010).\n\nFor the case when the water table is below the soil column, the aquifer water W_a (kg/m²) is updated from the balance of recharge and drainage (Eq. 5.143). Since 1 mm water = 1 kg/m², we use kg/m² for storage and kg/(m²·s) for rates, which ensures unit consistency.\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.4, Eqs. 5.142–5.147, pp. 142–144.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SnowCappingRunoff","page":"Hydrology","title":"UrbanCanopy.SnowCappingRunoff","text":"SnowCappingRunoff(; name=:SnowCappingRunoff)\n\nComputes runoff from snow-capping when the snow water equivalent exceeds 1000 kg/m², following Section 5.5 of Oleson et al. (2010).\n\nFor snow-capped surfaces, precipitation and dew are routed to solid and liquid runoff terms (Eqs. 5.153–5.154).\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.5, Eqs. 5.153–5.154, p. 146.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SurfaceLayerUpdate","page":"Hydrology","title":"UrbanCanopy.SurfaceLayerUpdate","text":"SurfaceLayerUpdate(; name=:SurfaceLayerUpdate)\n\nComputes surface layer ice and liquid water content updates from dew, frost, and sublimation, following Section 5.4 of Oleson et al. (2010).\n\nThese updates apply to the top layer of all surfaces (roof, pervious road, impervious road).\n\nReference: Oleson et al. (2010), Chapter 5, Eqs. 5.150–5.152, p. 146.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.PerviousRoadWaterBalance","page":"Hydrology","title":"UrbanCanopy.PerviousRoadWaterBalance","text":"PerviousRoadWaterBalance(; name=:PerviousRoadWaterBalance)\n\nDescribes the overall water balance equation for the pervious road column, following Eq. 5.1 of Oleson et al. (2010).\n\nThe pervious road has a full soil column with infiltration, surface runoff, sub-surface drainage, redistribution within the soil, and groundwater interactions.\n\nReference: Oleson et al. (2010), Chapter 5, Eq. 5.1, p. 110.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.ImperviousWaterBalance","page":"Hydrology","title":"UrbanCanopy.ImperviousWaterBalance","text":"ImperviousWaterBalance(; name=:ImperviousWaterBalance)\n\nDescribes the water balance for the roof and impervious road surfaces, following Eqs. 5.2–5.3 of Oleson et al. (2010).\n\nThese surfaces have limited water storage capacity (1 kg/m² ponding limit), no sub-surface drainage, and intercept both liquid and solid precipitation.\n\nReference: Oleson et al. (2010), Chapter 5, Eqs. 5.2–5.5, pp. 112.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.ImperviousRunoff","page":"Hydrology","title":"UrbanCanopy.ImperviousRunoff","text":"ImperviousRunoff(; name=:ImperviousRunoff)\n\nComputes surface runoff for roof and impervious road surfaces, following Eqs. 5.47–5.48 of Oleson et al. (2010).\n\nThese surfaces have limited water storage capacity. When no snow layers are present (snl = 0), runoff equals the excess water above the ponding limit wpondmax = 1 kg/m². When snow layers exist (snl < 0), all liquid water reaching the surface becomes runoff.\n\nAfter runoff, the surface liquid water content is updated:\n\nIf runoff occurs: wliq1 is set to the ponding limit (Eq. 5.48, case 1)\nIf no runoff: wliq1 is updated with net input (Eq. 5.48, case 2)\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.2, Eqs. 5.47–5.48, pp. 124–125.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.InterfaceHydraulicConductivity","page":"Hydrology","title":"UrbanCanopy.InterfaceHydraulicConductivity","text":"InterfaceHydraulicConductivity(; name=:InterfaceHydraulicConductivity)\n\nComputes the hydraulic conductivity at the interface between two soil layers, following Eq. 5.69 of Oleson et al. (2010).\n\nThe interface conductivity accounts for averaging of water content and porosity between adjacent layers, Clapp-Hornberger power-law dependence on saturation, and reduction due to frozen soil (impermeable fraction).\n\nFor interfaces between two layers (i = 1, ..., Nlevsoi - 1):   k[zh,i] = (1 - (ffrz,i + ffrz,i+1)/2) * ksat[zh,i] *              [0.5(θi + θ{i+1}) / (0.5(θsat,i + θsat,i+1))]^(2B_i+3)\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.1, Eq. 5.69, p. 131.\n\n\n\n\n\n","category":"function"},{"location":"hydrology/#UrbanCanopy.SoilWaterContentCalc","page":"Hydrology","title":"UrbanCanopy.SoilWaterContentCalc","text":"SoilWaterContentCalc(; name=:SoilWaterContentCalc)\n\nComputes the total volumetric soil water content from liquid water and ice masses, following Eq. 5.137 of Oleson et al. (2010).\n\nThe total volumetric water content combines both liquid and ice phases:   θi = wliq,i / (Δzi * ρliq) + wice,i / (Δzi * ρ_ice)\n\nReference: Oleson et al. (2010), Chapter 5, Section 5.3.2, Eq. 5.137, p. 141.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#Roof,-Wall,-Road,-Snow-Temperatures","page":"Roof, Wall, Road, Snow Temperatures","title":"Roof, Wall, Road, Snow Temperatures","text":"","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Overview","page":"Roof, Wall, Road, Snow Temperatures","title":"Overview","text":"Chapter 4 of the CLMU technical note describes the computation of temperatures for roof, sunlit wall, shaded wall, pervious road, and impervious road columns with optional snow overlays. Heat conduction through each surface column is governed by the 1D heat equation (Eq. 4.4):\n\nc fracpartial Tpartial t = fracpartialpartial zleftlambda fracpartial Tpartial zright\n\nwhich is discretized automatically using MethodOfLines.jl.\n\nThe implementation provides modular components for:\n\nPDE heat conduction: Automatic spatial discretization of the heat equation for roofs/walls (uniform grid, Eq. 4.5) and roads (exponential grid, Eq. 4.8) using MethodOfLines.jl\nSnow layer geometry: Node depths, thicknesses, and interfaces for up to 5 snow layers (Eqs. 4.9–4.10)\nThermal properties: Soil conductivity via Farouki (1981) / Kersten number (Eqs. 4.77–4.82), snow conductivity via Jordan (1991) (Eq. 4.83), and volumetric heat capacities from de Vries (1963) (Eqs. 4.85–4.87)\nInterface conductivity: Harmonic mean across adjacent layers (Eq. 4.12)\nHeat flux: Fourier's law discretized across interfaces (Eq. 4.11)\nSurface energy flux: Net surface heat flux and its temperature derivative for the implicit scheme (Eqs. 4.26–4.29)\nBuilding temperature: Weighted wall/roof average for interior building temperature (Eqs. 4.37–4.38)\nWaste heat and air conditioning: HVAC waste heat distribution and air conditioning heat removal (Eqs. 4.55–4.56)\nWaste heat allocation: Distribution of waste heat and AC to pervious and impervious road surfaces (Eq. 4.27)\nAdjusted layer thickness: Road top layer thickness adjustment for  numerical accuracy (Eq. 4.30)\nHeating/cooling flux: HVAC heating and cooling fluxes based on building  temperature vs prescribed limits (Eqs. 4.51–4.54)\nPhase change energy: Energy excess/deficit for freezing/thawing assessment  (Eq. 4.59)\nPhase change adjustment: Ice/liquid mass adjustment and temperature  correction after phase change (Eqs. 4.60–4.65)\nSnow melt without layers: Snow melt when snow is present but has no  explicit layers (Eqs. 4.66–4.71)\nGrid discretization: Uniform grid for roofs/walls and exponential grid  for roads (Eqs. 4.5–4.8)\nFreezing point depression: Maximum liquid water content below freezing  via supercooled soil water (Eq. 4.58)\nSnow-soil blended heat capacity: Top layer heat capacity blending when  snow is present but has no explicit layers (Eq. 4.88)\nPhase change energy: Per-layer and total phase change energy for  freezing/thawing assessment (Eqs. 4.72–4.73)\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 4: Roof, Wall, Road, Snow Temperatures (pp. 91–109).","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Implementation","page":"Roof, Wall, Road, Snow Temperatures","title":"Implementation","text":"","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Thermal-Properties-Components","page":"Roof, Wall, Road, Snow Temperatures","title":"Thermal Properties Components","text":"","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Soil-Thermal-Properties","page":"Roof, Wall, Road, Snow Temperatures","title":"Soil Thermal Properties","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing Statistics\nusing UrbanCanopy\n\nsys_soil = SoilThermalProperties()\n\nvars = unknowns(sys_soil)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_soil)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape=false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\neqs = equations(sys_soil)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Snow-Thermal-Properties","page":"Roof, Wall, Road, Snow Temperatures","title":"Snow Thermal Properties","text":"sys_snow = SnowThermalProperties()\n\nvars = unknowns(sys_snow)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_snow)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Waste-Heat-Allocation","page":"Roof, Wall, Road, Snow Temperatures","title":"Waste Heat Allocation","text":"sys_wasteheat = WasteHeatAllocation()\n\nvars = unknowns(sys_wasteheat)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_wasteheat)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Adjusted-Layer-Thickness","page":"Roof, Wall, Road, Snow Temperatures","title":"Adjusted Layer Thickness","text":"sys_alt = AdjustedLayerThickness()\n\nvars = unknowns(sys_alt)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_alt)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Heating/Cooling-Flux","page":"Roof, Wall, Road, Snow Temperatures","title":"Heating/Cooling Flux","text":"sys_hcf = HeatingCoolingFlux()\n\nvars = unknowns(sys_hcf)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_hcf)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Phase-Change-Adjustment","page":"Roof, Wall, Road, Snow Temperatures","title":"Phase Change Adjustment","text":"sys_pca = PhaseChangeAdjustment(; layer_type=:interior)\n\nvars = unknowns(sys_pca)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_pca)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Snow-Melt-Without-Layers","page":"Roof, Wall, Road, Snow Temperatures","title":"Snow Melt Without Layers","text":"sys_sml = SnowMeltNoLayers()\n\nvars = unknowns(sys_sml)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_sml)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Grid-Discretization","page":"Roof, Wall, Road, Snow Temperatures","title":"Grid Discretization","text":"sys_ug = UniformGrid(N=5)\n\nvars = unknowns(sys_ug)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_ug)\n\nsys_eg = ExponentialGrid(N=5)\n\nvars = unknowns(sys_eg)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_eg)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Freezing-Point-Depression","page":"Roof, Wall, Road, Snow Temperatures","title":"Freezing Point Depression","text":"sys_fpd = FreezingPointDepression()\n\nvars = unknowns(sys_fpd)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\nparams = parameters(sys_fpd)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape=false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)\n\neqs = equations(sys_fpd)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Snow-Soil-Blended-Heat-Capacity","page":"Roof, Wall, Road, Snow Temperatures","title":"Snow-Soil Blended Heat Capacity","text":"sys_ssbhc = SnowSoilBlendedHeatCapacity()\n\nvars = unknowns(sys_ssbhc)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_ssbhc)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Phase-Change-Energy","page":"Roof, Wall, Road, Snow Temperatures","title":"Phase Change Energy","text":"sys_lpe = LayerPhaseChangeEnergy()\n\nvars = unknowns(sys_lpe)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_lpe)\n\nsys_tpce = TotalPhaseChangeEnergy()\n\nvars = unknowns(sys_tpce)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape=false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)\n\neqs = equations(sys_tpce)","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Analysis","page":"Roof, Wall, Road, Snow Temperatures","title":"Analysis","text":"","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Soil-Thermal-Conductivity-vs-Saturation-(Eqs.-4.77–4.82)","page":"Roof, Wall, Road, Snow Temperatures","title":"Soil Thermal Conductivity vs Saturation (Eqs. 4.77–4.82)","text":"The Farouki (1981) thermal conductivity parameterization uses the Kersten number K_e to interpolate between dry (lambda_dry) and saturated (lambda_sat) conductivity. For unfrozen soil, K_e = max(log S_r + 1 0) where S_r is the degree of saturation; for frozen soil, K_e = S_r.\n\nusing OrdinaryDiffEqDefault\n\nsys = SoilThermalProperties()\ncompiled = mtkcompile(sys)\n\nfunction solve_soil(compiled, params)\n    prob = ODEProblem(compiled, params, (0.0, 1.0))\n    solve(prob)\nend\n\nfunction soil_params(compiled; pct_sand=60.0, pct_clay=20.0, θ_sat=0.4, θ_liq=0.0, T_i=293.15, w_liq=0.0, w_ice=0.0, Δz=0.5)\n    Dict(\n        compiled.pct_sand => pct_sand,\n        compiled.pct_clay => pct_clay,\n        compiled.θ_sat => θ_sat,\n        compiled.θ_liq => θ_liq,\n        compiled.T_i => T_i,\n        compiled.w_ice => w_ice,\n        compiled.w_liq => w_liq,\n        compiled.Δz => Δz,\n    )\nend\n\n# Sweep saturation for unfrozen and frozen conditions\nS_r_range = 0.01:0.01:1.0\nλ_unfrozen = Float64[]\nλ_frozen = Float64[]\nK_e_unfrozen = Float64[]\nK_e_frozen = Float64[]\n\nΔz = 0.5\nθ_sat = 0.4\nρ_liq = 1000.0\nρ_ice = 917.0\n\nfor Sr in S_r_range\n    # Unfrozen: w_liq = S_r * θ_sat * ρ_liq * Δz, θ_liq = S_r * θ_sat\n    w_liq = Sr * θ_sat * ρ_liq * Δz\n    p = soil_params(compiled; w_liq=w_liq, w_ice=0.0, θ_liq=Sr*θ_sat, T_i=293.15)\n    sol = solve_soil(compiled, p)\n    push!(λ_unfrozen, sol[compiled.λ_soil][end])\n    push!(K_e_unfrozen, sol[compiled.K_e][end])\n\n    # Frozen: w_ice = S_r * θ_sat * ρ_ice * Δz, θ_liq = 0 (all frozen)\n    w_ice = Sr * θ_sat * ρ_ice * Δz\n    p = soil_params(compiled; w_liq=0.0, w_ice=w_ice, θ_liq=0.0, T_i=263.15)\n    sol = solve_soil(compiled, p)\n    push!(λ_frozen, sol[compiled.λ_soil][end])\n    push!(K_e_frozen, sol[compiled.K_e][end])\nend\n\nusing Plots\n\np1 = plot(S_r_range, K_e_unfrozen, label=\"Unfrozen (log S_r + 1)\", linewidth=2,\n    xlabel=\"Degree of Saturation S_r\", ylabel=\"Kersten Number K_e\",\n    title=\"Kersten Number (Eq. 4.81)\", legend=:topleft)\nplot!(p1, S_r_range, K_e_frozen, label=\"Frozen (K_e = S_r)\", linewidth=2)\n\np2 = plot(S_r_range, λ_unfrozen, label=\"Unfrozen (T = 293 K)\", linewidth=2,\n    xlabel=\"Degree of Saturation S_r\", ylabel=\"λ (W m⁻¹ K⁻¹)\",\n    title=\"Soil Thermal Conductivity (Eq. 4.77)\", legend=:topleft)\nplot!(p2, S_r_range, λ_frozen, label=\"Frozen (T = 263 K)\", linewidth=2)\n\np = plot(p1, p2, layout=(2, 1), size=(700, 700))\np\n\nThe unfrozen Kersten number shows a logarithmic dependence on saturation, reaching zero around S_r approx 037 (i.e., e^-1), below which the conductivity equals lambda_dry. The frozen Kersten number is simply linear in saturation. At full saturation, the frozen conductivity exceeds the unfrozen value because ice has a higher thermal conductivity than liquid water.","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Soil-Thermal-Conductivity-by-Soil-Type","page":"Roof, Wall, Road, Snow Temperatures","title":"Soil Thermal Conductivity by Soil Type","text":"Different soil compositions (sand/clay fractions) yield different solid-phase conductivities lambda_s (Eq. 4.79) and saturated conductivities lambda_sat (Eq. 4.78). Sandy soils conduct heat more efficiently than clay soils.\n\nsoil_types = [\n    (\"Sand (90/5)\", 90.0, 5.0),\n    (\"Sandy loam (60/15)\", 60.0, 15.0),\n    (\"Loam (40/25)\", 40.0, 25.0),\n    (\"Clay loam (30/35)\", 30.0, 35.0),\n    (\"Clay (10/50)\", 10.0, 50.0),\n]\n\nS_r_range_soils = 0.01:0.02:1.0\np = plot(xlabel=\"Degree of Saturation S_r\", ylabel=\"λ (W m⁻¹ K⁻¹)\",\n    title=\"Soil Conductivity by Type (Eqs. 4.77-4.80)\", legend=:topleft)\n\nfor (name, sand, clay) in soil_types\n    vals = Float64[]\n    for Sr in S_r_range_soils\n        w_liq = Sr * 0.4 * 1000.0 * 0.5\n        pr = soil_params(compiled; pct_sand=sand, pct_clay=clay, w_liq=w_liq, θ_liq=Sr*0.4)\n        sol = solve_soil(compiled, pr)\n        push!(vals, sol[compiled.λ_soil][end])\n    end\n    plot!(p, S_r_range_soils, vals, label=name, linewidth=2)\nend\np","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Snow-Thermal-Conductivity-vs-Density-(Eq.-4.83)","page":"Roof, Wall, Road, Snow Temperatures","title":"Snow Thermal Conductivity vs Density (Eq. 4.83)","text":"Snow thermal conductivity follows the Jordan (1991) parameterization, which is a quadratic function of snow bulk density rho_sno (Eq. 4.83). As snow compacts, the increased contact area between ice grains raises the effective conductivity from near-air values (fresh snow) towards ice-like values (dense glacial ice).\n\nsys_sn = SnowThermalProperties()\ncompiled_sn = mtkcompile(sys_sn)\n\nρ_range = 50.0:10.0:700.0\nλ_vals = Float64[]\nc_vals = Float64[]\nΔz_sn = 0.2\n\nfor ρ in ρ_range\n    w_ice = ρ * Δz_sn\n    p = Dict(compiled_sn.w_ice => w_ice, compiled_sn.w_liq => 0.0, compiled_sn.Δz => Δz_sn)\n    prob = ODEProblem(compiled_sn, p, (0.0, 1.0))\n    sol = solve(prob)\n    push!(λ_vals, sol[compiled_sn.λ_snow][end])\n    push!(c_vals, sol[compiled_sn.c_snow][end])\nend\n\np1 = plot(ρ_range, λ_vals, linewidth=2, label=\"λ_snow (Jordan 1991)\",\n    xlabel=\"Snow Density (kg m⁻³)\", ylabel=\"λ (W m⁻¹ K⁻¹)\",\n    title=\"Snow Thermal Conductivity (Eq. 4.83)\", legend=:topleft)\nhline!(p1, [0.023], label=\"λ_air\", linestyle=:dash, color=:gray)\nhline!(p1, [2.29], label=\"λ_ice\", linestyle=:dash, color=:blue)\n\np2 = plot(ρ_range, c_vals ./ 1e6, linewidth=2, label=\"c_snow\",\n    xlabel=\"Snow Density (kg m⁻³)\", ylabel=\"c (MJ m⁻³ K⁻¹)\",\n    title=\"Snow Heat Capacity (Eq. 4.87)\", legend=:topleft, color=:red)\n\np = plot(p1, p2, layout=(2, 1), size=(700, 700))\np\n\nFresh snow (rho approx 50 kg m⁻³) has a conductivity only slightly above air, making it an effective insulator. As snow compacts beyond 400 kg m⁻³, the quadratic term dominates and conductivity increases rapidly. The heat capacity scales linearly with density since it depends on the mass of ice per unit volume.","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Interface-Thermal-Conductivity-(Eq.-4.12)","page":"Roof, Wall, Road, Snow Temperatures","title":"Interface Thermal Conductivity (Eq. 4.12)","text":"The interface thermal conductivity is a harmonic mean weighted by the distances from each node to the interface. When the interface is at the midpoint, this reduces to the standard harmonic mean of the two layer conductivities.\n\nsys_itc = InterfaceThermalConductivity()\ncompiled_itc = mtkcompile(sys_itc)\n\nλ_2_range = 0.1:0.1:10.0\nλ_int_midpoint = Float64[]\nλ_int_offset = Float64[]\n\nfor λ2 in λ_2_range\n    # Midpoint interface\n    p = Dict(compiled_itc.λ_i => 1.0, compiled_itc.λ_ip1 => λ2,\n        compiled_itc.z_i => 0.0, compiled_itc.z_ip1 => 1.0, compiled_itc.z_h => 0.5)\n    prob = ODEProblem(compiled_itc, p, (0.0, 1.0))\n    sol = solve(prob)\n    push!(λ_int_midpoint, sol[compiled_itc.λ_interface][end])\n\n    # Interface at 1/4 point\n    p2 = Dict(compiled_itc.λ_i => 1.0, compiled_itc.λ_ip1 => λ2,\n        compiled_itc.z_i => 0.0, compiled_itc.z_ip1 => 1.0, compiled_itc.z_h => 0.25)\n    prob2 = ODEProblem(compiled_itc, p2, (0.0, 1.0))\n    sol2 = solve(prob2)\n    push!(λ_int_offset, sol2[compiled_itc.λ_interface][end])\nend\n\np = plot(λ_2_range, λ_int_midpoint, label=\"Midpoint (z_h = 0.5)\", linewidth=2,\n    xlabel=\"λ₂ (W m⁻¹ K⁻¹)\", ylabel=\"λ_interface (W m⁻¹ K⁻¹)\",\n    title=\"Interface Conductivity (Eq. 4.12), λ₁ = 1\", legend=:topleft)\nplot!(p, λ_2_range, λ_int_offset, label=\"Offset (z_h = 0.25)\", linewidth=2)\nplot!(p, λ_2_range, λ_2_range, label=\"Arithmetic mean\", linestyle=:dash, color=:gray)\nplot!(p, λ_2_range, 2 .* λ_2_range ./ (1 .+ λ_2_range), label=\"Harmonic mean\", linestyle=:dot, color=:red)\np\n\nThe interface conductivity always lies below the arithmetic mean, reflecting the physical principle that heat flow is limited by the less conductive layer. When the interface is closer to layer 1 (offset case), the result is weighted more heavily toward lambda_1.","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Building-Temperature-(Eqs.-4.37–4.38)","page":"Roof, Wall, Road, Snow Temperatures","title":"Building Temperature (Eqs. 4.37–4.38)","text":"The internal building temperature is a weighted average of the inner wall and roof temperatures, with weights proportional to the surface areas exposed to the building interior. The roof contribution depends on the roof fraction W_roof and the canyon height-to-width ratio.\n\nsys_bt = BuildingTemperature()\ncompiled_bt = mtkcompile(sys_bt)\n\nW_roof_range = 0.1:0.02:0.9\nT_iB_vals = Float64[]\n\nfor wr in W_roof_range\n    p = Dict(\n        compiled_bt.H_canyon => 10.0, compiled_bt.H_W => 1.0, compiled_bt.W_roof => wr,\n        compiled_bt.T_inner_shdwall => 293.0, compiled_bt.T_inner_sunwall => 295.0,\n        compiled_bt.T_inner_roof => 290.0,\n    )\n    prob = ODEProblem(compiled_bt, p, (0.0, 1.0))\n    sol = solve(prob)\n    push!(T_iB_vals, sol[compiled_bt.T_iB_unclamped][end])\nend\n\np = plot(W_roof_range, T_iB_vals, linewidth=2, label=\"T_iB\",\n    xlabel=\"Roof Fraction W_roof\", ylabel=\"Building Temperature (K)\",\n    title=\"Internal Building Temperature (Eqs. 4.37-4.38)\", legend=:topright)\nhline!(p, [293.0], label=\"T_shdwall\", linestyle=:dash, color=:blue)\nhline!(p, [295.0], label=\"T_sunwall\", linestyle=:dash, color=:red)\nhline!(p, [290.0], label=\"T_roof\", linestyle=:dash, color=:green)\np\n\nAs the roof fraction increases, the building temperature shifts from the wall-dominated average towards the roof temperature. At small roof fractions, the two wall surfaces dominate and T_iB lies between T_sunwall and T_shdwall.","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Grid-Discretization-(Eqs.-4.5–4.8)","page":"Roof, Wall, Road, Snow Temperatures","title":"Grid Discretization (Eqs. 4.5–4.8)","text":"Roofs and walls use a uniform grid (Eq. 4.5) while roads use an exponential grid (Eq. 4.8) that provides finer resolution near the surface. The exponential scaling factor f_s = 0025 m concentrates layers where the diurnal thermal wave has the largest amplitude.\n\nusing OrdinaryDiffEqDefault\n\nN = 10\nsys_ug = UniformGrid(N=N)\ncompiled_ug = mtkcompile(sys_ug)\nprob_ug = ODEProblem(compiled_ug, [compiled_ug.Δz_total => 0.5], (0.0, 1.0))\nsol_ug = solve(prob_ug)\n\nsys_eg = ExponentialGrid(N=N)\ncompiled_eg = mtkcompile(sys_eg)\nprob_eg = ODEProblem(compiled_eg, [], (0.0, 1.0))\nsol_eg = solve(prob_eg)\n\nobs_ug = Dict(string(o.lhs) => o.lhs for o in observed(compiled_ug))\nobs_eg = Dict(string(o.lhs) => o.lhs for o in observed(compiled_eg))\n\nz_uniform = [sol_ug[obs_ug[\"z_node[$i](t)\"]][end] for i in 1:N]\nz_exp = [sol_eg[obs_eg[\"z_node[$i](t)\"]][end] for i in 1:N]\n\np = plot(1:N, z_uniform, marker=:circle, label=\"Uniform (roof/wall)\", linewidth=2,\n    xlabel=\"Layer Index\", ylabel=\"Node Depth (m)\",\n    title=\"Grid Node Depths (Eqs. 4.5, 4.8)\", legend=:topleft)\nplot!(p, 1:N, z_exp, marker=:square, label=\"Exponential (road)\", linewidth=2)\np\n\nThe uniform grid spaces nodes equally, while the exponential grid clusters nodes near the surface (small indices) and spaces them progressively farther apart at depth, providing better resolution where surface forcing varies most.","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Freezing-Point-Depression-(Eq.-4.58)","page":"Roof, Wall, Road, Snow Temperatures","title":"Freezing Point Depression (Eq. 4.58)","text":"Below the freezing point, liquid water coexists with ice in soil through a freezing point depression mechanism. The maximum liquid water content decreases with temperature according to the matric potential relationship.\n\nsys_fpd = FreezingPointDepression()\ncompiled_fpd = mtkcompile(sys_fpd)\n\nT_range = 253.15:0.5:273.15\nw_liq_vals = Float64[]\n\nfor T in T_range\n    p = Dict(\n        compiled_fpd.T_i => T,\n        compiled_fpd.θ_sat => 0.4,\n        compiled_fpd.Δz => 0.5,\n        compiled_fpd.ψ_sat => -0.1,\n        compiled_fpd.B_i => 5.0,\n        compiled_fpd.ρ_liq => 1000.0,\n    )\n    prob = ODEProblem(compiled_fpd, p, (0.0, 1.0))\n    sol = solve(prob)\n    push!(w_liq_vals, sol[compiled_fpd.w_liq_max][end])\nend\n\np = plot(T_range .- 273.15, w_liq_vals, linewidth=2, label=\"w_liq_max\",\n    xlabel=\"Temperature (°C)\", ylabel=\"Max Liquid Water (kg m⁻²)\",\n    title=\"Freezing Point Depression (Eq. 4.58)\", legend=:topleft)\nvline!(p, [0.0], label=\"T_f\", linestyle=:dash, color=:gray)\np\n\nAt the freezing point (0°C), the maximum liquid water equals the fully saturated value Delta z cdot theta_sat cdot rho_liq. As temperature decreases below freezing, the available liquid water decreases rapidly following the Clapp and Hornberger (1978) relationship.","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Roof/Wall-Heat-Conduction-(Eq.-4.4)","page":"Roof, Wall, Road, Snow Temperatures","title":"Roof/Wall Heat Conduction (Eq. 4.4)","text":"The 1D heat equation for roof and wall surfaces is discretized using MethodOfLines.jl. The following example demonstrates the steady-state temperature profile with a constant surface heat flux of 50 W/m² at the top and a fixed building temperature of 290 K at the bottom.\n\nAt steady state (partial T  partial t = 0), the heat equation reduces to d^2Tdz^2 = 0, giving a linear temperature profile T(z) = T_iB + h(L-z)lambda.\n\nusing MethodOfLines, DomainSets\n\nL = 0.3\nλ_val = 1.5\nh_val = 50.0\nT_iB = 290.0\n\nresult = RoofWallHeatConduction(;\n    Δz_total = L, N_layers = 30,\n    λ_val = λ_val, c_val = 2.0e6,\n    h_top = h_val, T_bottom = T_iB,\n)\n\n# Solve for long time to reach steady state\nprob2 = remake(result.prob; tspan = (0.0, 100000.0))\nsol = solve(prob2)\n\nT_mat = sol[result.T(result.t_pde, result.z_var)]\nz_disc = sol[result.z_var]\nT_final = T_mat[end, :]\n\n# Analytical solution\nz_analytical = range(0, L, length=100)\nT_analytical = T_iB .+ h_val .* (L .- z_analytical) ./ λ_val\n\np = plot(z_analytical, T_analytical, label=\"Analytical\", linewidth=2, linestyle=:dash,\n    xlabel=\"Depth z (m)\", ylabel=\"Temperature (K)\",\n    title=\"Roof/Wall Steady-State Temperature Profile\", legend=:topright)\nscatter!(p, z_disc, T_final, label=\"MethodOfLines\", markersize=4)\np","category":"section"},{"location":"roof_wall_road_snow_temperatures/#Road-Heat-Conduction-with-Zero-Flux-Bottom-(Eq.-4.4)","page":"Roof, Wall, Road, Snow Temperatures","title":"Road Heat Conduction with Zero-Flux Bottom (Eq. 4.4)","text":"Road surfaces use the same heat equation but with a zero heat flux (insulated) boundary condition at the bottom. With zero flux at both boundaries, the temperature remains uniform at its initial value, demonstrating energy conservation.\n\nT_init = 288.15\nresult_road = RoadHeatConduction(;\n    N_layers = 15,\n    λ_val = 1.5, c_val = 2.0e6,\n    h_top = 0.0, T_init_val = T_init,\n)\n\nsol_road = solve(result_road.prob, saveat = 0.1)\nT_mat_road = sol_road[result_road.T(result_road.t_pde, result_road.z_var)]\n\nt_disc = sol_road[result_road.t_pde]\navg_T = [mean(T_mat_road[i, :]) for i in 1:length(t_disc)]\n\nusing Statistics\np = plot(t_disc, avg_T, linewidth=2, label=\"Mean temperature\",\n    xlabel=\"Time (s)\", ylabel=\"Temperature (K)\",\n    title=\"Road Energy Conservation (zero flux BCs)\", legend=:topright)\nhline!(p, [T_init], label=\"Initial T\", linestyle=:dash, color=:red)\np\n\nWith insulated (zero-flux) boundary conditions on both sides, the average temperature remains constant, confirming energy conservation in the discretized system.","category":"section"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.SnowLayerGeometry","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.SnowLayerGeometry","text":"SnowLayerGeometry(; name=:SnowLayerGeometry)\n\nComputes the snow layer structure for a given snow depth, following Section 4.1 of Oleson et al. (2010). The snow pack has up to 5 layers, with thickness assignments depending on the total snow depth z_sno (pp. 92–93).\n\nThis component takes the total snow depth and number of snow layers as inputs and computes the layer thicknesses, node depths, and interface depths (Eqs. 4.9–4.10).\n\nNote: The actual number of snow layers (snl) is determined by the snow depth according to the rules on pp. 92–93. This component computes geometry for a single snow layer (the simplest case), since multi-layer snow packing logic is procedural and typically handled outside the equation system.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, pp. 92–93.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.SoilThermalProperties","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.SoilThermalProperties","text":"SoilThermalProperties(; name=:SoilThermalProperties)\n\nComputes the thermal conductivity and volumetric heat capacity for soil layers used in pervious road columns, following Section 4.3 of Oleson et al. (2010).\n\nThermal conductivity follows Farouki (1981) using the Kersten number method (Eqs. 4.77–4.82). Volumetric heat capacity follows de Vries (1963) (Eqs. 4.85–4.86).\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.3, pp. 107–108.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.SnowThermalProperties","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.SnowThermalProperties","text":"SnowThermalProperties(; name=:SnowThermalProperties)\n\nComputes the thermal conductivity and volumetric heat capacity for snow layers, following Section 4.3 of Oleson et al. (2010).\n\nThermal conductivity follows Jordan (1991) (Eq. 4.83). Volumetric heat capacity depends on the ice and liquid water content (Eq. 4.87).\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.3, pp. 108–109.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.UrbanSurfaceThermalProperties","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.UrbanSurfaceThermalProperties","text":"UrbanSurfaceThermalProperties(; name=:UrbanSurfaceThermalProperties)\n\nRepresents the prescribed thermal conductivity and heat capacity for roof, wall, and impervious road layers, following Section 4.3 of Oleson et al. (2010).\n\nFor roofs, walls, and impervious road layers (i = 1, ..., N_imprvrd), the thermal conductivity and heat capacity are specified by the surface dataset (Table 1.3). This component takes those prescribed values as parameters.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.3, pp. 106.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.InterfaceThermalConductivity","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.InterfaceThermalConductivity","text":"InterfaceThermalConductivity(; name=:InterfaceThermalConductivity)\n\nComputes the thermal conductivity at the interface between two adjacent layers using the harmonic mean formula (Eq. 4.12) from Section 4.1 of Oleson et al. (2010).\n\nThe interface conductivity is derived from continuity of heat flux at the interface (Eq. 4.13), resulting in a weighted harmonic mean of the two adjacent layer conductivities.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, Eq. 4.12, pp. 94.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.HeatFlux","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.HeatFlux","text":"HeatFlux(; name=:HeatFlux)\n\nComputes the heat flux from layer i to layer i+1 using Fourier's law discretized across the interface (Eq. 4.11) from Section 4.1 of Oleson et al. (2010).\n\nThe flux is defined as positive upwards: Fi = -λ[z{h,i}] * (Ti - T{i+1}) / (z{i+1} - zi).\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, Eq. 4.11, pp. 94.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.SurfaceEnergyFlux","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.SurfaceEnergyFlux","text":"SurfaceEnergyFlux(; name=:SurfaceEnergyFlux)\n\nComputes the net heat flux into each urban surface and its derivative with respect to surface temperature, following Eqs. 4.26, 4.28, and 4.29 of Oleson et al. (2010).\n\nThe surface heat flux h is the sum of absorbed solar radiation, net longwave radiation, sensible and latent heat fluxes, and waste heat / air conditioning terms. The derivative ∂h/∂T is used in the linearized Crank-Nicholson scheme (Eq. 4.19).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.26–4.29, pp. 97–98.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.BuildingTemperature","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.BuildingTemperature","text":"BuildingTemperature(; name=:BuildingTemperature)\n\nComputes the internal building temperature from a weighted combination of inner layer wall and roof temperatures, following Eqs. 4.37–4.38 of Oleson et al. (2010).\n\nThe building temperature T{iB} is constrained between prescribed minimum and maximum values (T{iB,min} and T_{iB,max}).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.37–4.38, pp. 99.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.WasteHeatAirConditioning","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.WasteHeatAirConditioning","text":"WasteHeatAirConditioning(; name=:WasteHeatAirConditioning)\n\nComputes waste heat from space heating/air conditioning and heat removed by air conditioning, following Eqs. 4.55–4.56 of Oleson et al. (2010).\n\nWaste heat is distributed to the pervious and impervious road surfaces. Air conditioning heat removal equals the cooling flux (Eq. 4.56).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.51–4.56, pp. 101–102.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.WasteHeatAllocation","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.WasteHeatAllocation","text":"WasteHeatAllocation(; name=:WasteHeatAllocation)\n\nAllocates total waste heat and air conditioning heat to individual urban surfaces, following Eq. 4.27 of Oleson et al. (2010).\n\nWaste heat and air conditioning are applied ONLY to the pervious and impervious road surfaces (divided by 1 - W_roof). Walls and roof receive zero waste heat and zero air conditioning.\n\nReference: Oleson et al. (2010), Chapter 4, Eq. 4.27, pp. 97.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.AdjustedLayerThickness","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.AdjustedLayerThickness","text":"AdjustedLayerThickness(; name=:AdjustedLayerThickness)\n\nComputes the adjusted top layer thickness for pervious and impervious road surfaces, following Eq. 4.30 of Oleson et al. (2010).\n\nThe adjustment uses a tunable parameter c_a = 0.34 to compensate for the difference between layer-averaged and surface temperature in the numerical scheme.\n\nReference: Oleson et al. (2010), Chapter 4, Eq. 4.30, pp. 98.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.HeatingCoolingFlux","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.HeatingCoolingFlux","text":"HeatingCoolingFlux(; name=:HeatingCoolingFlux)\n\nComputes the heating and cooling fluxes applied to roofs, sunlit walls, and shaded walls, following Eqs. 4.51–4.54 of Oleson et al. (2010).\n\nHeating is applied when the internal building temperature T_iB falls below the prescribed minimum T_{iB,min}. Cooling is applied when T_iB exceeds the prescribed maximum T_{iB,max}.\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.51–4.54, pp. 101.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.PhaseChangeEnergy","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.PhaseChangeEnergy","text":"PhaseChangeEnergy(; name=:PhaseChangeEnergy)\n\nComputes the energy excess or deficit for phase change assessment in a layer, following Eq. 4.59 of Oleson et al. (2010).\n\nFor the top layer (i = snl+1), the energy includes the surface heat flux and its derivative. For interior layers (i > snl+1), only the heat fluxes and thermal storage are included.\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.59–4.65, pp. 103–104.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.PhaseChangeAdjustment","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.PhaseChangeAdjustment","text":"PhaseChangeAdjustment(; name=:PhaseChangeAdjustment)\n\nPerforms the ice/liquid water mass adjustment and temperature correction after phase change, following Eqs. 4.60–4.65 of Oleson et al. (2010).\n\nGiven the excess/deficit energy H_i from Eq. 4.59, this component computes the melt/freeze amount H_m, adjusts ice mass, conserves liquid water, computes residual energy H_{i*}, and corrects the temperature.\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.60–4.65, pp. 103–104.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.SnowMeltNoLayers","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.SnowMeltNoLayers","text":"SnowMeltNoLayers(; name=:SnowMeltNoLayers)\n\nHandles the special case of snow melt when snow is present (W_sno > 0) but there are no explicit snow layers (snl = 0), following Eqs. 4.66–4.71 of Oleson et al. (2010).\n\nWhen the snow mass is too small for explicit snow layers, snow melt is computed from the excess energy in the top soil layer. Snow mass and depth are reduced proportionally.\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.66–4.71, pp. 105.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.UniformGrid","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.UniformGrid","text":"UniformGrid(; name=:UniformGrid, N=15)\n\nComputes the uniform grid discretization for roofs and walls, following Eqs. 4.5–4.7 of Oleson et al. (2010). Roofs and walls are discretized into N layers of equal thickness, with node depths at layer midpoints and interface depths between layers.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, Eqs. 4.5–4.7, pp. 91.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.ExponentialGrid","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.ExponentialGrid","text":"ExponentialGrid(; name=:ExponentialGrid, N=15)\n\nComputes the exponential grid discretization for pervious and impervious road columns, following Eq. 4.8 and Eqs. 4.6–4.7 of Oleson et al. (2010). The scaling factor f_s = 0.025 produces finer resolution near the surface, which is needed because roads overlie real soil.\n\nLayer thicknesses and interface depths are computed from Eqs. 4.6 and 4.7.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.1, Eqs. 4.6–4.8, pp. 91–92.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.FreezingPointDepression","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.FreezingPointDepression","text":"FreezingPointDepression(; name=:FreezingPointDepression)\n\nComputes the maximum liquid water content in a soil layer when the temperature is below the freezing point, following Eq. 4.58 of Oleson et al. (2010).\n\nThe concept of supercooled soil water from Niu and Yang (2006) is used, where liquid water coexists with ice below freezing through a freezing point depression equation.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.2, Eq. 4.58, pp. 103.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.SnowSoilBlendedHeatCapacity","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.SnowSoilBlendedHeatCapacity","text":"SnowSoilBlendedHeatCapacity(; name=:SnowSoilBlendedHeatCapacity)\n\nComputes the blended heat capacity of the top soil layer when snow is present but there are no explicit snow layers (snl = 0), following Eq. 4.88 of Oleson et al. (2010).\n\nThe heat capacity is the soil heat capacity (from Eq. 4.85) plus an additional term from the snow mass distributed over the top layer.\n\nReference: Oleson et al. (2010), Chapter 4, Section 4.3, Eq. 4.88, pp. 109.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.LayerPhaseChangeEnergy","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.LayerPhaseChangeEnergy","text":"LayerPhaseChangeEnergy(; name=:LayerPhaseChangeEnergy)\n\nComputes the phase change energy for a single layer, following Eq. 4.73 of Oleson et al. (2010). This is used to sum contributions across all layers to obtain the total phase change energy (Eq. 4.72).\n\nReference: Oleson et al. (2010), Chapter 4, Eq. 4.73, pp. 106.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.TotalPhaseChangeEnergy","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.TotalPhaseChangeEnergy","text":"TotalPhaseChangeEnergy(; name=:TotalPhaseChangeEnergy)\n\nComputes the total phase change energy for the column, following Eq. 4.72 of Oleson et al. (2010). The total is the sum of the surface snow melt energy (Eq. 4.71) and the per-layer phase change energies (Eq. 4.73).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.72–4.73, pp. 105–106.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.RoofWallHeatConduction","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.RoofWallHeatConduction","text":"RoofWallHeatConduction(; name=:RoofWallHeatConduction)\n\nImplements the 1D heat conduction equation (Eq. 4.4) for roof and wall surfaces using MethodOfLines.jl for automatic spatial discretization.\n\nThe governing PDE is:     c ∂T/∂t = ∂/∂z [λ ∂T/∂z]\n\nFor roofs and walls, the domain is a uniform grid of total thickness Δz_total (Eq. 4.5). The boundary conditions are:\n\nTop (z=0): Neumann BC with surface heat flux h (Eq. 4.26)\nBottom (z=Δztotal): Dirichlet BC with building temperature TiB (Eq. 4.37)\n\nThe thermal conductivity λ and volumetric heat capacity c are prescribed parameters for each layer (from Table 1.3).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.1–4.4, pp. 90–91.\n\n\n\n\n\n","category":"function"},{"location":"roof_wall_road_snow_temperatures/#UrbanCanopy.RoadHeatConduction","page":"Roof, Wall, Road, Snow Temperatures","title":"UrbanCanopy.RoadHeatConduction","text":"RoadHeatConduction(; name=:RoadHeatConduction)\n\nImplements the 1D heat conduction equation (Eq. 4.4) for pervious and impervious road surfaces using MethodOfLines.jl for automatic spatial discretization.\n\nFor roads, the domain uses exponential spacing (Eq. 4.8) with the total depth determined by the scaling factor f_s = 0.025 m. The boundary conditions are:\n\nTop (z=0): Neumann BC with surface heat flux h (Eq. 4.26)\nBottom (z=z_max): Zero heat flux (Neumann BC, ∂T/∂z = 0)\n\nThe thermal conductivity and heat capacity can vary with depth (e.g., impervious layers vs soil layers).\n\nReference: Oleson et al. (2010), Chapter 4, Eqs. 4.1–4.4, 4.8, pp. 90–92.\n\n\n\n\n\n","category":"function"},{"location":"clmu_introduction/#CLMU-Introduction:-Atmospheric-Interface","page":"CLMU Introduction","title":"CLMU Introduction: Atmospheric Interface","text":"","category":"section"},{"location":"clmu_introduction/#Overview","page":"CLMU Introduction","title":"Overview","text":"The Community Land Model Urban (CLMU) parameterization provides a physically-based representation of urban surfaces for use within the Community Land Model (CLM4). Chapter 1 of the technical note introduces the model structure and defines the atmospheric interface: the forcing variables provided by the atmospheric model, the diagnostic equations for air density and vapor pressure, and the reference height computation.\n\nThe urban surface is represented using the canyon concept (Oke, 1987), where the considerable complexity of the urban surface is reduced to a single urban canyon consisting of a canyon floor of width W bordered by two facing buildings of height H. The urban canyon is divided into five columns: roof, sunlit wall, shaded wall, pervious road, and impervious road.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.","category":"section"},{"location":"clmu_introduction/#Implementation","page":"CLMU Introduction","title":"Implementation","text":"The CLMUAtmosphere component implements three diagnostic equations from Chapter 1:\n\nAtmospheric vapor pressure from specific humidity and pressure\nAir density from pressure, vapor pressure, and temperature\nReference height for flux computations","category":"section"},{"location":"clmu_introduction/#State-Variables","page":"CLMU Introduction","title":"State Variables","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing UrbanCanopy\n\nsys = CLMUAtmosphere()\n\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"clmu_introduction/#Parameters","page":"CLMU Introduction","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"clmu_introduction/#Equations","page":"CLMU Introduction","title":"Equations","text":"eqs = equations(sys)","category":"section"},{"location":"clmu_introduction/#Table-1.1:-Atmospheric-Input-to-Urban-Model","page":"CLMU Introduction","title":"Table 1.1: Atmospheric Input to Urban Model","text":"The atmospheric model provides the following forcing variables to the urban model at each time step (Table 1.1, p. 16). The reference height z_atm is the height above the surface defined as the roughness length z_0 plus displacement height z_d, so the reference height used for flux computations is z_atm = z_atm + z_0 + z_d.\n\nVariable Symbol Units\nReference height z_atm m\nZonal wind at z_atm u_atm m/s\nMeridional wind at z_atm v_atm m/s\nPotential temperature theta_atm K\nSpecific humidity at z_atm q_atm kg/kg\nPressure at z_atm P_atm Pa\nTemperature at z_atm T_atm K\nIncident longwave radiation L_atmdownarrow W/m²\nLiquid precipitation q_rain kg/(m²·s)\nSolid precipitation q_sno kg/(m²·s)\nDirect beam visible solar radiation S_atmdownarrow^mu_vis W/m²\nDirect beam near-infrared solar radiation S_atmdownarrow^mu_nir W/m²\nDiffuse visible solar radiation S_atmdownarrow_vis W/m²\nDiffuse near-infrared solar radiation S_atmdownarrow_nir W/m²\nCarbon dioxide (CO₂) concentration c_a ppmv\nAerosol deposition rate D_sp kg/(m²·s)\nNitrogen deposition rate NF_ndep_sminn g(N)/(m²·yr)\n\nNote: CO₂ concentration, aerosol deposition rate, and nitrogen deposition rate are provided by the atmospheric model but not used by the urban model.","category":"section"},{"location":"clmu_introduction/#Table-1.2:-Urban-Model-Output-to-Atmospheric-Model","page":"CLMU Introduction","title":"Table 1.2: Urban Model Output to Atmospheric Model","text":"The urban model provides the following area-averaged fluxes to the atmospheric model (Table 1.2, p. 18).\n\nVariable Symbol Units\nLatent heat flux lambda E W/m²\nSensible heat flux H W/m²\nWater vapor flux E mm/s\nZonal momentum flux tau_x kg/(m·s²)\nMeridional momentum flux tau_y kg/(m·s²)\nEmitted longwave radiation Luparrow W/m²\nDirect beam visible albedo Iuparrow^mu_vis -\nDirect beam near-infrared albedo Iuparrow^mu_nir -\nDiffuse visible albedo Iuparrow_vis -\nDiffuse near-infrared albedo Iuparrow_nir -\nAbsorbed solar radiation vecS W/m²\nRadiative temperature T_rad K\nTemperature at 2 meter height T_2m K\nSpecific humidity at 2 meter height q_2m kg/kg\nSnow water equivalent W_sno m\nAerodynamic resistance r_am s/m\nFriction velocity u_* m/s\nDust flux F_j kg/(m²·s)\nNet ecosystem exchange NEE kgCO₂/(m²·s)\n\nNote: lambda is either the latent heat of vaporization lambda_vap or latent heat of sublimation lambda_sub (Table 1.4) depending on the thermal state of surface water on the roof, pervious and impervious road. Dust flux and net ecosystem exchange are set to zero for urban areas.","category":"section"},{"location":"clmu_introduction/#Table-1.3:-Input-Data-Required-for-the-Urban-Model","page":"CLMU Introduction","title":"Table 1.3: Input Data Required for the Urban Model","text":"Required input data for urban landunits are listed in Table 1.3 (p. 23). This data is provided by the surface dataset at the required spatial resolution.\n\nData Symbol Units\nPercent urban - %\nCanyon height to width ratio HW -\nRoof fraction W_roof -\nPervious road fraction f_prvrd -\nEmissivity of roof varepsilon_roof -\nEmissivity of impervious road varepsilon_imprvrd -\nEmissivity of pervious road varepsilon_prvrd -\nEmissivity of walls varepsilon_wall -\nBuilding height H m\nRoof albedo (visible direct/diffuse, near-infrared direct/diffuse) alpha_roof -\nWall albedo (visible direct/diffuse, near-infrared direct/diffuse) alpha_walls -\nImpervious road albedo (visible direct/diffuse, near-infrared direct/diffuse) alpha_imprvrd -\nPervious road albedo (visible direct/diffuse, near-infrared direct/diffuse) alpha_prvrd -\nRoof thermal conductivity lambda_roofi W/(m·K)\nWall thermal conductivity lambda_walli W/(m·K)\nImpervious road thermal conductivity lambda_imprvrdi W/(m·K)\nPervious road thermal conductivity lambda_prvrdi W/(m·K)\nRoof volumetric heat capacity c_roofi J/(m³·K)\nWall volumetric heat capacity c_walli J/(m³·K)\nImpervious road volumetric heat capacity c_imprvrdi J/(m³·K)\nPervious road volumetric heat capacity c_prvrdi J/(m³·K)\nMaximum interior building temperature T_iBmax K\nMinimum interior building temperature T_iBmin K\nHeight of wind source in canyon H_w m\nNumber of impervious road layers N_imprvrd -\nWall thickness Delta z_wall m\nRoof thickness Delta z_roof m\nPercent sand, percent clay of pervious road (soil) %sand, %clay %\nGrid cell latitude and longitude phi theta degrees","category":"section"},{"location":"clmu_introduction/#Table-1.4:-Physical-Constants","page":"CLMU Introduction","title":"Table 1.4: Physical Constants","text":"Physical constants used by the CLMU, shared by all components of CCSM (Table 1.4, p. 25).\n\nConstant Symbol Value Units\nPi pi 3.14159265358979323846 -\nAcceleration of gravity g 9.80616 m/s²\nStandard pressure P_std 101325 Pa\nStefan-Boltzmann constant sigma 5.67 × 10⁻⁸ W/(m²·K⁴)\nBoltzmann constant kappa 1.38065 × 10⁻²³ J/K\nAvogadro's number N_A 6.02214 × 10²⁶ molecule/kmol\nUniversal gas constant R_gas N_A kappa J/(K·kmol)\nMolecular weight of dry air MW_da 28.966 kg/kmol\nDry air gas constant R_da R_gasMW_da J/(K·kg)\nMolecular weight of water vapor MW_wv 18.016 kg/kmol\nWater vapor gas constant R_wv R_gasMW_wv J/(K·kg)\nVon Karman constant k 0.4 -\nFreezing temperature of fresh water T_f 273.15 K\nDensity of liquid water rho_liq 1000 kg/m³\nDensity of ice rho_ice 917 kg/m³\nSpecific heat capacity of dry air C_p 1.00464 × 10³ J/(kg·K)\nSpecific heat capacity of water C_liq 4.188 × 10³ J/(kg·K)\nSpecific heat capacity of ice C_ice 2.11727 × 10³ J/(kg·K)\nLatent heat of vaporization lambda_vap 2.501 × 10⁶ J/kg\nLatent heat of fusion L_f 3.337 × 10⁵ J/kg\nLatent heat of sublimation lambda_sub lambda_vap + L_f J/kg\nThermal conductivity of water lambda_liq 0.6 W/(m·K)\nThermal conductivity of ice lambda_ice 2.29 W/(m·K)\nThermal conductivity of air lambda_air 0.023 W/(m·K)\nRadius of the earth R_e 6.37122 × 10⁶ m","category":"section"},{"location":"clmu_introduction/#Analysis","page":"CLMU Introduction","title":"Analysis","text":"","category":"section"},{"location":"clmu_introduction/#Air-Density-vs.-Temperature","page":"CLMU Introduction","title":"Air Density vs. Temperature","text":"The air density equation from Chapter 1 (p. 17) computes atmospheric density as a function of pressure, temperature, and vapor pressure. For dry air, this reduces to the ideal gas law: rho = P  (R_da T). The following figure shows how air density varies with temperature at standard pressure for both dry and moist air.\n\nusing OrdinaryDiffEqDefault\nusing Plots\n\ncompiled = mtkcompile(sys)\n\nT_range = 250.0:5.0:320.0\nρ_dry = Float64[]\nρ_moist = Float64[]\n\nfor T_val in T_range\n    prob = ODEProblem(\n        compiled,\n        Dict(\n            compiled.q_atm => 0.0,\n            compiled.P_atm => 101325.0,\n            compiled.T_atm => T_val,\n            compiled.z_prime_atm => 30.0,\n            compiled.z_0 => 1.0,\n            compiled.z_d => 5.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol = solve(prob)\n    push!(ρ_dry, sol[compiled.ρ_atm][end])\n\n    prob_m = ODEProblem(\n        compiled,\n        Dict(\n            compiled.q_atm => 0.015,\n            compiled.P_atm => 101325.0,\n            compiled.T_atm => T_val,\n            compiled.z_prime_atm => 30.0,\n            compiled.z_0 => 1.0,\n            compiled.z_d => 5.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol_m = solve(prob_m)\n    push!(ρ_moist, sol_m[compiled.ρ_atm][end])\nend\n\np = plot(T_range, ρ_dry, label=\"Dry air (q=0)\", xlabel=\"Temperature (K)\",\n    ylabel=\"Air density (kg/m³)\", title=\"Air Density vs Temperature at P=101325 Pa\",\n    linewidth=2, legend=:topright)\nplot!(p, T_range, ρ_moist, label=\"Moist air (q=0.015 kg/kg)\", linewidth=2, linestyle=:dash)\np\n\nAt all temperatures, moist air is less dense than dry air at the same pressure, consistent with the lower molecular weight of water vapor (18.016 kg/kmol) compared to dry air (28.966 kg/kmol).","category":"section"},{"location":"clmu_introduction/#Vapor-Pressure-vs.-Specific-Humidity","page":"CLMU Introduction","title":"Vapor Pressure vs. Specific Humidity","text":"The vapor pressure equation relates the atmospheric vapor pressure to specific humidity and total pressure. This relationship is approximately linear for small specific humidities but becomes nonlinear at higher moisture content.\n\nq_range = 0.0:0.001:0.03\ne_vals = Float64[]\n\nfor q_val in q_range\n    prob = ODEProblem(\n        compiled,\n        Dict(\n            compiled.q_atm => q_val,\n            compiled.P_atm => 101325.0,\n            compiled.T_atm => 293.15,\n            compiled.z_prime_atm => 30.0,\n            compiled.z_0 => 1.0,\n            compiled.z_d => 5.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol = solve(prob)\n    push!(e_vals, sol[compiled.e_atm][end])\nend\n\np = plot(q_range .* 1000, e_vals, xlabel=\"Specific humidity (g/kg)\",\n    ylabel=\"Vapor pressure (Pa)\",\n    title=\"Atmospheric Vapor Pressure vs Specific Humidity\\nat P=101325 Pa\",\n    linewidth=2, legend=false)\np","category":"section"},{"location":"clmu_introduction/#UrbanCanopy.CLMUAtmosphere","page":"CLMU Introduction","title":"UrbanCanopy.CLMUAtmosphere","text":"CLMUAtmosphere(; name=:CLMUAtmosphere)\n\nAtmospheric interface for the Community Land Model Urban (CLMU) parameterization. Computes atmospheric density, vapor pressure, and reference height from atmospheric forcing variables, following Chapter 1 of Oleson et al. (2010).\n\nThe CLMU represents the urban surface using a canyon concept (Oke, 1987) consisting of a canyon floor of width W bordered by two facing buildings of height H. The urban canyon is divided into five columns: roof, sunlit wall, shaded wall, pervious road, and impervious road. This component defines the atmospheric forcing interface and the diagnostic equations that connect atmospheric model variables to the urban canopy model.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.\n\n\n\n\n\n","category":"function"},{"location":"offline_mode/#Offline-Mode:-Atmospheric-Forcing","page":"Offline Mode","title":"Offline Mode: Atmospheric Forcing","text":"","category":"section"},{"location":"offline_mode/#Overview","page":"Offline Mode","title":"Overview","text":"In offline mode (uncoupled from an atmospheric model), the Community Land Model Urban (CLMU) requires atmospheric forcing data from observed datasets. Chapter 6 of the technical note describes how raw forcing data is processed into the specific variables needed by the urban model.\n\nThe OfflineModeForcing component implements the algebraic relationships for:\n\nPartitioning total solar radiation into direct/diffuse and visible/near-infrared components (Eqs. 6.2-6.8) using polynomial fits derived from CAM output\nComputing atmospheric downwelling longwave radiation from vapor pressure and temperature using the Idso (1981) formula (Eqs. 6.9-6.10)\nPartitioning precipitation into rain and snow based on temperature (Eqs. 6.11-6.13)\nDeriving wind components, potential temperature, and reference height (p. 149)\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.","category":"section"},{"location":"offline_mode/#Implementation","page":"Offline Mode","title":"Implementation","text":"","category":"section"},{"location":"offline_mode/#State-Variables","page":"Offline Mode","title":"State Variables","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing UrbanCanopy\n\nsys = OfflineModeForcing()\n\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"offline_mode/#Parameters","page":"Offline Mode","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"offline_mode/#Equations","page":"Offline Mode","title":"Equations","text":"eqs = equations(sys)","category":"section"},{"location":"offline_mode/#Analysis","page":"Offline Mode","title":"Analysis","text":"","category":"section"},{"location":"offline_mode/#Solar-Radiation-Partitioning-(Eqs.-6.2-6.8)","page":"Offline Mode","title":"Solar Radiation Partitioning (Eqs. 6.2-6.8)","text":"The total incident solar radiation is split into four components: direct beam visible, direct beam near-infrared, diffuse visible, and diffuse near-infrared. The visible fraction alpha = 05 (Eq. 6.6), and the direct-to-total ratios R_vis and R_nir are polynomial functions of the solar flux (Eqs. 6.7-6.8), clamped to [0.01, 0.99].\n\nusing OrdinaryDiffEqDefault\nusing Plots\n\ncompiled = mtkcompile(sys)\n\nS_range = 0.0:10.0:1200.0\ndir_vis = Float64[]\ndir_nir = Float64[]\ndif_vis = Float64[]\ndif_nir = Float64[]\n\nfor S_val in S_range\n    prob = ODEProblem(\n        compiled,\n        Dict(\n            compiled.S_atm => S_val,\n            compiled.T_atm => 293.15,\n            compiled.P_atm => 101325.0,\n            compiled.q_atm => 0.01,\n            compiled.W_atm => 5.0,\n            compiled.P_precip => 0.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol = solve(prob)\n    push!(dir_vis, sol[compiled.S_atm_dir_vis][end])\n    push!(dir_nir, sol[compiled.S_atm_dir_nir][end])\n    push!(dif_vis, sol[compiled.S_atm_dif_vis][end])\n    push!(dif_nir, sol[compiled.S_atm_dif_nir][end])\nend\n\np = plot(S_range, dir_vis, label=\"Direct visible\", xlabel=\"Total solar radiation (W/m²)\",\n    ylabel=\"Component radiation (W/m²)\",\n    title=\"Solar Radiation Partitioning (Eqs. 6.2-6.5)\",\n    linewidth=2, legend=:topleft)\nplot!(p, S_range, dir_nir, label=\"Direct NIR\", linewidth=2)\nplot!(p, S_range, dif_vis, label=\"Diffuse visible\", linewidth=2, linestyle=:dash)\nplot!(p, S_range, dif_nir, label=\"Diffuse NIR\", linewidth=2, linestyle=:dash)\np\n\nAt low solar radiation (overcast), the diffuse fraction dominates. As total solar radiation increases (clearer skies), the direct beam fraction increases, consistent with less atmospheric scattering under clear conditions.","category":"section"},{"location":"offline_mode/#Direct-Fraction-vs.-Solar-Flux-(Eqs.-6.7-6.8)","page":"Offline Mode","title":"Direct Fraction vs. Solar Flux (Eqs. 6.7-6.8)","text":"The polynomial fits for R_vis and R_nir show how the direct-to-total radiation ratio varies with solar intensity.\n\nR_vis_vals = Float64[]\nR_nir_vals = Float64[]\n\nfor S_val in S_range\n    prob = ODEProblem(\n        compiled,\n        Dict(\n            compiled.S_atm => S_val,\n            compiled.T_atm => 293.15,\n            compiled.P_atm => 101325.0,\n            compiled.q_atm => 0.01,\n            compiled.W_atm => 5.0,\n            compiled.P_precip => 0.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol = solve(prob)\n    push!(R_vis_vals, sol[compiled.R_vis][end])\n    push!(R_nir_vals, sol[compiled.R_nir][end])\nend\n\np = plot(S_range, R_vis_vals, label=\"R_vis (visible)\", xlabel=\"Total solar radiation (W/m²)\",\n    ylabel=\"Direct fraction (dimensionless)\",\n    title=\"Direct-to-Total Radiation Ratio (Eqs. 6.7-6.8)\",\n    linewidth=2, legend=:right, ylims=(0, 1))\nplot!(p, S_range, R_nir_vals, label=\"R_nir (NIR)\", linewidth=2)\nhline!(p, [0.01, 0.99], label=\"Clamp bounds\", linestyle=:dot, color=:gray)\np\n\nThe near-infrared direct fraction is consistently higher than the visible direct fraction, reflecting the greater atmospheric scattering of shorter (visible) wavelengths relative to longer (NIR) wavelengths.","category":"section"},{"location":"offline_mode/#Longwave-Radiation-vs.-Temperature-(Eq.-6.9)","page":"Offline Mode","title":"Longwave Radiation vs. Temperature (Eq. 6.9)","text":"The Idso (1981) formula computes atmospheric downwelling longwave radiation from vapor pressure and temperature. The dominant dependence is on T_atm^4 through the Stefan-Boltzmann law, modulated by an emissivity factor that increases with atmospheric moisture.\n\nT_range = 250.0:2.0:320.0\nL_dry = Float64[]\nL_moist = Float64[]\n\nfor T_val in T_range\n    prob_d = ODEProblem(\n        compiled,\n        Dict(\n            compiled.S_atm => 0.0,\n            compiled.T_atm => T_val,\n            compiled.P_atm => 101325.0,\n            compiled.q_atm => 0.001,\n            compiled.W_atm => 5.0,\n            compiled.P_precip => 0.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol_d = solve(prob_d)\n    push!(L_dry, sol_d[compiled.L_atm_down][end])\n\n    prob_m = ODEProblem(\n        compiled,\n        Dict(\n            compiled.S_atm => 0.0,\n            compiled.T_atm => T_val,\n            compiled.P_atm => 101325.0,\n            compiled.q_atm => 0.02,\n            compiled.W_atm => 5.0,\n            compiled.P_precip => 0.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol_m = solve(prob_m)\n    push!(L_moist, sol_m[compiled.L_atm_down][end])\nend\n\np = plot(T_range, L_dry, label=\"Dry (q=0.001 kg/kg)\", xlabel=\"Temperature (K)\",\n    ylabel=\"Longwave radiation (W/m²)\",\n    title=\"Atmospheric Downwelling Longwave (Eq. 6.9, Idso 1981)\",\n    linewidth=2, legend=:topleft)\nplot!(p, T_range, L_moist, label=\"Moist (q=0.02 kg/kg)\", linewidth=2, linestyle=:dash)\np\n\nHigher atmospheric moisture content increases the effective emissivity of the atmosphere, resulting in greater downwelling longwave radiation at all temperatures.","category":"section"},{"location":"offline_mode/#Precipitation-Phase-Partitioning-(Eqs.-6.11-6.13)","page":"Offline Mode","title":"Precipitation Phase Partitioning (Eqs. 6.11-6.13)","text":"The rain fraction f_P varies linearly from 0 (all snow) at or below the freezing point T_f = 27315 K to 1 (all rain) at T_f + 2 K. This simple linear ramp avoids an abrupt transition between rain and snow.\n\nT_precip_range = 268.0:0.1:280.0\nf_P_vals = Float64[]\nrain_vals = Float64[]\nsnow_vals = Float64[]\nP_val = 1e-3  # 1 mm/s\n\nfor T_val in T_precip_range\n    prob = ODEProblem(\n        compiled,\n        Dict(\n            compiled.S_atm => 0.0,\n            compiled.T_atm => T_val,\n            compiled.P_atm => 101325.0,\n            compiled.q_atm => 0.005,\n            compiled.W_atm => 3.0,\n            compiled.P_precip => P_val,\n        ),\n        (0.0, 1.0),\n    )\n    sol = solve(prob)\n    push!(f_P_vals, sol[compiled.f_P][end])\n    push!(rain_vals, sol[compiled.q_rain][end])\n    push!(snow_vals, sol[compiled.q_snow][end])\nend\n\np = plot(T_precip_range .- 273.15, f_P_vals,\n    label=\"Rain fraction f_P\", xlabel=\"Temperature (°C)\",\n    ylabel=\"Fraction / Rate (mm/s)\",\n    title=\"Precipitation Phase Partitioning (Eqs. 6.11-6.13)\",\n    linewidth=2, legend=:right)\nplot!(p, T_precip_range .- 273.15, rain_vals .* 1000,\n    label=\"Rain rate (mm/s)\", linewidth=2, linestyle=:dash)\nplot!(p, T_precip_range .- 273.15, snow_vals .* 1000,\n    label=\"Snow rate (mm/s)\", linewidth=2, linestyle=:dot)\nvline!(p, [0.0, 2.0], label=\"Transition range\", linestyle=:dot, color=:gray)\np\n\nThe transition zone spans 0°C to 2°C. Below 0°C, all precipitation falls as snow; above 2°C, all precipitation falls as rain. Between these limits, a mixture of rain and snow occurs with the rain fraction f_P = 05(T_atm - T_f) (Eq. 6.13).","category":"section"},{"location":"offline_mode/#Energy-Conservation-Check","page":"Offline Mode","title":"Energy Conservation Check","text":"A key validation of the solar radiation partitioning is that the sum of all four components equals the total input solar radiation for all values of S_atm.\n\ntotal_check = Float64[]\n\nfor S_val in S_range\n    prob = ODEProblem(\n        compiled,\n        Dict(\n            compiled.S_atm => S_val,\n            compiled.T_atm => 293.15,\n            compiled.P_atm => 101325.0,\n            compiled.q_atm => 0.01,\n            compiled.W_atm => 5.0,\n            compiled.P_precip => 0.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol = solve(prob)\n    total = sol[compiled.S_atm_dir_vis][end] + sol[compiled.S_atm_dir_nir][end] +\n            sol[compiled.S_atm_dif_vis][end] + sol[compiled.S_atm_dif_nir][end]\n    push!(total_check, total - S_val)\nend\n\np = plot(S_range, total_check, xlabel=\"Total solar radiation (W/m²)\",\n    ylabel=\"Residual (W/m²)\",\n    title=\"Energy Conservation: Sum of Components - Total\",\n    linewidth=2, legend=false)\np\n\nThe residual is effectively zero (machine precision) across the full range of solar radiation values, confirming exact energy conservation in the partitioning scheme.","category":"section"},{"location":"offline_mode/#UrbanCanopy.OfflineModeForcing","page":"Offline Mode","title":"UrbanCanopy.OfflineModeForcing","text":"OfflineModeForcing(; name=:OfflineModeForcing)\n\nOffline mode atmospheric forcing processor for the Community Land Model Urban (CLMU). Computes derived atmospheric forcing variables from raw observational data for use in uncoupled (offline) simulations, following Chapter 6 of Oleson et al. (2010).\n\nThis component takes total incident solar radiation, cosine of solar zenith angle, atmospheric temperature, pressure, specific humidity, wind speed, and precipitation rate as inputs and computes:\n\nSolar radiation partitioned into direct/diffuse and visible/near-infrared components (Eqs. 6.2-6.8)\nAtmospheric downwelling longwave radiation from the Idso (1981) formula (Eqs. 6.9-6.10)\nRain and snow precipitation rates from temperature-dependent partitioning (Eqs. 6.11-6.13)\nWind components, potential temperature, and reference height (p.149)\n\nNote: Equation 6.1 describes temporal downscaling of 6-hourly solar radiation to model time steps using cosine of solar zenith angle weighting. This discrete-time algorithm is a data preprocessing step and is not implemented here; instead, S_atm is taken as the already-interpolated total solar radiation at the model time step.\n\nNote: Equations 6.14-6.15 describe alternative methods for computing specific humidity from relative humidity or dew point temperature. These are optional data preprocessing steps and are not implemented in this component.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.\n\n\n\n\n\n","category":"function"},{"location":"#UrbanCanopy.jl","page":"Home","title":"UrbanCanopy.jl","text":"Documentation for UrbanCanopy.jl.\n\nUrbanCanopy.jl implements urban canopy processes for the EarthSciML framework, including urban heat island effects, building energy balance, urban surface exchange, anthropogenic heat fluxes, and urban boundary layer interactions.\n\n","category":"section"}]
}
