var documenterSearchIndex = {"docs":
[{"location":"api/#API-Reference","page":"API","title":"API Reference","text":"","category":"section"},{"location":"api/#UrbanCanopy.CLMUAtmosphere-Tuple{}","page":"API","title":"UrbanCanopy.CLMUAtmosphere","text":"CLMUAtmosphere(; name=:CLMUAtmosphere)\n\nAtmospheric interface for the Community Land Model Urban (CLMU) parameterization. Computes atmospheric density, vapor pressure, and reference height from atmospheric forcing variables, following Chapter 1 of Oleson et al. (2010).\n\nThe CLMU represents the urban surface using a canyon concept (Oke, 1987) consisting of a canyon floor of width W bordered by two facing buildings of height H. The urban canyon is divided into five columns: roof, sunlit wall, shaded wall, pervious road, and impervious road. This component defines the atmospheric forcing interface and the diagnostic equations that connect atmospheric model variables to the urban canopy model.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.HeatMomentumFluxes-Tuple{}","page":"API","title":"UrbanCanopy.HeatMomentumFluxes","text":"HeatMomentumFluxes(; name=:HeatMomentumFluxes)\n\nUrban heat and momentum fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 3 of Oleson et al. (2010).\n\nComputes the Monin-Obukhov similarity theory parameters, roughness length and displacement height, wind speed in the urban canyon, aerodynamic and surface resistances, sensible and latent heat fluxes for the five urban surfaces (roof, sunlit wall, shaded wall, pervious road, impervious road), total momentum fluxes, and the UCL air temperature and specific humidity.\n\nThe Monin-Obukhov stability parameter ζ is taken as an input parameter, since in the original CLM implementation it is computed through an iterative procedure (Section 3.2.3). Given ζ, the system computes all stability corrections, friction velocity, aerodynamic resistances, and surface fluxes as a directed algebraic system without circular dependencies.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 3: Heat and Momentum Fluxes (pp. 61-89).\n\n\n\n\n\n","category":"method"},{"location":"api/#UrbanCanopy.UrbanRadiation-Tuple{}","page":"API","title":"UrbanCanopy.UrbanRadiation","text":"UrbanRadiation(; name=:UrbanRadiation)\n\nUrban albedos and radiative fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 2 of Oleson et al. (2010).\n\nComputes the view factors, incident direct beam and diffuse solar radiation, absorbed and reflected solar radiation (with closed-form multi-reflection solution for the urban canyon), incident longwave radiation, and absorbed/reflected/emitted longwave radiation for urban surfaces: roof, sunlit wall, shaded wall, and road.\n\nThe urban canyon is represented as an infinitely long canyon of width W bordered by buildings of height H. Radiation interactions within the canyon account for multiple reflections between walls and road using view factors. The iterative multi-reflection scheme (Eqs. 2.63-2.85, 2.138-2.170) is solved in closed form using the matrix geometric series: S_absorbed = (I - A) * (I - T*A)^{-1} * S_0, where A is the albedo matrix, T is the view-factor transport matrix, and S_0 is the initial incident radiation vector.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 2: Albedos and Radiative Fluxes (pp. 26-60).\n\n\n\n\n\n","category":"method"},{"location":"heat_momentum_fluxes/#Heat-and-Momentum-Fluxes","page":"Heat and Momentum Fluxes","title":"Heat and Momentum Fluxes","text":"","category":"section"},{"location":"heat_momentum_fluxes/#Overview","page":"Heat and Momentum Fluxes","title":"Overview","text":"Chapter 3 of the CLMU technical note describes the computation of heat and momentum fluxes for urban surfaces using Monin-Obukhov similarity theory. These fluxes drive the surface energy balance and determine the exchange of energy and momentum between the urban surface and the atmospheric boundary layer.\n\nThe HeatMomentumFluxes component computes:\n\nRoughness length and displacement height from canyon geometry using the MacDonald et al. (1998) formulation (Eqs. 3.55-3.58)\nStability correction functions psi_m and psi_h for four regimes: very unstable (zeta  -1574), unstable (-1574 leq zeta  0), stable (0 leq zeta leq 1), and very stable (zeta  1) (Eqs. 3.31-3.46)\nConvective velocity U_c for unstable conditions using the convective velocity scale w_* (Eqs. 3.25, 3.29-3.30)\nFriction velocity u_* and aerodynamic resistances r_am, r_ah, r_aw (Eqs. 3.26, 3.65-3.67)\nCanyon wind speed for three flow regimes: isolated (HW  05), wake interference (05 leq HW  1), and skimming (HW geq 1) (Eqs. 3.59-3.62)\nSurface resistance for heat and moisture exchange (Eq. 3.68)\nUCL air temperature and humidity as conductance-weighted averages (Eqs. 3.75, 3.93)\nSensible heat fluxes for all five surfaces (roof, pervious road, impervious road, sunlit wall, shaded wall) and the area-weighted total (Eqs. 3.69-3.74)\nWater vapor fluxes for roof, pervious road, and impervious road (walls have zero evaporation) (Eqs. 3.76-3.81)\nMomentum fluxes tau_x and tau_y (Eqs. 3.6-3.7)\nPartial derivatives partial H  partial T_g for all five surfaces,  needed for the implicit soil temperature calculation (Eqs. 3.95-3.99)\n\nThe Monin-Obukhov stability parameter zeta is taken as an input parameter, since in the original CLM implementation it is computed through an iterative procedure (Section 3.2.3). This avoids an algebraic loop and allows the system to be solved as a directed algebraic system.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 3: Heat and Momentum Fluxes (pp. 61-89).","category":"section"},{"location":"heat_momentum_fluxes/#Implementation","page":"Heat and Momentum Fluxes","title":"Implementation","text":"The HeatMomentumFluxes component implements the heat and momentum flux parameterization with 48 equations and 48 unknowns.","category":"section"},{"location":"heat_momentum_fluxes/#State-Variables","page":"Heat and Momentum Fluxes","title":"State Variables","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing UrbanCanopy\n\nsys = HeatMomentumFluxes()\n\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"heat_momentum_fluxes/#Parameters","page":"Heat and Momentum Fluxes","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"heat_momentum_fluxes/#Equations","page":"Heat and Momentum Fluxes","title":"Equations","text":"eqs = equations(sys)","category":"section"},{"location":"heat_momentum_fluxes/#Analysis","page":"Heat and Momentum Fluxes","title":"Analysis","text":"The following figures explore the behavior of the heat and momentum flux system across different canyon geometries and atmospheric stability conditions.\n\nusing OrdinaryDiffEqDefault\nusing Plots\n\ncompiled = mtkcompile(sys)\n\nfunction solve_hmf(compiled, params)\n    prob = ODEProblem(compiled, params, (0.0, 1.0))\n    solve(prob)\nend\n\nfunction base_hmf_params(compiled; H_W=1.0, ζ_in=0.1)\n    Dict(\n        compiled.H_W => H_W,\n        compiled.H_canyon => 10.0,\n        compiled.W_roof => 0.25,\n        compiled.f_prvrd => 0.5,\n        compiled.H_w_est => 5.0,\n        compiled.u_atm => 3.0,\n        compiled.v_atm => 2.0,\n        compiled.θ_atm => 300.0,\n        compiled.q_atm => 0.01,\n        compiled.ρ_atm => 1.2,\n        compiled.z_atm_m => 30.0,\n        compiled.z_atm_h => 30.0,\n        compiled.z_atm_w => 30.0,\n        compiled.T_g_roof => 310.0,\n        compiled.T_g_prvrd => 305.0,\n        compiled.T_g_imprvrd => 308.0,\n        compiled.T_g_sunwall => 312.0,\n        compiled.T_g_shdwall => 303.0,\n        compiled.q_g_roof => 0.015,\n        compiled.q_g_prvrd => 0.012,\n        compiled.q_g_imprvrd => 0.014,\n        compiled.f_wet_roof => 0.0,\n        compiled.f_wet_imprvrd => 0.0,\n        compiled.ζ_in => ζ_in,\n    )\nend\nnothing # hide","category":"section"},{"location":"heat_momentum_fluxes/#Roughness-Parameters-vs-Canyon-H/W-Ratio","page":"Heat and Momentum Fluxes","title":"Roughness Parameters vs Canyon H/W Ratio","text":"Displacement height d and roughness length z_0m as functions of the canyon height-to-width ratio, computed using the MacDonald et al. (1998) formulation (Eqs. 3.55-3.57). The displacement height approaches the building height for deep canyons, while the roughness length peaks at intermediate H/W and decreases for very deep canyons.\n\nhw_range = 0.1:0.05:5.0\nd_vals = Float64[]\nz0m_vals = Float64[]\n\nfor hw in hw_range\n    p = base_hmf_params(compiled; H_W=hw)\n    sol = solve_hmf(compiled, p)\n    push!(d_vals, sol[compiled.d_canopy][end])\n    push!(z0m_vals, sol[compiled.z_0m_canopy][end])\nend\n\np1 = plot(hw_range, d_vals, label=\"d (displacement height)\",\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"Height (m)\",\n    title=\"Roughness Parameters vs H/W (Eqs. 3.55-3.57)\",\n    linewidth=2, legend=:topleft)\nplot!(p1, hw_range, z0m_vals, label=\"z₀ₘ (roughness length)\", linewidth=2)\nhline!(p1, [10.0], label=\"H_canyon = 10 m\", linestyle=:dash, color=:gray)\np1","category":"section"},{"location":"heat_momentum_fluxes/#Stability-Corrections-and-Friction-Velocity","page":"Heat and Momentum Fluxes","title":"Stability Corrections and Friction Velocity","text":"The stability correction functions psi_m and psi_h modify the log-law wind and temperature profiles. Positive psi (unstable conditions) enhances turbulent transfer; negative psi (stable conditions) suppresses it. The friction velocity responds accordingly, being higher in unstable conditions when turbulent mixing is enhanced.\n\nζ_range = -3.0:0.05:3.0\nψ_m_vals = Float64[]\nψ_h_vals = Float64[]\nustar_vals = Float64[]\n\nfor ζ in ζ_range\n    if abs(ζ) < 0.001\n        ζ = sign(ζ) == -1 ? -0.001 : 0.001\n    end\n    p = base_hmf_params(compiled; ζ_in=ζ)\n    sol = solve_hmf(compiled, p)\n    push!(ψ_m_vals, sol[compiled.ψ_m_atm][end])\n    push!(ψ_h_vals, sol[compiled.ψ_h_atm][end])\n    push!(ustar_vals, sol[compiled.u_star][end])\nend\n\np1 = plot(ζ_range, ψ_m_vals, label=\"ψ_m\", linewidth=2,\n    xlabel=\"ζ = (z-d)/L\", ylabel=\"ψ\",\n    title=\"Stability Corrections (Eqs. 3.31-3.46)\",\n    legend=:topright)\nplot!(p1, ζ_range, ψ_h_vals, label=\"ψ_h\", linewidth=2)\nvline!(p1, [0.0], linestyle=:dash, color=:gray, label=\"Neutral\")\nvline!(p1, [-1.574], linestyle=:dot, color=:red, label=\"ζ_m transition\")\nvline!(p1, [-0.465], linestyle=:dot, color=:blue, label=\"ζ_h transition\")\n\np2 = plot(ζ_range, ustar_vals, label=\"u*\", linewidth=2, color=:green,\n    xlabel=\"ζ = (z-d)/L\", ylabel=\"u* (m/s)\",\n    title=\"Friction Velocity vs Stability\",\n    legend=:topright)\nvline!(p2, [0.0], linestyle=:dash, color=:gray, label=\"Neutral\")\n\np = plot(p1, p2, layout=(2, 1), size=(700, 700))\np","category":"section"},{"location":"heat_momentum_fluxes/#Canyon-Wind-Speed-and-Flow-Regimes","page":"Heat and Momentum Fluxes","title":"Canyon Wind Speed and Flow Regimes","text":"The canyon wind speed exhibits three flow regimes depending on the canyon height-to-width ratio: isolated roughness flow for HW  05, wake interference for 05 leq HW  1, and skimming flow for HW geq 1 (Eqs. 3.60-3.62). Deeper canyons trap wind less effectively, reducing the canyon wind speed.\n\nhw_range_wind = 0.1:0.05:5.0\nUcan_vals = Float64[]\nUac_vals = Float64[]\nVr_vals = Float64[]\n\nfor hw in hw_range_wind\n    p = base_hmf_params(compiled; H_W=hw)\n    sol = solve_hmf(compiled, p)\n    push!(Ucan_vals, sol[compiled.U_can][end])\n    push!(Uac_vals, sol[compiled.U_ac][end])\n    push!(Vr_vals, sol[compiled.V_r][end])\nend\n\np = plot(hw_range_wind, Ucan_vals, label=\"U_can (horizontal)\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"Wind Speed (m/s)\",\n    title=\"Canyon Wind Speed vs H/W (Eqs. 3.59-3.62)\",\n    legend=:topright)\nplot!(p, hw_range_wind, Uac_vals, label=\"U_ac (total canyon)\", linewidth=2)\nhline!(p, [sqrt(3.0^2 + 2.0^2)], label=\"V_r (reference wind)\", linestyle=:dash, color=:gray)\nvline!(p, [0.5], linestyle=:dot, color=:red, label=\"Isolated/Wake boundary\")\nvline!(p, [1.0], linestyle=:dot, color=:blue, label=\"Wake/Skimming boundary\")\np","category":"section"},{"location":"heat_momentum_fluxes/#Sensible-Heat-Fluxes-vs-Canyon-H/W","page":"Heat and Momentum Fluxes","title":"Sensible Heat Fluxes vs Canyon H/W","text":"Sensible heat fluxes from each urban surface as a function of canyon height-to-width ratio (Eqs. 3.69-3.74). Positive values indicate upward heat flux (surface warming the atmosphere). The UCL temperature is a weighted average of all surface temperatures and the atmospheric temperature.\n\nhw_range_H = 0.1:0.1:5.0\nH_roof_vals = Float64[]\nH_prvrd_vals = Float64[]\nH_imprvrd_vals = Float64[]\nH_sunwall_vals = Float64[]\nH_shdwall_vals = Float64[]\nH_total_vals = Float64[]\nT_ac_vals = Float64[]\n\nfor hw in hw_range_H\n    p = base_hmf_params(compiled; H_W=hw)\n    sol = solve_hmf(compiled, p)\n    push!(H_roof_vals, sol[compiled.H_roof][end])\n    push!(H_prvrd_vals, sol[compiled.H_prvrd][end])\n    push!(H_imprvrd_vals, sol[compiled.H_imprvrd][end])\n    push!(H_sunwall_vals, sol[compiled.H_sunwall][end])\n    push!(H_shdwall_vals, sol[compiled.H_shdwall][end])\n    push!(H_total_vals, sol[compiled.H_total][end])\n    push!(T_ac_vals, sol[compiled.T_ac][end])\nend\n\np1 = plot(hw_range_H, H_roof_vals, label=\"H_roof\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"Sensible Heat Flux (W m⁻²)\",\n    title=\"Surface Sensible Heat Fluxes (Eqs. 3.69-3.74)\",\n    legend=:right)\nplot!(p1, hw_range_H, H_prvrd_vals, label=\"H_prvrd\", linewidth=2)\nplot!(p1, hw_range_H, H_imprvrd_vals, label=\"H_imprvrd\", linewidth=2)\nplot!(p1, hw_range_H, H_sunwall_vals, label=\"H_sunwall\", linewidth=2)\nplot!(p1, hw_range_H, H_shdwall_vals, label=\"H_shdwall\", linewidth=2)\nplot!(p1, hw_range_H, H_total_vals, label=\"H_total\", linewidth=2, linestyle=:dash, color=:black)\n\np2 = plot(hw_range_H, T_ac_vals, label=\"T_ac\", linewidth=2, color=:red,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"Temperature (K)\",\n    title=\"UCL Air Temperature (Eq. 3.75)\",\n    legend=:topright)\nhline!(p2, [300.0], label=\"θ_atm\", linestyle=:dash, color=:gray)\n\np = plot(p1, p2, layout=(2, 1), size=(700, 700))\np\n\nThe UCL temperature shifts towards the surface temperatures as the canyon deepens and surface-to-air conductances dominate over the atmospheric conductance. Individual surface heat fluxes adjust as the UCL temperature changes with H/W.","category":"section"},{"location":"heat_momentum_fluxes/#Aerodynamic-and-Surface-Resistances-vs-Stability","page":"Heat and Momentum Fluxes","title":"Aerodynamic and Surface Resistances vs Stability","text":"Aerodynamic resistance decreases under unstable conditions (enhanced turbulent mixing) and increases under stable conditions (suppressed mixing). The surface resistance depends on the canyon wind speed through forced convection (Eq. 3.68).\n\nζ_range_r = -2.0:0.1:2.0\nr_am_vals = Float64[]\nr_ah_vals = Float64[]\nr_s_vals = Float64[]\n\nfor ζ in ζ_range_r\n    if abs(ζ) < 0.001\n        ζ = sign(ζ) == -1 ? -0.001 : 0.001\n    end\n    p = base_hmf_params(compiled; ζ_in=ζ)\n    sol = solve_hmf(compiled, p)\n    push!(r_am_vals, sol[compiled.r_am][end])\n    push!(r_ah_vals, sol[compiled.r_ah][end])\n    push!(r_s_vals, sol[compiled.r_s_u][end])\nend\n\np = plot(ζ_range_r, r_am_vals, label=\"r_am (momentum)\", linewidth=2,\n    xlabel=\"ζ = (z-d)/L\", ylabel=\"Resistance (s/m)\",\n    title=\"Resistances vs Stability (Eqs. 3.65-3.68)\",\n    legend=:topleft, yscale=:log10)\nplot!(p, ζ_range_r, r_ah_vals, label=\"r_ah (heat)\", linewidth=2)\nplot!(p, ζ_range_r, r_s_vals, label=\"r_s (surface)\", linewidth=2)\nvline!(p, [0.0], linestyle=:dash, color=:gray, label=\"Neutral\")\np\n\nThe aerodynamic resistances r_am and r_ah vary strongly with stability, while the surface resistance r_s shows a weaker dependence because it is controlled primarily by the canyon wind speed rather than directly by the stability corrections.","category":"section"},{"location":"heat_momentum_fluxes/#Convective-Velocity-vs-Stability","page":"Heat and Momentum Fluxes","title":"Convective Velocity vs Stability","text":"The convective velocity U_c (Eqs. 3.29-3.30) augments the effective wind speed V_a under unstable conditions. U_c = beta w_* where w_* is the convective velocity scale computed from the friction velocity and the Monin-Obukhov length. Under stable conditions U_c = 0 and V_a reduces to the horizontal wind speed.\n\nζ_range_uc = -3.0:0.05:1.0\nUc_vals = Float64[]\nVa_vals = Float64[]\nVr_vals_stab = Float64[]\n\nfor ζ in ζ_range_uc\n    if abs(ζ) < 0.001\n        ζ = sign(ζ) == -1 ? -0.001 : 0.001\n    end\n    p = base_hmf_params(compiled; ζ_in=ζ)\n    sol = solve_hmf(compiled, p)\n    push!(Uc_vals, sol[compiled.U_c][end])\n    push!(Va_vals, sol[compiled.V_a][end])\n    push!(Vr_vals_stab, sol[compiled.V_r][end])\nend\n\np1 = plot(ζ_range_uc, Uc_vals, label=\"U_c (convective velocity)\", linewidth=2,\n    xlabel=\"ζ = (z-d)/L\", ylabel=\"Speed (m/s)\",\n    title=\"Convective Velocity and Effective Wind Speed (Eqs. 3.25, 3.29-3.30)\",\n    legend=:topright)\nplot!(p1, ζ_range_uc, Va_vals, label=\"V_a (effective wind)\", linewidth=2)\nplot!(p1, ζ_range_uc, Vr_vals_stab, label=\"V_r (horizontal wind)\", linewidth=2, linestyle=:dash)\nvline!(p1, [0.0], linestyle=:dash, color=:gray, label=\"Neutral\")\np1\n\nUnder strongly unstable conditions, the convective velocity can exceed the mean horizontal wind, significantly increasing the effective wind speed and turbulent exchange.","category":"section"},{"location":"heat_momentum_fluxes/#Partial-Derivatives-of-Sensible-Heat-Flux","page":"Heat and Momentum Fluxes","title":"Partial Derivatives of Sensible Heat Flux","text":"The partial derivatives partial H  partial T_g (Eqs. 3.95-3.99) quantify the sensitivity of each surface's sensible heat flux to changes in its ground temperature. These are needed for the implicit coupling with the soil temperature equation (Chapter 4). Larger values indicate stronger thermal coupling between the surface and the atmosphere.\n\nhw_range_dH = 0.1:0.1:5.0\ndH_roof_vals = Float64[]\ndH_prvrd_vals = Float64[]\ndH_imprvrd_vals = Float64[]\ndH_sunwall_vals = Float64[]\ndH_shdwall_vals = Float64[]\n\nfor hw in hw_range_dH\n    p = base_hmf_params(compiled; H_W=hw)\n    sol = solve_hmf(compiled, p)\n    push!(dH_roof_vals, sol[compiled.dH_roof_dT][end])\n    push!(dH_prvrd_vals, sol[compiled.dH_prvrd_dT][end])\n    push!(dH_imprvrd_vals, sol[compiled.dH_imprvrd_dT][end])\n    push!(dH_sunwall_vals, sol[compiled.dH_sunwall_dT][end])\n    push!(dH_shdwall_vals, sol[compiled.dH_shdwall_dT][end])\nend\n\np = plot(hw_range_dH, dH_roof_vals, label=\"∂H_roof/∂T\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"∂H/∂T (W m⁻² K⁻¹)\",\n    title=\"Sensible Heat Flux Derivatives (Eqs. 3.95-3.99)\",\n    legend=:right)\nplot!(p, hw_range_dH, dH_prvrd_vals, label=\"∂H_prvrd/∂T\", linewidth=2)\nplot!(p, hw_range_dH, dH_imprvrd_vals, label=\"∂H_imprvrd/∂T\", linewidth=2)\nplot!(p, hw_range_dH, dH_sunwall_vals, label=\"∂H_sunwall/∂T\", linewidth=2)\nplot!(p, hw_range_dH, dH_shdwall_vals, label=\"∂H_shdwall/∂T\", linewidth=2)\np\n\nThe partial derivatives reflect the thermal coupling strength of each surface. Surfaces with larger area fractions (e.g., roof) have stronger coupling, while the wall derivatives increase with H/W as wall area grows relative to the canyon floor.","category":"section"},{"location":"heat_momentum_fluxes/#UrbanCanopy.HeatMomentumFluxes","page":"Heat and Momentum Fluxes","title":"UrbanCanopy.HeatMomentumFluxes","text":"HeatMomentumFluxes(; name=:HeatMomentumFluxes)\n\nUrban heat and momentum fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 3 of Oleson et al. (2010).\n\nComputes the Monin-Obukhov similarity theory parameters, roughness length and displacement height, wind speed in the urban canyon, aerodynamic and surface resistances, sensible and latent heat fluxes for the five urban surfaces (roof, sunlit wall, shaded wall, pervious road, impervious road), total momentum fluxes, and the UCL air temperature and specific humidity.\n\nThe Monin-Obukhov stability parameter ζ is taken as an input parameter, since in the original CLM implementation it is computed through an iterative procedure (Section 3.2.3). Given ζ, the system computes all stability corrections, friction velocity, aerodynamic resistances, and surface fluxes as a directed algebraic system without circular dependencies.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 3: Heat and Momentum Fluxes (pp. 61-89).\n\n\n\n\n\n","category":"function"},{"location":"albedos_radiative_fluxes/#Albedos-and-Radiative-Fluxes","page":"Albedos and Radiative Fluxes","title":"Albedos and Radiative Fluxes","text":"","category":"section"},{"location":"albedos_radiative_fluxes/#Overview","page":"Albedos and Radiative Fluxes","title":"Overview","text":"Chapter 2 of the CLMU technical note describes the computation of albedos and radiative fluxes for urban surfaces. The effects of canyon geometry on the radiation balance are a key driver of urban-rural energy balance differences (Oke et al. 1991). Shadowing of urban surfaces affects incident radiation and thus temperature, and multiple reflections of radiation between canyon surfaces must be accounted for (Harman et al. 2004).\n\nThe UrbanRadiation component computes:\n\nView factors between canyon surfaces (road, walls, sky) as functions of the height-to-width ratio HW (Eqs. 2.22-2.28)\nIncident direct beam solar radiation on walls and road, integrated over canyon orientations (Eqs. 2.11-2.17)\nIncident diffuse solar radiation on canyon surfaces (Eqs. 2.29-2.32)\nAbsorbed and reflected solar radiation with closed-form multi-reflection solution (Eqs. 2.34-2.95)\nLongwave radiation including emission, reflection, and multi-reflection within the canyon (Eqs. 2.96-2.175)\n\nThe iterative multi-reflection scheme from the paper (Eqs. 2.63-2.85 for solar, 2.138-2.170 for longwave) is solved in closed form using the matrix geometric series: S_absorbed = (I - A)(I - TA)^-1 S_0, where A is the albedo matrix, T is the view-factor transport matrix, and S_0 is the initial incident radiation vector. The 3x3 matrix inverse is computed analytically.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 2: Albedos and Radiative Fluxes (pp. 26-60).","category":"section"},{"location":"albedos_radiative_fluxes/#Implementation","page":"Albedos and Radiative Fluxes","title":"Implementation","text":"The UrbanRadiation component implements the radiation balance for the urban canyon system with 62 equations, 62 variables, and 31 parameters.","category":"section"},{"location":"albedos_radiative_fluxes/#State-Variables","page":"Albedos and Radiative Fluxes","title":"State Variables","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing UrbanCanopy\n\nsys = UrbanRadiation()\n\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"albedos_radiative_fluxes/#Parameters","page":"Albedos and Radiative Fluxes","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"albedos_radiative_fluxes/#Equations","page":"Albedos and Radiative Fluxes","title":"Equations","text":"eqs = equations(sys)","category":"section"},{"location":"albedos_radiative_fluxes/#Analysis","page":"Albedos and Radiative Fluxes","title":"Analysis","text":"The following figures reproduce the key results from Chapter 2 of the CLMU technical note using the implementation above.\n\nusing OrdinaryDiffEqDefault\nusing Plots\n\ncompiled = mtkcompile(sys)\n\nfunction solve_urban(compiled, params)\n    prob = ODEProblem(compiled, params, (0.0, 1.0))\n    solve(prob)\nend\n\nfunction base_params(compiled; H_W=1.0, μ_zen=0.5236)\n    Dict(\n        compiled.H_W => H_W,\n        compiled.W_roof => 0.25,\n        compiled.S_atm_dir_vis => 200.0,\n        compiled.S_atm_dir_nir => 200.0,\n        compiled.S_atm_dif_vis => 100.0,\n        compiled.S_atm_dif_nir => 100.0,\n        compiled.L_atm_down => 340.0,\n        compiled.μ_zen => μ_zen,\n        compiled.α_roof_dir_vis => 0.15,\n        compiled.α_roof_dir_nir => 0.15,\n        compiled.α_roof_dif_vis => 0.15,\n        compiled.α_roof_dif_nir => 0.15,\n        compiled.α_road_dir_vis => 0.08,\n        compiled.α_road_dir_nir => 0.08,\n        compiled.α_road_dif_vis => 0.08,\n        compiled.α_road_dif_nir => 0.08,\n        compiled.α_wall_dir_vis => 0.25,\n        compiled.α_wall_dir_nir => 0.25,\n        compiled.α_wall_dif_vis => 0.25,\n        compiled.α_wall_dif_nir => 0.25,\n        compiled.ε_roof => 0.90,\n        compiled.ε_road => 0.95,\n        compiled.ε_wall => 0.85,\n        compiled.T_roof => 292.16,\n        compiled.T_road => 292.16,\n        compiled.T_sunwall => 292.16,\n        compiled.T_shdwall => 292.16,\n    )\nend\nnothing # hide","category":"section"},{"location":"albedos_radiative_fluxes/#Figure-2.4:-View-Factors-vs-Canyon-H/W-Ratio","page":"Albedos and Radiative Fluxes","title":"Figure 2.4: View Factors vs Canyon H/W Ratio","text":"View factors as a function of canyon height to width ratio (cf. Figure 2.4, p. 37). Psi_road-sky is the fraction of radiation reaching the sky from the road, Psi_road-wall is the fraction reaching the wall from the road, Psi_wall-sky and Psi_wall-road are the fractions reaching the sky and road from the wall, and Psi_wall-wall is the fraction reaching the opposite wall.\n\nhw_range = 10 .^ range(-2, 1, length=200)\n\nψ_road_sky = Float64[]\nψ_road_wall = Float64[]\nψ_wall_sky = Float64[]\nψ_wall_road = Float64[]\nψ_wall_wall = Float64[]\n\nfor hw in hw_range\n    p = base_params(compiled; H_W=hw)\n    sol = solve_urban(compiled, p)\n    push!(ψ_road_sky, sol[compiled.Ψ_road_sky][end])\n    push!(ψ_road_wall, sol[compiled.Ψ_road_wall][end])\n    push!(ψ_wall_sky, sol[compiled.Ψ_wall_sky][end])\n    push!(ψ_wall_road, sol[compiled.Ψ_wall_road][end])\n    push!(ψ_wall_wall, sol[compiled.Ψ_wall_wall][end])\nend\n\np = plot(hw_range, ψ_road_sky, label=\"Ψ_road-sky\", xscale=:log10,\n    xlabel=\"Canyon H/W Ratio\", ylabel=\"View Factor\",\n    title=\"View Factors vs Canyon H/W Ratio (Figure 2.4)\",\n    linewidth=2, legend=:right, ylims=(0, 1))\nplot!(p, hw_range, ψ_road_wall, label=\"Ψ_road-wall\", linewidth=2)\nplot!(p, hw_range, ψ_wall_sky, label=\"Ψ_wall-sky, Ψ_wall-road\", linewidth=2)\nplot!(p, hw_range, ψ_wall_wall, label=\"Ψ_wall-wall\", linewidth=2)\np\n\nAt low H/W ratios the road-sky view factor is close to one (flat surface behavior), while at high H/W ratios most radiative interactions occur between the walls and between the walls and road.","category":"section"},{"location":"albedos_radiative_fluxes/#Figure-2.5:-Absorbed-Solar-Radiation-vs-H/W-Ratio","page":"Albedos and Radiative Fluxes","title":"Figure 2.5: Absorbed Solar Radiation vs H/W Ratio","text":"Solar radiation absorbed by urban surfaces for solar zenith angles of 30 degrees (top) and 60 degrees (bottom) (cf. Figure 2.5, p. 47). The atmospheric solar radiation is S_atmdownarrow^mu = 400 and S_atmdownarrow = 200 W m^-2. Albedos: roof = 0.15, road = 0.08, wall = 0.25. Note that wall fluxes are per unit wall area; the canyon total converts them to per unit ground area using the H/W ratio.\n\nhw_range_lin = 0.1:0.1:10.0\n\nfunction compute_absorbed_solar(compiled, hw_range, μ_zen)\n    road = Float64[]\n    sunwall = Float64[]\n    shdwall = Float64[]\n    roof = Float64[]\n    canyon = Float64[]\n\n    for hw in hw_range\n        p = base_params(compiled; H_W=hw, μ_zen=μ_zen)\n        p[compiled.S_atm_dir_vis] = 200.0\n        p[compiled.S_atm_dir_nir] = 200.0\n        p[compiled.S_atm_dif_vis] = 100.0\n        p[compiled.S_atm_dif_nir] = 100.0\n        sol = solve_urban(compiled, p)\n        push!(road, sol[compiled.S_net_road][end])\n        push!(sunwall, sol[compiled.S_net_sunwall][end])\n        push!(shdwall, sol[compiled.S_net_shdwall][end])\n        push!(roof, sol[compiled.S_net_roof][end])\n        push!(canyon, sol[compiled.S_net_uc][end])\n    end\n    return road, sunwall, shdwall, roof, canyon\nend\n\nroad30, sw30, sh30, roof30, can30 = compute_absorbed_solar(compiled, hw_range_lin, deg2rad(30))\nroad60, sw60, sh60, roof60, can60 = compute_absorbed_solar(compiled, hw_range_lin, deg2rad(60))\n\np1 = plot(hw_range_lin, can30, label=\"Canyon\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\",\n    ylabel=\"Absorbed Solar Radiation (W m⁻²)\",\n    title=\"Solar Zenith Angle = 30°\",\n    legend=:right, ylims=(0, 700))\nplot!(p1, hw_range_lin, roof30, label=\"Roof\", linewidth=2)\nplot!(p1, hw_range_lin, road30, label=\"Road\", linewidth=2)\nplot!(p1, hw_range_lin, sw30, label=\"Sunlit Wall\", linewidth=2)\nplot!(p1, hw_range_lin, sh30, label=\"Shaded Wall\", linewidth=2)\n\np2 = plot(hw_range_lin, can60, label=\"Canyon\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\",\n    ylabel=\"Absorbed Solar Radiation (W m⁻²)\",\n    title=\"Solar Zenith Angle = 60°\",\n    legend=:right, ylims=(0, 700))\nplot!(p2, hw_range_lin, roof60, label=\"Roof\", linewidth=2)\nplot!(p2, hw_range_lin, road60, label=\"Road\", linewidth=2)\nplot!(p2, hw_range_lin, sw60, label=\"Sunlit Wall\", linewidth=2)\nplot!(p2, hw_range_lin, sh60, label=\"Shaded Wall\", linewidth=2)\n\np = plot(p1, p2, layout=(2, 1), size=(700, 800))\np\n\nThe absorbed solar radiation for the roof is independent of H/W and solar zenith angle. At both zenith angles, absorbed road radiation decreases rapidly with increasing H/W as buildings shade the road. The canyon total increases slowly with H/W because radiation trapping in deeper canyons increases total absorption.","category":"section"},{"location":"albedos_radiative_fluxes/#Figure-2.6:-Canyon-Albedo-vs-H/W-Ratio","page":"Albedos and Radiative Fluxes","title":"Figure 2.6: Canyon Albedo vs H/W Ratio","text":"Direct beam and diffuse canyon albedo (excluding roof) as a function of H/W ratio for solar zenith angles from 0 to 85 degrees (cf. Figure 2.6, p. 48). Albedos: road = 0.08, wall = 0.25.\n\nhw_range_alb = 0.05:0.05:3.0\nzenith_angles = 0:5:85\n\np = plot(xlabel=\"Canyon H/W Ratio\", ylabel=\"Canyon Albedo\",\n    title=\"Canyon Albedo vs H/W Ratio (Figure 2.6)\",\n    legend=false, ylims=(0, 0.14))\n\n# Direct beam albedo for each zenith angle (solid lines)\nfor (i, zen_deg) in enumerate(zenith_angles)\n    zen_rad = deg2rad(zen_deg)\n    # Avoid exactly 0 or 90 degrees\n    if zen_rad < 0.001\n        zen_rad = 0.001\n    end\n    alb_dir = Float64[]\n    for hw in hw_range_alb\n        params = base_params(compiled; H_W=hw, μ_zen=zen_rad)\n        sol = solve_urban(compiled, params)\n        # Average VIS and NIR direct beam albedo\n        a_vis = sol[compiled.α_uc_dir_vis][end]\n        a_nir = sol[compiled.α_uc_dir_nir][end]\n        push!(alb_dir, (a_vis + a_nir) / 2)\n    end\n    plot!(p, hw_range_alb, alb_dir, linewidth=1.5, color=:black, linestyle=:solid)\nend\n\n# Diffuse albedo (dashed line) - independent of zenith angle\nalb_dif = Float64[]\nfor hw in hw_range_alb\n    params = base_params(compiled; H_W=hw)\n    sol = solve_urban(compiled, params)\n    a_vis = sol[compiled.α_uc_dif_vis][end]\n    a_nir = sol[compiled.α_uc_dif_nir][end]\n    push!(alb_dif, (a_vis + a_nir) / 2)\nend\nplot!(p, hw_range_alb, alb_dif, linewidth=2, color=:black, linestyle=:dash)\n\n# Add annotations\nannotate!(p, 0.6, 0.12, text(\"Horizon\", 8))\nannotate!(p, 0.4, 0.035, text(\"Zenith\", 8))\nannotate!(p, 2.5, 0.09, text(\"Diffuse\", 8))\nannotate!(p, 2.5, 0.04, text(\"Direct Beam\", 8))\np\n\nThe canyon albedo generally decreases with H/W as more radiation is trapped and absorbed within deeper canyons. The trapping of solar radiation is less effective at larger solar zenith angles (near horizon), where the albedo can increase at small H/W because the higher-albedo walls dominate the radiative exchange.","category":"section"},{"location":"albedos_radiative_fluxes/#Figure-2.7:-Net-Longwave-Radiation-vs-H/W-Ratio","page":"Albedos and Radiative Fluxes","title":"Figure 2.7: Net Longwave Radiation vs H/W Ratio","text":"Net longwave radiation (positive toward the atmosphere) for urban surfaces with two different emissivity configurations (cf. Figure 2.7, p. 59). The atmospheric longwave radiation is L_atmdownarrow = 340 W m^-2 and the temperature of each surface is 292.16 K. Wall fluxes are per unit wall area.\n\nhw_range_lw = 0.1:0.1:10.0\n\nfunction compute_net_lw(compiled, hw_range; ε_roof, ε_road, ε_wall)\n    road_lw = Float64[]\n    wall_lw = Float64[]\n    roof_lw = Float64[]\n    canyon_lw = Float64[]\n\n    for hw in hw_range\n        p = base_params(compiled; H_W=hw)\n        p[compiled.ε_roof] = ε_roof\n        p[compiled.ε_road] = ε_road\n        p[compiled.ε_wall] = ε_wall\n        sol = solve_urban(compiled, p)\n        push!(road_lw, sol[compiled.L_net_road][end])\n        push!(wall_lw, sol[compiled.L_net_sunwall][end])  # walls equal when T equal\n        push!(roof_lw, sol[compiled.L_net_roof][end])\n        push!(canyon_lw, sol[compiled.L_net_uc][end])\n    end\n    return road_lw, wall_lw, roof_lw, canyon_lw\nend\n\nroad1, wall1, roof1, can1 = compute_net_lw(compiled, hw_range_lw;\n    ε_roof=0.95, ε_road=0.95, ε_wall=0.95)\nroad2, wall2, roof2, can2 = compute_net_lw(compiled, hw_range_lw;\n    ε_roof=0.90, ε_road=0.94, ε_wall=0.85)\n\np1 = plot(hw_range_lw, can1, label=\"Canyon\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\",\n    ylabel=\"Net Longwave Radiation (W m⁻²)\",\n    title=\"Emissivity: Roof=0.95, Road=0.95, Wall=0.95\",\n    legend=:right, ylims=(0, 80))\nplot!(p1, hw_range_lw, roof1, label=\"Roof\", linewidth=2)\nplot!(p1, hw_range_lw, road1, label=\"Road\", linewidth=2)\nplot!(p1, hw_range_lw, wall1, label=\"Walls\", linewidth=2)\n\np2 = plot(hw_range_lw, can2, label=\"Canyon\", linewidth=2,\n    xlabel=\"Canyon H/W Ratio\",\n    ylabel=\"Net Longwave Radiation (W m⁻²)\",\n    title=\"Emissivity: Roof=0.90, Road=0.94, Wall=0.85\",\n    legend=:right, ylims=(0, 80))\nplot!(p2, hw_range_lw, roof2, label=\"Roof\", linewidth=2)\nplot!(p2, hw_range_lw, road2, label=\"Road\", linewidth=2)\nplot!(p2, hw_range_lw, wall2, label=\"Walls\", linewidth=2)\n\np = plot(p1, p2, layout=(2, 1), size=(700, 800))\np\n\nThe net longwave radiation for the roof is independent of H/W and increases with higher emissivity. The net longwave for road and walls decreases rapidly with increasing H/W as more radiation is trapped within the canyon. The walls have lower net longwave than the road because their sky view factors are smaller. The canyon net longwave (sum of road and wall fluxes converted to per unit ground area) increases slowly with H/W because of the larger surface area of the walls.","category":"section"},{"location":"albedos_radiative_fluxes/#UrbanCanopy.UrbanRadiation","page":"Albedos and Radiative Fluxes","title":"UrbanCanopy.UrbanRadiation","text":"UrbanRadiation(; name=:UrbanRadiation)\n\nUrban albedos and radiative fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 2 of Oleson et al. (2010).\n\nComputes the view factors, incident direct beam and diffuse solar radiation, absorbed and reflected solar radiation (with closed-form multi-reflection solution for the urban canyon), incident longwave radiation, and absorbed/reflected/emitted longwave radiation for urban surfaces: roof, sunlit wall, shaded wall, and road.\n\nThe urban canyon is represented as an infinitely long canyon of width W bordered by buildings of height H. Radiation interactions within the canyon account for multiple reflections between walls and road using view factors. The iterative multi-reflection scheme (Eqs. 2.63-2.85, 2.138-2.170) is solved in closed form using the matrix geometric series: S_absorbed = (I - A) * (I - T*A)^{-1} * S_0, where A is the albedo matrix, T is the view-factor transport matrix, and S_0 is the initial incident radiation vector.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 2: Albedos and Radiative Fluxes (pp. 26-60).\n\n\n\n\n\n","category":"function"},{"location":"clmu_introduction/#CLMU-Introduction:-Atmospheric-Interface","page":"CLMU Introduction","title":"CLMU Introduction: Atmospheric Interface","text":"","category":"section"},{"location":"clmu_introduction/#Overview","page":"CLMU Introduction","title":"Overview","text":"The Community Land Model Urban (CLMU) parameterization provides a physically-based representation of urban surfaces for use within the Community Land Model (CLM4). Chapter 1 of the technical note introduces the model structure and defines the atmospheric interface: the forcing variables provided by the atmospheric model, the diagnostic equations for air density and vapor pressure, and the reference height computation.\n\nThe urban surface is represented using the canyon concept (Oke, 1987), where the considerable complexity of the urban surface is reduced to a single urban canyon consisting of a canyon floor of width W bordered by two facing buildings of height H. The urban canyon is divided into five columns: roof, sunlit wall, shaded wall, pervious road, and impervious road.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.","category":"section"},{"location":"clmu_introduction/#Implementation","page":"CLMU Introduction","title":"Implementation","text":"The CLMUAtmosphere component implements three diagnostic equations from Chapter 1:\n\nAtmospheric vapor pressure from specific humidity and pressure\nAir density from pressure, vapor pressure, and temperature\nReference height for flux computations","category":"section"},{"location":"clmu_introduction/#State-Variables","page":"CLMU Introduction","title":"State Variables","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing UrbanCanopy\n\nsys = CLMUAtmosphere()\n\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [dimension(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"clmu_introduction/#Parameters","page":"CLMU Introduction","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [dimension(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"clmu_introduction/#Equations","page":"CLMU Introduction","title":"Equations","text":"eqs = equations(sys)","category":"section"},{"location":"clmu_introduction/#Table-1.1:-Atmospheric-Input-to-Urban-Model","page":"CLMU Introduction","title":"Table 1.1: Atmospheric Input to Urban Model","text":"The atmospheric model provides the following forcing variables to the urban model at each time step (Table 1.1, p. 16). The reference height z_atm is the height above the surface defined as the roughness length z_0 plus displacement height z_d, so the reference height used for flux computations is z_atm = z_atm + z_0 + z_d.\n\nVariable Symbol Units\nReference height z_atm m\nZonal wind at z_atm u_atm m/s\nMeridional wind at z_atm v_atm m/s\nPotential temperature theta_atm K\nSpecific humidity at z_atm q_atm kg/kg\nPressure at z_atm P_atm Pa\nTemperature at z_atm T_atm K\nIncident longwave radiation L_atmdownarrow W/m²\nLiquid precipitation q_rain kg/(m²·s)\nSolid precipitation q_sno kg/(m²·s)\nDirect beam visible solar radiation S_atmdownarrow^mu_vis W/m²\nDirect beam near-infrared solar radiation S_atmdownarrow^mu_nir W/m²\nDiffuse visible solar radiation S_atmdownarrow_vis W/m²\nDiffuse near-infrared solar radiation S_atmdownarrow_nir W/m²\nCarbon dioxide (CO₂) concentration c_a ppmv\nAerosol deposition rate D_sp kg/(m²·s)\nNitrogen deposition rate NF_ndep_sminn g(N)/(m²·yr)\n\nNote: CO₂ concentration, aerosol deposition rate, and nitrogen deposition rate are provided by the atmospheric model but not used by the urban model.","category":"section"},{"location":"clmu_introduction/#Table-1.2:-Urban-Model-Output-to-Atmospheric-Model","page":"CLMU Introduction","title":"Table 1.2: Urban Model Output to Atmospheric Model","text":"The urban model provides the following area-averaged fluxes to the atmospheric model (Table 1.2, p. 18).\n\nVariable Symbol Units\nLatent heat flux lambda E W/m²\nSensible heat flux H W/m²\nWater vapor flux E mm/s\nZonal momentum flux tau_x kg/(m·s²)\nMeridional momentum flux tau_y kg/(m·s²)\nEmitted longwave radiation Luparrow W/m²\nDirect beam visible albedo Iuparrow^mu_vis -\nDirect beam near-infrared albedo Iuparrow^mu_nir -\nDiffuse visible albedo Iuparrow_vis -\nDiffuse near-infrared albedo Iuparrow_nir -\nAbsorbed solar radiation vecS W/m²\nRadiative temperature T_rad K\nTemperature at 2 meter height T_2m K\nSpecific humidity at 2 meter height q_2m kg/kg\nSnow water equivalent W_sno m\nAerodynamic resistance r_am s/m\nFriction velocity u_* m/s\nDust flux F_j kg/(m²·s)\nNet ecosystem exchange NEE kgCO₂/(m²·s)\n\nNote: lambda is either the latent heat of vaporization lambda_vap or latent heat of sublimation lambda_sub (Table 1.4) depending on the thermal state of surface water on the roof, pervious and impervious road. Dust flux and net ecosystem exchange are set to zero for urban areas.","category":"section"},{"location":"clmu_introduction/#Table-1.3:-Input-Data-Required-for-the-Urban-Model","page":"CLMU Introduction","title":"Table 1.3: Input Data Required for the Urban Model","text":"Required input data for urban landunits are listed in Table 1.3 (p. 23). This data is provided by the surface dataset at the required spatial resolution.\n\nData Symbol Units\nPercent urban - %\nCanyon height to width ratio HW -\nRoof fraction W_roof -\nPervious road fraction f_prvrd -\nEmissivity of roof varepsilon_roof -\nEmissivity of impervious road varepsilon_imprvrd -\nEmissivity of pervious road varepsilon_prvrd -\nEmissivity of walls varepsilon_wall -\nBuilding height H m\nRoof albedo (visible direct/diffuse, near-infrared direct/diffuse) alpha_roof -\nWall albedo (visible direct/diffuse, near-infrared direct/diffuse) alpha_walls -\nImpervious road albedo (visible direct/diffuse, near-infrared direct/diffuse) alpha_imprvrd -\nPervious road albedo (visible direct/diffuse, near-infrared direct/diffuse) alpha_prvrd -\nRoof thermal conductivity lambda_roofi W/(m·K)\nWall thermal conductivity lambda_walli W/(m·K)\nImpervious road thermal conductivity lambda_imprvrdi W/(m·K)\nPervious road thermal conductivity lambda_prvrdi W/(m·K)\nRoof volumetric heat capacity c_roofi J/(m³·K)\nWall volumetric heat capacity c_walli J/(m³·K)\nImpervious road volumetric heat capacity c_imprvrdi J/(m³·K)\nPervious road volumetric heat capacity c_prvrdi J/(m³·K)\nMaximum interior building temperature T_iBmax K\nMinimum interior building temperature T_iBmin K\nHeight of wind source in canyon H_w m\nNumber of impervious road layers N_imprvrd -\nWall thickness Delta z_wall m\nRoof thickness Delta z_roof m\nPercent sand, percent clay of pervious road (soil) %sand, %clay %\nGrid cell latitude and longitude phi theta degrees","category":"section"},{"location":"clmu_introduction/#Table-1.4:-Physical-Constants","page":"CLMU Introduction","title":"Table 1.4: Physical Constants","text":"Physical constants used by the CLMU, shared by all components of CCSM (Table 1.4, p. 25).\n\nConstant Symbol Value Units\nPi pi 3.14159265358979323846 -\nAcceleration of gravity g 9.80616 m/s²\nStandard pressure P_std 101325 Pa\nStefan-Boltzmann constant sigma 5.67 × 10⁻⁸ W/(m²·K⁴)\nBoltzmann constant kappa 1.38065 × 10⁻²³ J/K\nAvogadro's number N_A 6.02214 × 10²⁶ molecule/kmol\nUniversal gas constant R_gas N_A kappa J/(K·kmol)\nMolecular weight of dry air MW_da 28.966 kg/kmol\nDry air gas constant R_da R_gasMW_da J/(K·kg)\nMolecular weight of water vapor MW_wv 18.016 kg/kmol\nWater vapor gas constant R_wv R_gasMW_wv J/(K·kg)\nVon Karman constant k 0.4 -\nFreezing temperature of fresh water T_f 273.15 K\nDensity of liquid water rho_liq 1000 kg/m³\nDensity of ice rho_ice 917 kg/m³\nSpecific heat capacity of dry air C_p 1.00464 × 10³ J/(kg·K)\nSpecific heat capacity of water C_liq 4.188 × 10³ J/(kg·K)\nSpecific heat capacity of ice C_ice 2.11727 × 10³ J/(kg·K)\nLatent heat of vaporization lambda_vap 2.501 × 10⁶ J/kg\nLatent heat of fusion L_f 3.337 × 10⁵ J/kg\nLatent heat of sublimation lambda_sub lambda_vap + L_f J/kg\nThermal conductivity of water lambda_liq 0.6 W/(m·K)\nThermal conductivity of ice lambda_ice 2.29 W/(m·K)\nThermal conductivity of air lambda_air 0.023 W/(m·K)\nRadius of the earth R_e 6.37122 × 10⁶ m","category":"section"},{"location":"clmu_introduction/#Analysis","page":"CLMU Introduction","title":"Analysis","text":"","category":"section"},{"location":"clmu_introduction/#Air-Density-vs.-Temperature","page":"CLMU Introduction","title":"Air Density vs. Temperature","text":"The air density equation from Chapter 1 (p. 17) computes atmospheric density as a function of pressure, temperature, and vapor pressure. For dry air, this reduces to the ideal gas law: rho = P  (R_da T). The following figure shows how air density varies with temperature at standard pressure for both dry and moist air.\n\nusing OrdinaryDiffEqDefault\nusing Plots\n\ncompiled = mtkcompile(sys)\n\nT_range = 250.0:5.0:320.0\nρ_dry = Float64[]\nρ_moist = Float64[]\n\nfor T_val in T_range\n    prob = ODEProblem(\n        compiled,\n        Dict(\n            compiled.q_atm => 0.0,\n            compiled.P_atm => 101325.0,\n            compiled.T_atm => T_val,\n            compiled.z_prime_atm => 30.0,\n            compiled.z_0 => 1.0,\n            compiled.z_d => 5.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol = solve(prob)\n    push!(ρ_dry, sol[compiled.ρ_atm][end])\n\n    prob_m = ODEProblem(\n        compiled,\n        Dict(\n            compiled.q_atm => 0.015,\n            compiled.P_atm => 101325.0,\n            compiled.T_atm => T_val,\n            compiled.z_prime_atm => 30.0,\n            compiled.z_0 => 1.0,\n            compiled.z_d => 5.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol_m = solve(prob_m)\n    push!(ρ_moist, sol_m[compiled.ρ_atm][end])\nend\n\np = plot(T_range, ρ_dry, label=\"Dry air (q=0)\", xlabel=\"Temperature (K)\",\n    ylabel=\"Air density (kg/m³)\", title=\"Air Density vs Temperature at P=101325 Pa\",\n    linewidth=2, legend=:topright)\nplot!(p, T_range, ρ_moist, label=\"Moist air (q=0.015 kg/kg)\", linewidth=2, linestyle=:dash)\np\n\nAt all temperatures, moist air is less dense than dry air at the same pressure, consistent with the lower molecular weight of water vapor (18.016 kg/kmol) compared to dry air (28.966 kg/kmol).","category":"section"},{"location":"clmu_introduction/#Vapor-Pressure-vs.-Specific-Humidity","page":"CLMU Introduction","title":"Vapor Pressure vs. Specific Humidity","text":"The vapor pressure equation relates the atmospheric vapor pressure to specific humidity and total pressure. This relationship is approximately linear for small specific humidities but becomes nonlinear at higher moisture content.\n\nq_range = 0.0:0.001:0.03\ne_vals = Float64[]\n\nfor q_val in q_range\n    prob = ODEProblem(\n        compiled,\n        Dict(\n            compiled.q_atm => q_val,\n            compiled.P_atm => 101325.0,\n            compiled.T_atm => 293.15,\n            compiled.z_prime_atm => 30.0,\n            compiled.z_0 => 1.0,\n            compiled.z_d => 5.0,\n        ),\n        (0.0, 1.0),\n    )\n    sol = solve(prob)\n    push!(e_vals, sol[compiled.e_atm][end])\nend\n\np = plot(q_range .* 1000, e_vals, xlabel=\"Specific humidity (g/kg)\",\n    ylabel=\"Vapor pressure (Pa)\",\n    title=\"Atmospheric Vapor Pressure vs Specific Humidity\\nat P=101325 Pa\",\n    linewidth=2, legend=false)\np","category":"section"},{"location":"clmu_introduction/#UrbanCanopy.CLMUAtmosphere","page":"CLMU Introduction","title":"UrbanCanopy.CLMUAtmosphere","text":"CLMUAtmosphere(; name=:CLMUAtmosphere)\n\nAtmospheric interface for the Community Land Model Urban (CLMU) parameterization. Computes atmospheric density, vapor pressure, and reference height from atmospheric forcing variables, following Chapter 1 of Oleson et al. (2010).\n\nThe CLMU represents the urban surface using a canyon concept (Oke, 1987) consisting of a canyon floor of width W bordered by two facing buildings of height H. The urban canyon is divided into five columns: roof, sunlit wall, shaded wall, pervious road, and impervious road. This component defines the atmospheric forcing interface and the diagnostic equations that connect atmospheric model variables to the urban canopy model.\n\nReference: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp.\n\n\n\n\n\n","category":"function"},{"location":"#UrbanCanopy.jl","page":"Home","title":"UrbanCanopy.jl","text":"Documentation for UrbanCanopy.jl.\n\nUrbanCanopy.jl implements urban canopy processes for the EarthSciML framework, including urban heat island effects, building energy balance, urban surface exchange, anthropogenic heat fluxes, and urban boundary layer interactions.\n\n","category":"section"}]
}
