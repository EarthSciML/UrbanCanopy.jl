<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Heat and Momentum Fluxes · UrbanCanopy.jl</title><meta name="title" content="Heat and Momentum Fluxes · UrbanCanopy.jl"/><meta property="og:title" content="Heat and Momentum Fluxes · UrbanCanopy.jl"/><meta property="twitter:title" content="Heat and Momentum Fluxes · UrbanCanopy.jl"/><meta name="description" content="Documentation for UrbanCanopy.jl."/><meta property="og:description" content="Documentation for UrbanCanopy.jl."/><meta property="twitter:description" content="Documentation for UrbanCanopy.jl."/><meta property="og:url" content="https://urbancanopy.earthsci.dev/heat_momentum_fluxes/"/><meta property="twitter:url" content="https://urbancanopy.earthsci.dev/heat_momentum_fluxes/"/><link rel="canonical" href="https://urbancanopy.earthsci.dev/heat_momentum_fluxes/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">UrbanCanopy.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../clmu_introduction/">CLMU Introduction</a></li><li><a class="tocitem" href="../albedos_radiative_fluxes/">Albedos and Radiative Fluxes</a></li><li class="is-active"><a class="tocitem" href>Heat and Momentum Fluxes</a><ul class="internal"><li><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Implementation"><span>Implementation</span></a></li><li><a class="tocitem" href="#Analysis"><span>Analysis</span></a></li></ul></li><li><a class="tocitem" href="../roof_wall_road_snow_temperatures/">Roof, Wall, Road, Snow Temperatures</a></li><li><a class="tocitem" href="../hydrology/">Hydrology</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Heat and Momentum Fluxes</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Heat and Momentum Fluxes</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/EarthSciML/UrbanCanopy.jl/blob/main/docs/src/heat_momentum_fluxes.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Heat-and-Momentum-Fluxes"><a class="docs-heading-anchor" href="#Heat-and-Momentum-Fluxes">Heat and Momentum Fluxes</a><a id="Heat-and-Momentum-Fluxes-1"></a><a class="docs-heading-anchor-permalink" href="#Heat-and-Momentum-Fluxes" title="Permalink"></a></h1><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>Chapter 3 of the CLMU technical note describes the computation of heat and momentum fluxes for urban surfaces using Monin-Obukhov similarity theory. These fluxes drive the surface energy balance and determine the exchange of energy and momentum between the urban surface and the atmospheric boundary layer.</p><p>The <code>HeatMomentumFluxes</code> component computes:</p><ol><li><strong>Roughness length and displacement height</strong> from canyon geometry using the MacDonald et al. (1998) formulation (Eqs. 3.55-3.58)</li><li><strong>Stability correction functions</strong> <span>$\psi_m$</span> and <span>$\psi_h$</span> for four regimes: very unstable (<span>$\zeta &lt; -1.574$</span>), unstable (<span>$-1.574 \leq \zeta &lt; 0$</span>), stable (<span>$0 \leq \zeta \leq 1$</span>), and very stable (<span>$\zeta &gt; 1$</span>) (Eqs. 3.31-3.46)</li><li><strong>Convective velocity</strong> <span>$U_c$</span> for unstable conditions using the convective velocity scale <span>$w_*$</span> (Eqs. 3.25, 3.29-3.30)</li><li><strong>Friction velocity</strong> <span>$u_*$</span> and aerodynamic resistances <span>$r_{am}$</span>, <span>$r_{ah}$</span>, <span>$r_{aw}$</span> (Eqs. 3.26, 3.65-3.67)</li><li><strong>Canyon wind speed</strong> for three flow regimes: isolated (<span>$H/W &lt; 0.5$</span>), wake interference (<span>$0.5 \leq H/W &lt; 1$</span>), and skimming (<span>$H/W \geq 1$</span>) (Eqs. 3.59-3.62)</li><li><strong>Surface resistance</strong> for heat and moisture exchange (Eq. 3.68)</li><li><strong>UCL air temperature and humidity</strong> as conductance-weighted averages (Eqs. 3.75, 3.93)</li><li><strong>Sensible heat fluxes</strong> for all five surfaces (roof, pervious road, impervious road, sunlit wall, shaded wall) and the area-weighted total (Eqs. 3.69-3.74)</li><li><strong>Water vapor fluxes</strong> for roof, pervious road, and impervious road (walls have zero evaporation) (Eqs. 3.76-3.81)</li><li><strong>Momentum fluxes</strong> <span>$\tau_x$</span> and <span>$\tau_y$</span> (Eqs. 3.6-3.7)</li><li><strong>Partial derivatives</strong> <span>$\partial H / \partial T_g$</span> for all five surfaces,  needed for the implicit soil temperature calculation (Eqs. 3.95-3.99)</li></ol><p>The Monin-Obukhov stability parameter <span>$\zeta$</span> is taken as an input parameter, since in the original CLM implementation it is computed through an iterative procedure (Section 3.2.3). This avoids an algebraic loop and allows the system to be solved as a directed algebraic system.</p><p><strong>Reference</strong>: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 3: Heat and Momentum Fluxes (pp. 61-89).</p><article><details class="docstring" open="true"><summary id="UrbanCanopy.HeatMomentumFluxes"><a class="docstring-binding" href="#UrbanCanopy.HeatMomentumFluxes"><code>UrbanCanopy.HeatMomentumFluxes</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">HeatMomentumFluxes(; name=:HeatMomentumFluxes)</code></pre><p>Urban heat and momentum fluxes for the Community Land Model Urban (CLMU) parameterization, following Chapter 3 of Oleson et al. (2010).</p><p>Computes the Monin-Obukhov similarity theory parameters, roughness length and displacement height, wind speed in the urban canyon, aerodynamic and surface resistances, sensible and latent heat fluxes for the five urban surfaces (roof, sunlit wall, shaded wall, pervious road, impervious road), total momentum fluxes, and the UCL air temperature and specific humidity.</p><p>The Monin-Obukhov stability parameter ζ is taken as an input parameter, since in the original CLM implementation it is computed through an iterative procedure (Section 3.2.3). Given ζ, the system computes all stability corrections, friction velocity, aerodynamic resistances, and surface fluxes as a directed algebraic system without circular dependencies.</p><p><strong>Reference</strong>: Oleson, K.W., G.B. Bonan, J.J. Feddema, M. Vertenstein, and E. Kluzek, 2010: Technical Description of an Urban Parameterization for the Community Land Model (CLMU). NCAR Technical Note NCAR/TN-480+STR, National Center for Atmospheric Research, Boulder, CO, 168 pp. Chapter 3: Heat and Momentum Fluxes (pp. 61-89).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/UrbanCanopy.jl/blob/0f0a758aaf0843c3b7b0fab038a1512705d1603a/src/heat_momentum_fluxes.jl#L3-L25">source</a></section></details></article><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><p>The <code>HeatMomentumFluxes</code> component implements the heat and momentum flux parameterization with 48 equations and 48 unknowns.</p><h3 id="State-Variables"><a class="docs-heading-anchor" href="#State-Variables">State Variables</a><a id="State-Variables-1"></a><a class="docs-heading-anchor-permalink" href="#State-Variables" title="Permalink"></a></h3><pre><code class="language-julia hljs">using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities
using UrbanCanopy

sys = HeatMomentumFluxes()

vars = unknowns(sys)
DataFrame(
    :Name =&gt; [string(Symbolics.tosymbol(v, escape = false)) for v in vars],
    :Units =&gt; [dimension(ModelingToolkit.get_unit(v)) for v in vars],
    :Description =&gt; [ModelingToolkit.getdescription(v) for v in vars]
)</code></pre><div><div style = "float: left;"><span>48×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">Name</th><th style = "text-align: left;">Units</th><th style = "text-align: left;">Description</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "DynamicQuantities.Dimensions{DynamicQuantities.FRInt32}" style = "text-align: left;">Dimensio…</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">λ_p</td><td style = "text-align: left;"></td><td style = "text-align: left;">Plan area index (Eq. 3.56) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">λ_F</td><td style = "text-align: left;"></td><td style = "text-align: left;">Frontal area index (Eq. 3.58) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">d_canopy</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Canopy displacement height (Eq. 3.55)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">z_0m_canopy</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Canopy roughness length for momentum (Eq. 3.57)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">V_r</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Reference level atmospheric wind (Eq. 3.63)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: left;">L_MO</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Monin-Obukhov length (Eq. 3.17)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: left;">ζ_0m</td><td style = "text-align: left;"></td><td style = "text-align: left;">Stability parameter at z_0m (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">8</td><td style = "text-align: left;">ζ_h</td><td style = "text-align: left;"></td><td style = "text-align: left;">Stability parameter for heat at z_atm_h (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">9</td><td style = "text-align: left;">ζ_0h</td><td style = "text-align: left;"></td><td style = "text-align: left;">Stability parameter at z_0h (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">10</td><td style = "text-align: left;">ζ_w</td><td style = "text-align: left;"></td><td style = "text-align: left;">Stability parameter for moisture at z_atm_w (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">11</td><td style = "text-align: left;">ζ_0w</td><td style = "text-align: left;"></td><td style = "text-align: left;">Stability parameter at z_0w (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">12</td><td style = "text-align: left;">ψ_m_atm</td><td style = "text-align: left;"></td><td style = "text-align: left;">Momentum stability correction at ζ (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">13</td><td style = "text-align: left;">ψ_m_0</td><td style = "text-align: left;"></td><td style = "text-align: left;">Momentum stability correction at ζ_0m (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">14</td><td style = "text-align: left;">ψ_h_atm</td><td style = "text-align: left;"></td><td style = "text-align: left;">Heat stability correction at ζ_h (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">15</td><td style = "text-align: left;">ψ_h_0</td><td style = "text-align: left;"></td><td style = "text-align: left;">Heat stability correction at ζ_0h (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">16</td><td style = "text-align: left;">ψ_w_atm</td><td style = "text-align: left;"></td><td style = "text-align: left;">Moisture stability correction at ζ_w (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">17</td><td style = "text-align: left;">ψ_w_0</td><td style = "text-align: left;"></td><td style = "text-align: left;">Moisture stability correction at ζ_0w (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">18</td><td style = "text-align: left;">θ_v_atm</td><td style = "text-align: left;">K</td><td style = "text-align: left;">Virtual potential temperature at reference height (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">19</td><td style = "text-align: left;">U_c</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Convective velocity (Eq. 3.29)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">20</td><td style = "text-align: left;">V_a</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Effective wind speed (Eq. 3.25)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">21</td><td style = "text-align: left;">u_star</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Friction velocity (Eq. 3.26)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">22</td><td style = "text-align: left;">r_am</td><td style = "text-align: left;">m⁻¹ s</td><td style = "text-align: left;">Aerodynamic resistance for momentum (Eq. 3.65)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">23</td><td style = "text-align: left;">r_ah</td><td style = "text-align: left;">m⁻¹ s</td><td style = "text-align: left;">Aerodynamic resistance for sensible heat (Eq. 3.66)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">24</td><td style = "text-align: left;">r_aw</td><td style = "text-align: left;">m⁻¹ s</td><td style = "text-align: left;">Aerodynamic resistance for water vapor (Eq. 3.67)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">25</td><td style = "text-align: left;">U_can</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Canyon horizontal wind speed (Eqs. 3.60-3.62)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">26</td><td style = "text-align: left;">U_ac</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Canyon wind speed (Eq. 3.59)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">27</td><td style = "text-align: left;">r_s_u</td><td style = "text-align: left;">m⁻¹ s</td><td style = "text-align: left;">Surface resistance for all urban surfaces (Eq. 3.68)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">28</td><td style = "text-align: left;">c_a_h</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Sensible heat conductance UCL to atmosphere (1/r_ah)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">29</td><td style = "text-align: left;">c_a_w</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Latent heat conductance UCL to atmosphere (1/r_aw)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">30</td><td style = "text-align: left;">T_ac</td><td style = "text-align: left;">K</td><td style = "text-align: left;">UCL air temperature (Eq. 3.75)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">31</td><td style = "text-align: left;">q_ac</td><td style = "text-align: left;"></td><td style = "text-align: left;">UCL air specific humidity (Eq. 3.93)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">32</td><td style = "text-align: left;">H_roof</td><td style = "text-align: left;">kg s⁻³</td><td style = "text-align: left;">Sensible heat flux from roof (Eq. 3.69)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">33</td><td style = "text-align: left;">H_prvrd</td><td style = "text-align: left;">kg s⁻³</td><td style = "text-align: left;">Sensible heat flux from pervious road (Eq. 3.70)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">34</td><td style = "text-align: left;">H_imprvrd</td><td style = "text-align: left;">kg s⁻³</td><td style = "text-align: left;">Sensible heat flux from impervious road (Eq. 3.71)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">35</td><td style = "text-align: left;">H_sunwall</td><td style = "text-align: left;">kg s⁻³</td><td style = "text-align: left;">Sensible heat flux from sunlit wall (Eq. 3.72)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">36</td><td style = "text-align: left;">H_shdwall</td><td style = "text-align: left;">kg s⁻³</td><td style = "text-align: left;">Sensible heat flux from shaded wall (Eq. 3.73)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">37</td><td style = "text-align: left;">H_total</td><td style = "text-align: left;">kg s⁻³</td><td style = "text-align: left;">Total sensible heat flux (Eq. 3.74)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">38</td><td style = "text-align: left;">E_roof</td><td style = "text-align: left;">m⁻² kg s⁻¹</td><td style = "text-align: left;">Water vapor flux from roof (Eq. 3.76)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">39</td><td style = "text-align: left;">E_prvrd</td><td style = "text-align: left;">m⁻² kg s⁻¹</td><td style = "text-align: left;">Water vapor flux from pervious road (Eq. 3.77)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">40</td><td style = "text-align: left;">E_imprvrd</td><td style = "text-align: left;">m⁻² kg s⁻¹</td><td style = "text-align: left;">Water vapor flux from impervious road (Eq. 3.78)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">41</td><td style = "text-align: left;">E_total</td><td style = "text-align: left;">m⁻² kg s⁻¹</td><td style = "text-align: left;">Total water vapor flux (Eq. 3.81)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">42</td><td style = "text-align: left;">τ_x</td><td style = "text-align: left;">m⁻¹ kg s⁻²</td><td style = "text-align: left;">Zonal momentum flux (Eq. 3.6)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">43</td><td style = "text-align: left;">τ_y</td><td style = "text-align: left;">m⁻¹ kg s⁻²</td><td style = "text-align: left;">Meridional momentum flux (Eq. 3.7)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">44</td><td style = "text-align: left;">dH_roof_dT</td><td style = "text-align: left;">kg s⁻³ K⁻¹</td><td style = "text-align: left;">∂H_roof/∂T_g,roof (Eq. 3.95)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">45</td><td style = "text-align: left;">dH_prvrd_dT</td><td style = "text-align: left;">kg s⁻³ K⁻¹</td><td style = "text-align: left;">∂H_prvrd/∂T_g,prvrd (Eq. 3.96)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">46</td><td style = "text-align: left;">dH_imprvrd_dT</td><td style = "text-align: left;">kg s⁻³ K⁻¹</td><td style = "text-align: left;">∂H_imprvrd/∂T_g,imprvrd (Eq. 3.97)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">47</td><td style = "text-align: left;">dH_sunwall_dT</td><td style = "text-align: left;">kg s⁻³ K⁻¹</td><td style = "text-align: left;">∂H_sunwall/∂T_g,sunwall (Eq. 3.98)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">48</td><td style = "text-align: left;">dH_shdwall_dT</td><td style = "text-align: left;">kg s⁻³ K⁻¹</td><td style = "text-align: left;">∂H_shdwall/∂T_g,shdwall (Eq. 3.99)</td></tr></tbody></table></div><h3 id="Parameters"><a class="docs-heading-anchor" href="#Parameters">Parameters</a><a id="Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Parameters" title="Permalink"></a></h3><pre><code class="language-julia hljs">params = parameters(sys)
DataFrame(
    :Name =&gt; [string(Symbolics.tosymbol(p, escape = false)) for p in params],
    :Units =&gt; [dimension(ModelingToolkit.get_unit(p)) for p in params],
    :Description =&gt; [ModelingToolkit.getdescription(p) for p in params]
)</code></pre><div><div style = "float: left;"><span>43×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">Name</th><th style = "text-align: left;">Units</th><th style = "text-align: left;">Description</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "DynamicQuantities.Dimensions{DynamicQuantities.FRInt32}" style = "text-align: left;">Dimensio…</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">z_i</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Convective boundary layer height (Eq. 3.30)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">c_virt</td><td style = "text-align: left;"></td><td style = "text-align: left;">Virtual potential temperature coefficient, (ε-1) where ε=M_a/M_w (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">C_p</td><td style = "text-align: left;">m² s⁻² K⁻¹</td><td style = "text-align: left;">Specific heat capacity of dry air (Table 1.4)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">T_g_shdwall</td><td style = "text-align: left;">K</td><td style = "text-align: left;">Shaded wall surface temperature</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">H_W</td><td style = "text-align: left;"></td><td style = "text-align: left;">Canyon height to width ratio H/W (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: left;">θ_atm</td><td style = "text-align: left;">K</td><td style = "text-align: left;">Atmospheric potential temperature (Eq. 3.8)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: left;">C_D</td><td style = "text-align: left;"></td><td style = "text-align: left;">Depth-integrated mean drag coefficient (Eq. 3.57) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">8</td><td style = "text-align: left;">c_vu_h</td><td style = "text-align: left;"></td><td style = "text-align: left;">Very unstable heat correction coefficient (Eq. 3.38) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">9</td><td style = "text-align: left;">ρ_atm</td><td style = "text-align: left;">m⁻³ kg</td><td style = "text-align: left;">Atmospheric air density (Eq. 3.9)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">10</td><td style = "text-align: left;">ζ_h_threshold</td><td style = "text-align: left;"></td><td style = "text-align: left;">Very unstable transition for ψ_h, from matching φ_h at ζ_h (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">11</td><td style = "text-align: left;">z_atm_m</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Reference height for wind (momentum)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">12</td><td style = "text-align: left;">W_roof</td><td style = "text-align: left;"></td><td style = "text-align: left;">Roof fraction of urban surface (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">13</td><td style = "text-align: left;">h_c_free</td><td style = "text-align: left;">kg s⁻³ K⁻¹</td><td style = "text-align: left;">Free convection coefficient in surface resistance (Eq. 3.68)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">14</td><td style = "text-align: left;">H_canyon</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Canyon (building/roof) height</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">15</td><td style = "text-align: left;">z_atm_h</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Reference height for temperature (sensible heat)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">16</td><td style = "text-align: left;">H_w_est</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Height at which canyon wind speed is estimated (Table 1.3)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">17</td><td style = "text-align: left;">q_atm</td><td style = "text-align: left;"></td><td style = "text-align: left;">Atmospheric specific humidity</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">18</td><td style = "text-align: left;">h_c_forced</td><td style = "text-align: left;">m⁻¹ kg s⁻² K⁻¹</td><td style = "text-align: left;">Forced convection coefficient in surface resistance (Eq. 3.68)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">19</td><td style = "text-align: left;">B_drag</td><td style = "text-align: left;"></td><td style = "text-align: left;">Drag correction coefficient (Eq. 3.57) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">20</td><td style = "text-align: left;">q_g_prvrd</td><td style = "text-align: left;"></td><td style = "text-align: left;">Pervious road surface specific humidity</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">21</td><td style = "text-align: left;">a_BD</td><td style = "text-align: left;"></td><td style = "text-align: left;">Businger-Dyer stable parameter (Eqs. 3.31-3.32) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">22</td><td style = "text-align: left;">T_g_prvrd</td><td style = "text-align: left;">K</td><td style = "text-align: left;">Pervious road surface temperature</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">23</td><td style = "text-align: left;">f_wet_imprvrd</td><td style = "text-align: left;"></td><td style = "text-align: left;">Wetted fraction of impervious road (Eqs. 3.82-3.83) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">24</td><td style = "text-align: left;">π_val</td><td style = "text-align: left;"></td><td style = "text-align: left;">Pi (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">25</td><td style = "text-align: left;">γ_BD</td><td style = "text-align: left;"></td><td style = "text-align: left;">Businger-Dyer unstable parameter (Eqs. 3.31-3.32) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">26</td><td style = "text-align: left;">T_g_roof</td><td style = "text-align: left;">K</td><td style = "text-align: left;">Roof surface temperature</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">27</td><td style = "text-align: left;">u_atm</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Zonal wind at reference height</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">28</td><td style = "text-align: left;">z_atm_w</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Reference height for humidity (water vapor)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">29</td><td style = "text-align: left;">v_atm</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Meridional wind at reference height</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">30</td><td style = "text-align: left;">ζ_in</td><td style = "text-align: left;"></td><td style = "text-align: left;">Monin-Obukhov stability parameter ζ = (z_atm_m - d)/L, from iterative solution (Eqs. 3.47-3.50) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">31</td><td style = "text-align: left;">α_rough</td><td style = "text-align: left;"></td><td style = "text-align: left;">Empirical coefficient for displacement height (Eq. 3.55) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">32</td><td style = "text-align: left;">f_prvrd</td><td style = "text-align: left;"></td><td style = "text-align: left;">Fraction of road that is pervious (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">33</td><td style = "text-align: left;">q_g_imprvrd</td><td style = "text-align: left;"></td><td style = "text-align: left;">Impervious road surface saturated specific humidity</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">34</td><td style = "text-align: left;">ζ_m_threshold</td><td style = "text-align: left;"></td><td style = "text-align: left;">Very unstable transition for ψ_m, from matching φ_m at ζ_m (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">35</td><td style = "text-align: left;">one_ms</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Unit velocity</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">36</td><td style = "text-align: left;">q_g_roof</td><td style = "text-align: left;"></td><td style = "text-align: left;">Roof surface saturated specific humidity</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">37</td><td style = "text-align: left;">β_conv</td><td style = "text-align: left;"></td><td style = "text-align: left;">Convective velocity coefficient (Eq. 3.29) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">38</td><td style = "text-align: left;">T_g_imprvrd</td><td style = "text-align: left;">K</td><td style = "text-align: left;">Impervious road surface temperature</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">39</td><td style = "text-align: left;">T_g_sunwall</td><td style = "text-align: left;">K</td><td style = "text-align: left;">Sunlit wall surface temperature</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">40</td><td style = "text-align: left;">zero_ms</td><td style = "text-align: left;">m s⁻¹</td><td style = "text-align: left;">Zero velocity</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">41</td><td style = "text-align: left;">k_vk</td><td style = "text-align: left;"></td><td style = "text-align: left;">von Karman constant (Table 1.4) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">42</td><td style = "text-align: left;">c_vu_m</td><td style = "text-align: left;"></td><td style = "text-align: left;">Very unstable momentum correction coefficient (Eq. 3.33) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">43</td><td style = "text-align: left;">f_wet_roof</td><td style = "text-align: left;"></td><td style = "text-align: left;">Wetted fraction of roof (Eqs. 3.82-3.83) (dimensionless)</td></tr></tbody></table></div><h3 id="Equations"><a class="docs-heading-anchor" href="#Equations">Equations</a><a id="Equations-1"></a><a class="docs-heading-anchor-permalink" href="#Equations" title="Permalink"></a></h3><pre><code class="language-julia hljs">eqs = equations(sys)</code></pre><p class="math-container">\[ \begin{align}
\mathtt{\lambda\_p}\left( t \right) &amp;= \frac{\mathtt{H\_W}}{1 + \mathtt{H\_W}} \\
\mathtt{\lambda\_F}\left( t \right) &amp;= \mathtt{H\_W} \left( 1 - \mathtt{\lambda\_p}\left( t \right) \right) \\
\mathtt{d\_canopy}\left( t \right) &amp;= \mathtt{H\_canyon} \left( 1 + \mathtt{\alpha\_rough}^{ - \mathtt{\lambda\_p}\left( t \right)} \left( -1 + \mathtt{\lambda\_p}\left( t \right) \right) \right) \\
\mathtt{z\_0m\_canopy}\left( t \right) &amp;= \mathtt{H\_canyon} e^{ - \frac{1}{\left( \frac{0.5 \mathtt{B\_drag} \mathtt{C\_D} \mathtt{\lambda\_F}\left( t \right) \left( 1 + \frac{ - \mathtt{d\_canopy}\left( t \right)}{\mathtt{H\_canyon}} \right)}{\mathtt{k\_vk}^{2}} \right)^{0.5}}} \left( 1 + \frac{ - \mathtt{d\_canopy}\left( t \right)}{\mathtt{H\_canyon}} \right) \\
\mathtt{V\_r}\left( t \right) &amp;= max\left( \sqrt{\mathtt{u\_atm}^{2} + \mathtt{v\_atm}^{2}}, \mathtt{one\_ms} \right) \\
\mathtt{L\_MO}\left( t \right) &amp;= \frac{\mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{\zeta\_in}} \\
\mathtt{\zeta\_0m}\left( t \right) &amp;= \frac{\mathtt{z\_0m\_canopy}\left( t \right)}{\mathtt{L\_MO}\left( t \right)} \\
\mathtt{\zeta\_h}\left( t \right) &amp;= \frac{\mathtt{z\_atm\_h} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{L\_MO}\left( t \right)} \\
\mathtt{\zeta\_0h}\left( t \right) &amp;= \frac{\mathtt{z\_0m\_canopy}\left( t \right)}{\mathtt{L\_MO}\left( t \right)} \\
\mathtt{\zeta\_w}\left( t \right) &amp;= \frac{\mathtt{z\_atm\_w} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{L\_MO}\left( t \right)} \\
\mathtt{\zeta\_0w}\left( t \right) &amp;= \frac{\mathtt{z\_0m\_canopy}\left( t \right)}{\mathtt{L\_MO}\left( t \right)} \\
\mathtt{\psi\_m\_atm}\left( t \right) &amp;= ifelse\left( \mathtt{\zeta\_in} &lt; \mathtt{\zeta\_m\_threshold}, 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_m\_threshold} \right)^{0.25} \right) \right) - 2 \arctan\left( \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_m\_threshold} \right)^{0.25} \right) + \log\left( \frac{\mathtt{\zeta\_in}}{\mathtt{\zeta\_m\_threshold}} \right) + \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_m\_threshold} \right)^{0.5} \right) \right) + \frac{1}{2} \mathtt{\pi\_val} - \mathtt{c\_vu\_m} \left( \left(  - \mathtt{\zeta\_in} \right)^{0.33333} - \left(  - \mathtt{\zeta\_m\_threshold} \right)^{0.33333} \right), ifelse\left( \mathtt{\zeta\_in} &lt; 0, \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_in} \right)^{0.5} \right) \right) - 2 \arctan\left( \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_in} \right)^{0.25} \right) + 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_in} \right)^{0.25} \right) \right) + \frac{1}{2} \mathtt{\pi\_val}, ifelse\left( \mathtt{\zeta\_in} \leq 1,  - \mathtt{a\_BD} \mathtt{\zeta\_in}, 1 - \mathtt{a\_BD} - \mathtt{\zeta\_in} + \left( 1 - \mathtt{a\_BD} \right) \log\left( \mathtt{\zeta\_in} \right) \right) \right) \right) \\
\mathtt{\psi\_m\_0}\left( t \right) &amp;= ifelse\left( \mathtt{\zeta\_0m}\left( t \right) &lt; \mathtt{\zeta\_m\_threshold}, 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_m\_threshold} \right)^{0.25} \right) \right) - 2 \arctan\left( \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_m\_threshold} \right)^{0.25} \right) + \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_m\_threshold} \right)^{0.5} \right) \right) + \log\left( \frac{\mathtt{\zeta\_0m}\left( t \right)}{\mathtt{\zeta\_m\_threshold}} \right) + \frac{1}{2} \mathtt{\pi\_val} - \mathtt{c\_vu\_m} \left( \left(  - \mathtt{\zeta\_0m}\left( t \right) \right)^{0.33333} - \left(  - \mathtt{\zeta\_m\_threshold} \right)^{0.33333} \right), ifelse\left( \mathtt{\zeta\_0m}\left( t \right) &lt; 0, 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\zeta\_0m}\left( t \right) \mathtt{\gamma\_BD} \right)^{0.25} \right) \right) - 2 \arctan\left( \left( 1 - \mathtt{\zeta\_0m}\left( t \right) \mathtt{\gamma\_BD} \right)^{0.25} \right) + \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\zeta\_0m}\left( t \right) \mathtt{\gamma\_BD} \right)^{0.5} \right) \right) + \frac{1}{2} \mathtt{\pi\_val}, ifelse\left( \mathtt{\zeta\_0m}\left( t \right) \leq 1,  - \mathtt{a\_BD} \mathtt{\zeta\_0m}\left( t \right), 1 - \mathtt{a\_BD} - \mathtt{\zeta\_0m}\left( t \right) + \left( 1 - \mathtt{a\_BD} \right) \log\left( \mathtt{\zeta\_0m}\left( t \right) \right) \right) \right) \right) \\
\mathtt{\psi\_h\_atm}\left( t \right) &amp;= ifelse\left( \mathtt{\zeta\_h}\left( t \right) &lt; \mathtt{\zeta\_h\_threshold}, \mathtt{c\_vu\_h} \left( \frac{1}{\left(  - \mathtt{\zeta\_h}\left( t \right) \right)^{0.33333}} + \frac{-1}{\left(  - \mathtt{\zeta\_h\_threshold} \right)^{0.33333}} \right) + \log\left( \frac{\mathtt{\zeta\_h}\left( t \right)}{\mathtt{\zeta\_h\_threshold}} \right) + 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_h\_threshold} \right)^{0.5} \right) \right), ifelse\left( \mathtt{\zeta\_h}\left( t \right) &lt; 0, 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\zeta\_h}\left( t \right) \mathtt{\gamma\_BD} \right)^{0.5} \right) \right), ifelse\left( \mathtt{\zeta\_h}\left( t \right) \leq 1,  - \mathtt{a\_BD} \mathtt{\zeta\_h}\left( t \right), 1 - \mathtt{a\_BD} - \mathtt{\zeta\_h}\left( t \right) + \left( 1 - \mathtt{a\_BD} \right) \log\left( \mathtt{\zeta\_h}\left( t \right) \right) \right) \right) \right) \\
\mathtt{\psi\_h\_0}\left( t \right) &amp;= ifelse\left( \mathtt{\zeta\_0h}\left( t \right) &lt; \mathtt{\zeta\_h\_threshold}, \mathtt{c\_vu\_h} \left( \frac{1}{\left(  - \mathtt{\zeta\_0h}\left( t \right) \right)^{0.33333}} + \frac{-1}{\left(  - \mathtt{\zeta\_h\_threshold} \right)^{0.33333}} \right) + \log\left( \frac{\mathtt{\zeta\_0h}\left( t \right)}{\mathtt{\zeta\_h\_threshold}} \right) + 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_h\_threshold} \right)^{0.5} \right) \right), ifelse\left( \mathtt{\zeta\_0h}\left( t \right) &lt; 0, 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\zeta\_0h}\left( t \right) \mathtt{\gamma\_BD} \right)^{0.5} \right) \right), ifelse\left( \mathtt{\zeta\_0h}\left( t \right) \leq 1,  - \mathtt{a\_BD} \mathtt{\zeta\_0h}\left( t \right), 1 - \mathtt{a\_BD} - \mathtt{\zeta\_0h}\left( t \right) + \left( 1 - \mathtt{a\_BD} \right) \log\left( \mathtt{\zeta\_0h}\left( t \right) \right) \right) \right) \right) \\
\mathtt{\psi\_w\_atm}\left( t \right) &amp;= ifelse\left( \mathtt{\zeta\_w}\left( t \right) &lt; \mathtt{\zeta\_h\_threshold}, \mathtt{c\_vu\_h} \left( \frac{1}{\left(  - \mathtt{\zeta\_w}\left( t \right) \right)^{0.33333}} + \frac{-1}{\left(  - \mathtt{\zeta\_h\_threshold} \right)^{0.33333}} \right) + \log\left( \frac{\mathtt{\zeta\_w}\left( t \right)}{\mathtt{\zeta\_h\_threshold}} \right) + 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_h\_threshold} \right)^{0.5} \right) \right), ifelse\left( \mathtt{\zeta\_w}\left( t \right) &lt; 0, 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\zeta\_w}\left( t \right) \mathtt{\gamma\_BD} \right)^{0.5} \right) \right), ifelse\left( \mathtt{\zeta\_w}\left( t \right) \leq 1,  - \mathtt{a\_BD} \mathtt{\zeta\_w}\left( t \right), 1 - \mathtt{a\_BD} - \mathtt{\zeta\_w}\left( t \right) + \left( 1 - \mathtt{a\_BD} \right) \log\left( \mathtt{\zeta\_w}\left( t \right) \right) \right) \right) \right) \\
\mathtt{\psi\_w\_0}\left( t \right) &amp;= ifelse\left( \mathtt{\zeta\_0w}\left( t \right) &lt; \mathtt{\zeta\_h\_threshold}, \mathtt{c\_vu\_h} \left( \frac{1}{\left(  - \mathtt{\zeta\_0w}\left( t \right) \right)^{0.33333}} + \frac{-1}{\left(  - \mathtt{\zeta\_h\_threshold} \right)^{0.33333}} \right) + \log\left( \frac{\mathtt{\zeta\_0w}\left( t \right)}{\mathtt{\zeta\_h\_threshold}} \right) + 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\gamma\_BD} \mathtt{\zeta\_h\_threshold} \right)^{0.5} \right) \right), ifelse\left( \mathtt{\zeta\_0w}\left( t \right) &lt; 0, 2 \log\left( \frac{1}{2} \left( 1 + \left( 1 - \mathtt{\zeta\_0w}\left( t \right) \mathtt{\gamma\_BD} \right)^{0.5} \right) \right), ifelse\left( \mathtt{\zeta\_0w}\left( t \right) \leq 1,  - \mathtt{a\_BD} \mathtt{\zeta\_0w}\left( t \right), 1 - \mathtt{a\_BD} - \mathtt{\zeta\_0w}\left( t \right) + \left( 1 - \mathtt{a\_BD} \right) \log\left( \mathtt{\zeta\_0w}\left( t \right) \right) \right) \right) \right) \\
\mathtt{\theta\_v\_atm}\left( t \right) &amp;= \left( 1 + \mathtt{c\_virt} \mathtt{q\_atm} \right) \mathtt{\theta\_atm} \\
\mathtt{U\_c}\left( t \right) &amp;= ifelse\left( \mathtt{\zeta\_in} &lt; 0, \left( max\left( \frac{ - \mathtt{z\_i} \mathtt{\zeta\_in}}{\mathtt{k\_vk} \left( \mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right) \right)}, 0 \right) \right)^{0.33333} max\left( \frac{\mathtt{k\_vk} \mathtt{V\_r}\left( t \right)}{ - \mathtt{\psi\_m\_atm}\left( t \right) + \log\left( \frac{\mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)} \right) + \mathtt{\psi\_m\_0}\left( t \right)}, 0.01 \mathtt{one\_ms} \right), \mathtt{zero\_ms} \right) \mathtt{\beta\_conv} \\
\mathtt{V\_a}\left( t \right) &amp;= max\left( \sqrt{\mathtt{u\_atm}^{2} + \mathtt{v\_atm}^{2} + \left( \mathtt{U\_c}\left( t \right) \right)^{2}}, \mathtt{one\_ms} \right) \\
\mathtt{u\_star}\left( t \right) &amp;= max\left( \frac{\mathtt{k\_vk} \mathtt{V\_a}\left( t \right)}{ - \mathtt{\psi\_m\_atm}\left( t \right) + \log\left( \frac{\mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)} \right) + \mathtt{\psi\_m\_0}\left( t \right)}, 0.01 \mathtt{one\_ms} \right) \\
\mathtt{r\_am}\left( t \right) &amp;= \frac{\mathtt{V\_a}\left( t \right)}{\left( \mathtt{u\_star}\left( t \right) \right)^{2}} \\
\mathtt{r\_ah}\left( t \right) &amp;= \frac{\left( \mathtt{\psi\_h\_0}\left( t \right) - \mathtt{\psi\_h\_atm}\left( t \right) + \log\left( \frac{\mathtt{z\_atm\_h} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)} \right) \right) \left(  - \mathtt{\psi\_m\_atm}\left( t \right) + \log\left( \frac{\mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)} \right) + \mathtt{\psi\_m\_0}\left( t \right) \right)}{\mathtt{k\_vk}^{2} \mathtt{V\_a}\left( t \right)} \\
\mathtt{r\_aw}\left( t \right) &amp;= \frac{\left( \log\left( \frac{\mathtt{z\_atm\_w} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)} \right) - \mathtt{\psi\_w\_atm}\left( t \right) + \mathtt{\psi\_w\_0}\left( t \right) \right) \left(  - \mathtt{\psi\_m\_atm}\left( t \right) + \log\left( \frac{\mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)} \right) + \mathtt{\psi\_m\_0}\left( t \right) \right)}{\mathtt{k\_vk}^{2} \mathtt{V\_a}\left( t \right)} \\
\mathtt{U\_can}\left( t \right) &amp;= ifelse\left( \mathtt{H\_W} \geq 1, \frac{2 \log\left( max\left( \frac{\mathtt{H\_canyon} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)}, 1 \right) \right) e^{ - 0.5 \mathtt{H\_W} \left( 1 + \frac{ - \mathtt{H\_w\_est}}{\mathtt{H\_canyon}} \right)} \mathtt{V\_r}\left( t \right)}{\log\left( max\left( \frac{\mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)}, 1 \right) \right) \mathtt{\pi\_val}}, ifelse\left( \mathtt{H\_W} \geq 0.5, \frac{\left( 1 + 2 \left( -0.5 + \mathtt{H\_W} \right) \left( -1 + \frac{2}{\mathtt{\pi\_val}} \right) \right) \log\left( max\left( \frac{\mathtt{H\_canyon} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)}, 1 \right) \right) e^{ - 0.5 \mathtt{H\_W} \left( 1 + \frac{ - \mathtt{H\_w\_est}}{\mathtt{H\_canyon}} \right)} \mathtt{V\_r}\left( t \right)}{\log\left( max\left( \frac{\mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)}, 1 \right) \right)}, \frac{\log\left( max\left( \frac{\mathtt{H\_canyon} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)}, 1 \right) \right) e^{ - 0.5 \mathtt{H\_W} \left( 1 + \frac{ - \mathtt{H\_w\_est}}{\mathtt{H\_canyon}} \right)} \mathtt{V\_r}\left( t \right)}{\log\left( max\left( \frac{\mathtt{z\_atm\_m} - \mathtt{d\_canopy}\left( t \right)}{\mathtt{z\_0m\_canopy}\left( t \right)}, 1 \right) \right)} \right) \right) \\
\mathtt{U\_ac}\left( t \right) &amp;= \sqrt{\left( \mathtt{U\_can}\left( t \right) \right)^{2} + \left( \mathtt{u\_star}\left( t \right) \right)^{2}} \\
\mathtt{r\_s\_u}\left( t \right) &amp;= \frac{\mathtt{C\_p} \mathtt{\rho\_atm}}{\mathtt{h\_c\_free} + \mathtt{h\_c\_forced} \mathtt{U\_ac}\left( t \right)} \\
\mathtt{c\_a\_h}\left( t \right) &amp;= \frac{1}{\mathtt{r\_ah}\left( t \right)} \\
\mathtt{c\_a\_w}\left( t \right) &amp;= \frac{1}{\mathtt{r\_aw}\left( t \right)} \\
\mathtt{T\_ac}\left( t \right) &amp;= \frac{\frac{\mathtt{T\_g\_roof} \mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{T\_g\_prvrd} \left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{H\_W} \mathtt{T\_g\_shdwall} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{H\_W} \mathtt{T\_g\_sunwall} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{T\_g\_imprvrd} \left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \mathtt{\theta\_atm}}{\frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right)} \\
\mathtt{q\_ac}\left( t \right) &amp;= \frac{\frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd} \mathtt{q\_g\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right) \mathtt{f\_wet\_imprvrd} \mathtt{q\_g\_imprvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof} \mathtt{f\_wet\_roof} \mathtt{q\_g\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{q\_atm} \mathtt{c\_a\_w}\left( t \right)}{\frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right) \mathtt{f\_wet\_imprvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof} \mathtt{f\_wet\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_w}\left( t \right)} \\
\mathtt{H\_roof}\left( t \right) &amp;= \frac{ - \mathtt{C\_p} \left(  - \mathtt{T\_g\_roof} + \mathtt{T\_ac}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right)} \\
\mathtt{H\_prvrd}\left( t \right) &amp;= \frac{ - \mathtt{C\_p} \left(  - \mathtt{T\_g\_prvrd} + \mathtt{T\_ac}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right)} \\
\mathtt{H\_imprvrd}\left( t \right) &amp;= \frac{ - \mathtt{C\_p} \left(  - \mathtt{T\_g\_imprvrd} + \mathtt{T\_ac}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right)} \\
\mathtt{H\_sunwall}\left( t \right) &amp;= \frac{ - \mathtt{C\_p} \left(  - \mathtt{T\_g\_sunwall} + \mathtt{T\_ac}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right)} \\
\mathtt{H\_shdwall}\left( t \right) &amp;= \frac{ - \mathtt{C\_p} \left(  - \mathtt{T\_g\_shdwall} + \mathtt{T\_ac}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right)} \\
\mathtt{H\_total}\left( t \right) &amp;= \mathtt{W\_roof} \mathtt{H\_roof}\left( t \right) + \left( \mathtt{H\_W} \mathtt{H\_shdwall}\left( t \right) + \mathtt{H\_W} \mathtt{H\_sunwall}\left( t \right) + \left( 1 - \mathtt{f\_prvrd} \right) \mathtt{H\_imprvrd}\left( t \right) + \mathtt{f\_prvrd} \mathtt{H\_prvrd}\left( t \right) \right) \left( 1 - \mathtt{W\_roof} \right) \\
\mathtt{E\_roof}\left( t \right) &amp;= \frac{ - \mathtt{f\_wet\_roof} \left(  - \mathtt{q\_g\_roof} + \mathtt{q\_ac}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right)} \\
\mathtt{E\_prvrd}\left( t \right) &amp;= \frac{ - \left(  - \mathtt{q\_g\_prvrd} + \mathtt{q\_ac}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right)} \\
\mathtt{E\_imprvrd}\left( t \right) &amp;= \frac{ - \mathtt{f\_wet\_imprvrd} \left(  - \mathtt{q\_g\_imprvrd} + \mathtt{q\_ac}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right)} \\
\mathtt{E\_total}\left( t \right) &amp;= \mathtt{W\_roof} \mathtt{E\_roof}\left( t \right) + \left( 1 - \mathtt{W\_roof} \right) \left( \left( 1 - \mathtt{f\_prvrd} \right) \mathtt{E\_imprvrd}\left( t \right) + \mathtt{f\_prvrd} \mathtt{E\_prvrd}\left( t \right) \right) \\
\mathtt{\tau\_x}\left( t \right) &amp;= \frac{ - \mathtt{u\_atm} \mathtt{\rho\_atm}}{\mathtt{r\_am}\left( t \right)} \\
\mathtt{\tau\_y}\left( t \right) &amp;= \frac{ - \mathtt{v\_atm} \mathtt{\rho\_atm}}{\mathtt{r\_am}\left( t \right)} \\
\mathtt{dH\_roof\_dT}\left( t \right) &amp;= \frac{\mathtt{C\_p} \left( \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right) \left( \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right)} \\
\mathtt{dH\_prvrd\_dT}\left( t \right) &amp;= \frac{\mathtt{C\_p} \left( \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right) \left( \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right)} \\
\mathtt{dH\_imprvrd\_dT}\left( t \right) &amp;= \frac{\mathtt{C\_p} \left( \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right) \left( \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right)} \\
\mathtt{dH\_sunwall\_dT}\left( t \right) &amp;= \frac{\mathtt{C\_p} \left( \frac{\mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right) \left( \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right)} \\
\mathtt{dH\_shdwall\_dT}\left( t \right) &amp;= \frac{\mathtt{C\_p} \left( \frac{\mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right) \mathtt{\rho\_atm}}{\mathtt{r\_s\_u}\left( t \right) \left( \frac{\left( 1 - \mathtt{W\_roof} \right) \left( 1 - \mathtt{f\_prvrd} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{2 \mathtt{H\_W} \left( 1 - \mathtt{W\_roof} \right)}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\mathtt{W\_roof}}{\mathtt{r\_s\_u}\left( t \right)} + \frac{\left( 1 - \mathtt{W\_roof} \right) \mathtt{f\_prvrd}}{\mathtt{r\_s\_u}\left( t \right)} + \mathtt{c\_a\_h}\left( t \right) \right)}
\end{align}
 \]</p><h2 id="Analysis"><a class="docs-heading-anchor" href="#Analysis">Analysis</a><a id="Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Analysis" title="Permalink"></a></h2><p>The following figures explore the behavior of the heat and momentum flux system across different canyon geometries and atmospheric stability conditions.</p><pre><code class="language-julia hljs">using OrdinaryDiffEqDefault
using Plots

compiled = mtkcompile(sys)

function solve_hmf(compiled, params)
    prob = ODEProblem(compiled, params, (0.0, 1.0))
    solve(prob)
end

function base_hmf_params(compiled; H_W=1.0, ζ_in=0.1)
    Dict(
        compiled.H_W =&gt; H_W,
        compiled.H_canyon =&gt; 10.0,
        compiled.W_roof =&gt; 0.25,
        compiled.f_prvrd =&gt; 0.5,
        compiled.H_w_est =&gt; 5.0,
        compiled.u_atm =&gt; 3.0,
        compiled.v_atm =&gt; 2.0,
        compiled.θ_atm =&gt; 300.0,
        compiled.q_atm =&gt; 0.01,
        compiled.ρ_atm =&gt; 1.2,
        compiled.z_atm_m =&gt; 30.0,
        compiled.z_atm_h =&gt; 30.0,
        compiled.z_atm_w =&gt; 30.0,
        compiled.T_g_roof =&gt; 310.0,
        compiled.T_g_prvrd =&gt; 305.0,
        compiled.T_g_imprvrd =&gt; 308.0,
        compiled.T_g_sunwall =&gt; 312.0,
        compiled.T_g_shdwall =&gt; 303.0,
        compiled.q_g_roof =&gt; 0.015,
        compiled.q_g_prvrd =&gt; 0.012,
        compiled.q_g_imprvrd =&gt; 0.014,
        compiled.f_wet_roof =&gt; 0.0,
        compiled.f_wet_imprvrd =&gt; 0.0,
        compiled.ζ_in =&gt; ζ_in,
    )
end</code></pre><h3 id="Roughness-Parameters-vs-Canyon-H/W-Ratio"><a class="docs-heading-anchor" href="#Roughness-Parameters-vs-Canyon-H/W-Ratio">Roughness Parameters vs Canyon H/W Ratio</a><a id="Roughness-Parameters-vs-Canyon-H/W-Ratio-1"></a><a class="docs-heading-anchor-permalink" href="#Roughness-Parameters-vs-Canyon-H/W-Ratio" title="Permalink"></a></h3><p>Displacement height <span>$d$</span> and roughness length <span>$z_{0m}$</span> as functions of the canyon height-to-width ratio, computed using the MacDonald et al. (1998) formulation (Eqs. 3.55-3.57). The displacement height approaches the building height for deep canyons, while the roughness length peaks at intermediate H/W and decreases for very deep canyons.</p><pre><code class="language-julia hljs">hw_range = 0.1:0.05:5.0
d_vals = Float64[]
z0m_vals = Float64[]

for hw in hw_range
    p = base_hmf_params(compiled; H_W=hw)
    sol = solve_hmf(compiled, p)
    push!(d_vals, sol[compiled.d_canopy][end])
    push!(z0m_vals, sol[compiled.z_0m_canopy][end])
end

p1 = plot(hw_range, d_vals, label=&quot;d (displacement height)&quot;,
    xlabel=&quot;Canyon H/W Ratio&quot;, ylabel=&quot;Height (m)&quot;,
    title=&quot;Roughness Parameters vs H/W (Eqs. 3.55-3.57)&quot;,
    linewidth=2, legend=:topleft)
plot!(p1, hw_range, z0m_vals, label=&quot;z₀ₘ (roughness length)&quot;, linewidth=2)
hline!(p1, [10.0], label=&quot;H_canyon = 10 m&quot;, linestyle=:dash, color=:gray)
p1</code></pre><img src="511c2cad.svg" alt="Example block output"/><h3 id="Stability-Corrections-and-Friction-Velocity"><a class="docs-heading-anchor" href="#Stability-Corrections-and-Friction-Velocity">Stability Corrections and Friction Velocity</a><a id="Stability-Corrections-and-Friction-Velocity-1"></a><a class="docs-heading-anchor-permalink" href="#Stability-Corrections-and-Friction-Velocity" title="Permalink"></a></h3><p>The stability correction functions <span>$\psi_m$</span> and <span>$\psi_h$</span> modify the log-law wind and temperature profiles. Positive <span>$\psi$</span> (unstable conditions) enhances turbulent transfer; negative <span>$\psi$</span> (stable conditions) suppresses it. The friction velocity responds accordingly, being higher in unstable conditions when turbulent mixing is enhanced.</p><pre><code class="language-julia hljs">ζ_range = -3.0:0.05:3.0
ψ_m_vals = Float64[]
ψ_h_vals = Float64[]
ustar_vals = Float64[]

for ζ in ζ_range
    if abs(ζ) &lt; 0.001
        ζ = sign(ζ) == -1 ? -0.001 : 0.001
    end
    p = base_hmf_params(compiled; ζ_in=ζ)
    sol = solve_hmf(compiled, p)
    push!(ψ_m_vals, sol[compiled.ψ_m_atm][end])
    push!(ψ_h_vals, sol[compiled.ψ_h_atm][end])
    push!(ustar_vals, sol[compiled.u_star][end])
end

p1 = plot(ζ_range, ψ_m_vals, label=&quot;ψ_m&quot;, linewidth=2,
    xlabel=&quot;ζ = (z-d)/L&quot;, ylabel=&quot;ψ&quot;,
    title=&quot;Stability Corrections (Eqs. 3.31-3.46)&quot;,
    legend=:topright)
plot!(p1, ζ_range, ψ_h_vals, label=&quot;ψ_h&quot;, linewidth=2)
vline!(p1, [0.0], linestyle=:dash, color=:gray, label=&quot;Neutral&quot;)
vline!(p1, [-1.574], linestyle=:dot, color=:red, label=&quot;ζ_m transition&quot;)
vline!(p1, [-0.465], linestyle=:dot, color=:blue, label=&quot;ζ_h transition&quot;)

p2 = plot(ζ_range, ustar_vals, label=&quot;u*&quot;, linewidth=2, color=:green,
    xlabel=&quot;ζ = (z-d)/L&quot;, ylabel=&quot;u* (m/s)&quot;,
    title=&quot;Friction Velocity vs Stability&quot;,
    legend=:topright)
vline!(p2, [0.0], linestyle=:dash, color=:gray, label=&quot;Neutral&quot;)

p = plot(p1, p2, layout=(2, 1), size=(700, 700))
p</code></pre><img src="b4f7b939.svg" alt="Example block output"/><h3 id="Canyon-Wind-Speed-and-Flow-Regimes"><a class="docs-heading-anchor" href="#Canyon-Wind-Speed-and-Flow-Regimes">Canyon Wind Speed and Flow Regimes</a><a id="Canyon-Wind-Speed-and-Flow-Regimes-1"></a><a class="docs-heading-anchor-permalink" href="#Canyon-Wind-Speed-and-Flow-Regimes" title="Permalink"></a></h3><p>The canyon wind speed exhibits three flow regimes depending on the canyon height-to-width ratio: isolated roughness flow for <span>$H/W &lt; 0.5$</span>, wake interference for <span>$0.5 \leq H/W &lt; 1$</span>, and skimming flow for <span>$H/W \geq 1$</span> (Eqs. 3.60-3.62). Deeper canyons trap wind less effectively, reducing the canyon wind speed.</p><pre><code class="language-julia hljs">hw_range_wind = 0.1:0.05:5.0
Ucan_vals = Float64[]
Uac_vals = Float64[]
Vr_vals = Float64[]

for hw in hw_range_wind
    p = base_hmf_params(compiled; H_W=hw)
    sol = solve_hmf(compiled, p)
    push!(Ucan_vals, sol[compiled.U_can][end])
    push!(Uac_vals, sol[compiled.U_ac][end])
    push!(Vr_vals, sol[compiled.V_r][end])
end

p = plot(hw_range_wind, Ucan_vals, label=&quot;U_can (horizontal)&quot;, linewidth=2,
    xlabel=&quot;Canyon H/W Ratio&quot;, ylabel=&quot;Wind Speed (m/s)&quot;,
    title=&quot;Canyon Wind Speed vs H/W (Eqs. 3.59-3.62)&quot;,
    legend=:topright)
plot!(p, hw_range_wind, Uac_vals, label=&quot;U_ac (total canyon)&quot;, linewidth=2)
hline!(p, [sqrt(3.0^2 + 2.0^2)], label=&quot;V_r (reference wind)&quot;, linestyle=:dash, color=:gray)
vline!(p, [0.5], linestyle=:dot, color=:red, label=&quot;Isolated/Wake boundary&quot;)
vline!(p, [1.0], linestyle=:dot, color=:blue, label=&quot;Wake/Skimming boundary&quot;)
p</code></pre><img src="ec467eff.svg" alt="Example block output"/><h3 id="Sensible-Heat-Fluxes-vs-Canyon-H/W"><a class="docs-heading-anchor" href="#Sensible-Heat-Fluxes-vs-Canyon-H/W">Sensible Heat Fluxes vs Canyon H/W</a><a id="Sensible-Heat-Fluxes-vs-Canyon-H/W-1"></a><a class="docs-heading-anchor-permalink" href="#Sensible-Heat-Fluxes-vs-Canyon-H/W" title="Permalink"></a></h3><p>Sensible heat fluxes from each urban surface as a function of canyon height-to-width ratio (Eqs. 3.69-3.74). Positive values indicate upward heat flux (surface warming the atmosphere). The UCL temperature is a weighted average of all surface temperatures and the atmospheric temperature.</p><pre><code class="language-julia hljs">hw_range_H = 0.1:0.1:5.0
H_roof_vals = Float64[]
H_prvrd_vals = Float64[]
H_imprvrd_vals = Float64[]
H_sunwall_vals = Float64[]
H_shdwall_vals = Float64[]
H_total_vals = Float64[]
T_ac_vals = Float64[]

for hw in hw_range_H
    p = base_hmf_params(compiled; H_W=hw)
    sol = solve_hmf(compiled, p)
    push!(H_roof_vals, sol[compiled.H_roof][end])
    push!(H_prvrd_vals, sol[compiled.H_prvrd][end])
    push!(H_imprvrd_vals, sol[compiled.H_imprvrd][end])
    push!(H_sunwall_vals, sol[compiled.H_sunwall][end])
    push!(H_shdwall_vals, sol[compiled.H_shdwall][end])
    push!(H_total_vals, sol[compiled.H_total][end])
    push!(T_ac_vals, sol[compiled.T_ac][end])
end

p1 = plot(hw_range_H, H_roof_vals, label=&quot;H_roof&quot;, linewidth=2,
    xlabel=&quot;Canyon H/W Ratio&quot;, ylabel=&quot;Sensible Heat Flux (W m⁻²)&quot;,
    title=&quot;Surface Sensible Heat Fluxes (Eqs. 3.69-3.74)&quot;,
    legend=:right)
plot!(p1, hw_range_H, H_prvrd_vals, label=&quot;H_prvrd&quot;, linewidth=2)
plot!(p1, hw_range_H, H_imprvrd_vals, label=&quot;H_imprvrd&quot;, linewidth=2)
plot!(p1, hw_range_H, H_sunwall_vals, label=&quot;H_sunwall&quot;, linewidth=2)
plot!(p1, hw_range_H, H_shdwall_vals, label=&quot;H_shdwall&quot;, linewidth=2)
plot!(p1, hw_range_H, H_total_vals, label=&quot;H_total&quot;, linewidth=2, linestyle=:dash, color=:black)

p2 = plot(hw_range_H, T_ac_vals, label=&quot;T_ac&quot;, linewidth=2, color=:red,
    xlabel=&quot;Canyon H/W Ratio&quot;, ylabel=&quot;Temperature (K)&quot;,
    title=&quot;UCL Air Temperature (Eq. 3.75)&quot;,
    legend=:topright)
hline!(p2, [300.0], label=&quot;θ_atm&quot;, linestyle=:dash, color=:gray)

p = plot(p1, p2, layout=(2, 1), size=(700, 700))
p</code></pre><img src="7699445d.svg" alt="Example block output"/><p>The UCL temperature shifts towards the surface temperatures as the canyon deepens and surface-to-air conductances dominate over the atmospheric conductance. Individual surface heat fluxes adjust as the UCL temperature changes with H/W.</p><h3 id="Aerodynamic-and-Surface-Resistances-vs-Stability"><a class="docs-heading-anchor" href="#Aerodynamic-and-Surface-Resistances-vs-Stability">Aerodynamic and Surface Resistances vs Stability</a><a id="Aerodynamic-and-Surface-Resistances-vs-Stability-1"></a><a class="docs-heading-anchor-permalink" href="#Aerodynamic-and-Surface-Resistances-vs-Stability" title="Permalink"></a></h3><p>Aerodynamic resistance decreases under unstable conditions (enhanced turbulent mixing) and increases under stable conditions (suppressed mixing). The surface resistance depends on the canyon wind speed through forced convection (Eq. 3.68).</p><pre><code class="language-julia hljs">ζ_range_r = -2.0:0.1:2.0
r_am_vals = Float64[]
r_ah_vals = Float64[]
r_s_vals = Float64[]

for ζ in ζ_range_r
    if abs(ζ) &lt; 0.001
        ζ = sign(ζ) == -1 ? -0.001 : 0.001
    end
    p = base_hmf_params(compiled; ζ_in=ζ)
    sol = solve_hmf(compiled, p)
    push!(r_am_vals, sol[compiled.r_am][end])
    push!(r_ah_vals, sol[compiled.r_ah][end])
    push!(r_s_vals, sol[compiled.r_s_u][end])
end

p = plot(ζ_range_r, r_am_vals, label=&quot;r_am (momentum)&quot;, linewidth=2,
    xlabel=&quot;ζ = (z-d)/L&quot;, ylabel=&quot;Resistance (s/m)&quot;,
    title=&quot;Resistances vs Stability (Eqs. 3.65-3.68)&quot;,
    legend=:topleft, yscale=:log10)
plot!(p, ζ_range_r, r_ah_vals, label=&quot;r_ah (heat)&quot;, linewidth=2)
plot!(p, ζ_range_r, r_s_vals, label=&quot;r_s (surface)&quot;, linewidth=2)
vline!(p, [0.0], linestyle=:dash, color=:gray, label=&quot;Neutral&quot;)
p</code></pre><img src="06916ba9.svg" alt="Example block output"/><p>The aerodynamic resistances <span>$r_{am}$</span> and <span>$r_{ah}$</span> vary strongly with stability, while the surface resistance <span>$r_s$</span> shows a weaker dependence because it is controlled primarily by the canyon wind speed rather than directly by the stability corrections.</p><h3 id="Convective-Velocity-vs-Stability"><a class="docs-heading-anchor" href="#Convective-Velocity-vs-Stability">Convective Velocity vs Stability</a><a id="Convective-Velocity-vs-Stability-1"></a><a class="docs-heading-anchor-permalink" href="#Convective-Velocity-vs-Stability" title="Permalink"></a></h3><p>The convective velocity <span>$U_c$</span> (Eqs. 3.29-3.30) augments the effective wind speed <span>$V_a$</span> under unstable conditions. <span>$U_c = \beta w_*$</span> where <span>$w_*$</span> is the convective velocity scale computed from the friction velocity and the Monin-Obukhov length. Under stable conditions <span>$U_c = 0$</span> and <span>$V_a$</span> reduces to the horizontal wind speed.</p><pre><code class="language-julia hljs">ζ_range_uc = -3.0:0.05:1.0
Uc_vals = Float64[]
Va_vals = Float64[]
Vr_vals_stab = Float64[]

for ζ in ζ_range_uc
    if abs(ζ) &lt; 0.001
        ζ = sign(ζ) == -1 ? -0.001 : 0.001
    end
    p = base_hmf_params(compiled; ζ_in=ζ)
    sol = solve_hmf(compiled, p)
    push!(Uc_vals, sol[compiled.U_c][end])
    push!(Va_vals, sol[compiled.V_a][end])
    push!(Vr_vals_stab, sol[compiled.V_r][end])
end

p1 = plot(ζ_range_uc, Uc_vals, label=&quot;U_c (convective velocity)&quot;, linewidth=2,
    xlabel=&quot;ζ = (z-d)/L&quot;, ylabel=&quot;Speed (m/s)&quot;,
    title=&quot;Convective Velocity and Effective Wind Speed (Eqs. 3.25, 3.29-3.30)&quot;,
    legend=:topright)
plot!(p1, ζ_range_uc, Va_vals, label=&quot;V_a (effective wind)&quot;, linewidth=2)
plot!(p1, ζ_range_uc, Vr_vals_stab, label=&quot;V_r (horizontal wind)&quot;, linewidth=2, linestyle=:dash)
vline!(p1, [0.0], linestyle=:dash, color=:gray, label=&quot;Neutral&quot;)
p1</code></pre><img src="c3405177.svg" alt="Example block output"/><p>Under strongly unstable conditions, the convective velocity can exceed the mean horizontal wind, significantly increasing the effective wind speed and turbulent exchange.</p><h3 id="Partial-Derivatives-of-Sensible-Heat-Flux"><a class="docs-heading-anchor" href="#Partial-Derivatives-of-Sensible-Heat-Flux">Partial Derivatives of Sensible Heat Flux</a><a id="Partial-Derivatives-of-Sensible-Heat-Flux-1"></a><a class="docs-heading-anchor-permalink" href="#Partial-Derivatives-of-Sensible-Heat-Flux" title="Permalink"></a></h3><p>The partial derivatives <span>$\partial H / \partial T_g$</span> (Eqs. 3.95-3.99) quantify the sensitivity of each surface&#39;s sensible heat flux to changes in its ground temperature. These are needed for the implicit coupling with the soil temperature equation (Chapter 4). Larger values indicate stronger thermal coupling between the surface and the atmosphere.</p><pre><code class="language-julia hljs">hw_range_dH = 0.1:0.1:5.0
dH_roof_vals = Float64[]
dH_prvrd_vals = Float64[]
dH_imprvrd_vals = Float64[]
dH_sunwall_vals = Float64[]
dH_shdwall_vals = Float64[]

for hw in hw_range_dH
    p = base_hmf_params(compiled; H_W=hw)
    sol = solve_hmf(compiled, p)
    push!(dH_roof_vals, sol[compiled.dH_roof_dT][end])
    push!(dH_prvrd_vals, sol[compiled.dH_prvrd_dT][end])
    push!(dH_imprvrd_vals, sol[compiled.dH_imprvrd_dT][end])
    push!(dH_sunwall_vals, sol[compiled.dH_sunwall_dT][end])
    push!(dH_shdwall_vals, sol[compiled.dH_shdwall_dT][end])
end

p = plot(hw_range_dH, dH_roof_vals, label=&quot;∂H_roof/∂T&quot;, linewidth=2,
    xlabel=&quot;Canyon H/W Ratio&quot;, ylabel=&quot;∂H/∂T (W m⁻² K⁻¹)&quot;,
    title=&quot;Sensible Heat Flux Derivatives (Eqs. 3.95-3.99)&quot;,
    legend=:right)
plot!(p, hw_range_dH, dH_prvrd_vals, label=&quot;∂H_prvrd/∂T&quot;, linewidth=2)
plot!(p, hw_range_dH, dH_imprvrd_vals, label=&quot;∂H_imprvrd/∂T&quot;, linewidth=2)
plot!(p, hw_range_dH, dH_sunwall_vals, label=&quot;∂H_sunwall/∂T&quot;, linewidth=2)
plot!(p, hw_range_dH, dH_shdwall_vals, label=&quot;∂H_shdwall/∂T&quot;, linewidth=2)
p</code></pre><img src="de7db894.svg" alt="Example block output"/><p>The partial derivatives reflect the thermal coupling strength of each surface. Surfaces with larger area fractions (e.g., roof) have stronger coupling, while the wall derivatives increase with H/W as wall area grows relative to the canyon floor.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../albedos_radiative_fluxes/">« Albedos and Radiative Fluxes</a><a class="docs-footer-nextpage" href="../roof_wall_road_snow_temperatures/">Roof, Wall, Road, Snow Temperatures »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Thursday 12 February 2026 15:01">Thursday 12 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
